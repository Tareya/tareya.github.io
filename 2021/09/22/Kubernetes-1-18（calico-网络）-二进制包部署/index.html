

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.png">
  <link rel="icon" href="/img/icon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Kubernetes 1.18ï¼ˆcalico ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½²">
  <meta name="author" content="Tareya">
  <meta name="keywords" content="">
  
  <title>Kubernetes 1.18ï¼ˆcalico ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½² - ä¹±åºæ—¶ç©º</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"tareya.github.io","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ä¹±åºæ—¶ç©º</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/background/lomo5.jpeg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Kubernetes 1.18ï¼ˆcalico ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½²">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-22 15:35" pubdate>
        2021å¹´9æœˆ22æ—¥ ä¸‹åˆ
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      21.1k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      340
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Kubernetes 1.18ï¼ˆcalico ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½²</h1>
            
            <div class="markdown-body">
              <h1 id="Kubernetes-1-18ï¼ˆcalico-ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½²"><a href="#Kubernetes-1-18ï¼ˆcalico-ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½²" class="headerlink" title="Kubernetes 1.18ï¼ˆcalico ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½²"></a>Kubernetes 1.18ï¼ˆcalico ç½‘ç»œï¼‰äºŒè¿›åˆ¶åŒ…éƒ¨ç½²</h1><span id="more"></span>



<h2 id="ä¸€ã€åŸºç¡€ä¿¡æ¯"><a href="#ä¸€ã€åŸºç¡€ä¿¡æ¯" class="headerlink" title="ä¸€ã€åŸºç¡€ä¿¡æ¯"></a>ä¸€ã€åŸºç¡€ä¿¡æ¯</h2><h3 id="1ã€é›†ç¾¤è§„åˆ’"><a href="#1ã€é›†ç¾¤è§„åˆ’" class="headerlink" title="1ã€é›†ç¾¤è§„åˆ’"></a>1ã€é›†ç¾¤è§„åˆ’</h3><table>
<thead>
<tr>
<th>IP åœ°å€</th>
<th>ä¸»æœºå</th>
<th>è§’è‰²</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.3.231</td>
<td>k8s-master01</td>
<td>masterèŠ‚ç‚¹1ã€etcd èŠ‚ç‚¹1ã€nodeèŠ‚ç‚¹2</td>
</tr>
<tr>
<td>192.168.3.232</td>
<td>k8s-master02</td>
<td>masterèŠ‚ç‚¹2ã€etcd èŠ‚ç‚¹2ã€nodeèŠ‚ç‚¹3</td>
</tr>
<tr>
<td>192.168.3.233</td>
<td>k8s-master03</td>
<td>masterèŠ‚ç‚¹3ã€etcd èŠ‚ç‚¹3ã€nodeèŠ‚ç‚¹4</td>
</tr>
<tr>
<td>192.168.3.234</td>
<td>k8s-node01</td>
<td>node èŠ‚ç‚¹1</td>
</tr>
<tr>
<td>192.168.3.235</td>
<td>k8s-lb01</td>
<td>LoadBalance 1ï¼ˆVIP 192.168.3.230ï¼‰</td>
</tr>
<tr>
<td>192.168.3.236</td>
<td>k8s-lb02</td>
<td>LoadBalance 2</td>
</tr>
</tbody></table>
<h3 id="2ã€ç‰ˆæœ¬ä¿¡æ¯"><a href="#2ã€ç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="2ã€ç‰ˆæœ¬ä¿¡æ¯"></a>2ã€ç‰ˆæœ¬ä¿¡æ¯</h3><table>
<thead>
<tr>
<th>ç»„ä»¶åç§°</th>
<th>ç‰ˆæœ¬ä¿¡æ¯</th>
</tr>
</thead>
<tbody><tr>
<td>OS</td>
<td>CentOS 7.9</td>
</tr>
<tr>
<td>Docker</td>
<td>20.10.8</td>
</tr>
<tr>
<td>Kubernetesã€kubectl</td>
<td>1.18.18</td>
</tr>
<tr>
<td>etcd</td>
<td>3.4.14</td>
</tr>
<tr>
<td>cni</td>
<td>0.6.0</td>
</tr>
<tr>
<td>Calico</td>
<td>3.19.2</td>
</tr>
</tbody></table>
<h3 id="3ã€è·¯å¾„æ ‡å‡†"><a href="#3ã€è·¯å¾„æ ‡å‡†" class="headerlink" title="3ã€è·¯å¾„æ ‡å‡†"></a>3ã€è·¯å¾„æ ‡å‡†</h3><h4 id="1ï¼‰Kubernetes-master-èŠ‚ç‚¹"><a href="#1ï¼‰Kubernetes-master-èŠ‚ç‚¹" class="headerlink" title="1ï¼‰Kubernetes master èŠ‚ç‚¹"></a>1ï¼‰Kubernetes master èŠ‚ç‚¹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">/data/applications/<br>â”œâ”€â”€ etcd<br>â”‚Â Â  â”œâ”€â”€ bin<br>â”‚Â Â  â”œâ”€â”€ cfg<br>â”‚Â Â  â”œâ”€â”€ data<br>â”‚Â Â  â”œâ”€â”€ logs<br>â”‚Â Â  â”œâ”€â”€ ssl<br>â”‚Â Â  â””â”€â”€ wal<br>â””â”€â”€ kubernetes<br>    â”œâ”€â”€ bin<br>    â”œâ”€â”€ cfg<br>    â”œâ”€â”€ logs<br>    â””â”€â”€ ssl<br></code></pre></td></tr></table></figure>



<h4 id="2ï¼‰-Kubernetes-node-èŠ‚ç‚¹"><a href="#2ï¼‰-Kubernetes-node-èŠ‚ç‚¹" class="headerlink" title="2ï¼‰ Kubernetes node èŠ‚ç‚¹"></a>2ï¼‰ Kubernetes node èŠ‚ç‚¹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">/data/applications/<br>â””â”€â”€ kubernetes<br>    â”œâ”€â”€ bin<br>    â”œâ”€â”€ cfg<br>    â”œâ”€â”€ logs<br>    â””â”€â”€ ssl<br></code></pre></td></tr></table></figure>



<h2 id="äºŒã€éƒ¨ç½²å®æ–½"><a href="#äºŒã€éƒ¨ç½²å®æ–½" class="headerlink" title="äºŒã€éƒ¨ç½²å®æ–½"></a>äºŒã€éƒ¨ç½²å®æ–½</h2><h3 id="1ã€ç¯å¢ƒå‡†å¤‡"><a href="#1ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ç¯å¢ƒå‡†å¤‡"></a>1ã€ç¯å¢ƒå‡†å¤‡</h3><h4 id="1ï¼‰ç³»ç»Ÿç¯å¢ƒ"><a href="#1ï¼‰ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="1ï¼‰ç³»ç»Ÿç¯å¢ƒ"></a>1ï¼‰ç³»ç»Ÿç¯å¢ƒ</h4><h5 id="1-å…³é—­é˜²ç«å¢™"><a href="#1-å…³é—­é˜²ç«å¢™" class="headerlink" title="1. å…³é—­é˜²ç«å¢™"></a>1. å…³é—­é˜²ç«å¢™</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl stop firewalld<br>systemctl disable firewalld<br></code></pre></td></tr></table></figure>

<h5 id="2-å…³é—­-selinux"><a href="#2-å…³é—­-selinux" class="headerlink" title="2. å…³é—­ selinux"></a>2. å…³é—­ selinux</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">setenforce 0																				# ä¸´æ—¶å…³é—­<br>sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config	# æ°¸ä¹…å…³é—­<br></code></pre></td></tr></table></figure>

<h5 id="3-å…³é—­-swap"><a href="#3-å…³é—­-swap" class="headerlink" title="3. å…³é—­ swap"></a>3. å…³é—­ swap</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> æ‰€æœ‰ K8S èŠ‚ç‚¹æ‰§è¡Œ</span><br>swapoff -a      													# ä¸´æ—¶å…³é—­<br>sed -i &#x27;/swap/s/UUID/#UUID/g&#x27; /etc/fstab 	# æ°¸ä¹…å…³é—­<br></code></pre></td></tr></table></figure>

<h5 id="4-yum-é•œåƒæºå¤„ç†"><a href="#4-yum-é•œåƒæºå¤„ç†" class="headerlink" title="4. yum é•œåƒæºå¤„ç†"></a>4. yum é•œåƒæºå¤„ç†</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; \<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo <br></code></pre></td></tr></table></figure>

<h5 id="5-å®‰è£…å¿…è¦ä¾èµ–"><a href="#5-å®‰è£…å¿…è¦ä¾èµ–" class="headerlink" title="5. å®‰è£…å¿…è¦ä¾èµ–"></a>5. å®‰è£…å¿…è¦ä¾èµ–</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y conntrack ntpdate ntp jq iptables curl sysstat libseccomp wget lsof telnet<br></code></pre></td></tr></table></figure>

<h5 id="6-æ—¶é—´åŒæ­¥"><a href="#6-æ—¶é—´åŒæ­¥" class="headerlink" title="6. æ—¶é—´åŒæ­¥"></a>6. æ—¶é—´åŒæ­¥</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> æ‰€æœ‰ K8S èŠ‚ç‚¹æ‰§è¡Œ</span><br>ntpdate -u time1.aliyun.com 	# æ—¶é—´åŒæ­¥<br>echo &quot;*/20 * * * * /usr/sbin/ntpdate -u time1.aliyun.com &gt;/dev/null &amp;&quot; &gt;&gt; /var/spool/cron/root  # æ·»åŠ å®šæ—¶ä»»åŠ¡<br></code></pre></td></tr></table></figure>

<h5 id="7-è®¾ç½®ç³»ç»Ÿæ—¶åŒº"><a href="#7-è®¾ç½®ç³»ç»Ÿæ—¶åŒº" class="headerlink" title="7. è®¾ç½®ç³»ç»Ÿæ—¶åŒº"></a>7. è®¾ç½®ç³»ç»Ÿæ—¶åŒº</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> è°ƒæ•´ç³»ç»Ÿ TimeZone</span><br>timedatectl set-timezone Asia/Shanghai<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> å°†å½“å‰çš„ UTC æ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</span><br>timedatectl set-local-rtc 0<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡</span><br>systemctl restart rsyslog<br>systemctl restart crond<br></code></pre></td></tr></table></figure>

<h5 id="8-å†…æ ¸å‚æ•°ä¼˜åŒ–"><a href="#8-å†…æ ¸å‚æ•°ä¼˜åŒ–" class="headerlink" title="8. å†…æ ¸å‚æ•°ä¼˜åŒ–"></a>8. å†…æ ¸å‚æ•°ä¼˜åŒ–</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF<br>net.ipv4.ip_forward=1<br>net.ipv4.tcp_tw_recycle=0  				#ç”±äºtcp_tw_recycleä¸kubernetesçš„NATå†²çªï¼Œå¿…é¡»å…³é—­ï¼å¦åˆ™ä¼šå¯¼è‡´æœåŠ¡ä¸é€šã€‚<br>vm.swappiness=0            				#ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ<br>vm.overcommit_memory=1     				#ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨<br>vm.panic_on_oom=0         			 	#å¼€å¯ OOM<br>fs.inotify.max_user_instances=8192<br>fs.inotify.max_user_watches=1048576<br>fs.file-max=52706963<br>fs.nr_open=52706963<br>net.ipv6.conf.all.disable_ipv6=1  #å…³é—­ä¸ä½¿ç”¨çš„ipv6åè®®æ ˆï¼Œé˜²æ­¢è§¦å‘docker BUG.<br>EOF<br><br>sysctl -p /etc/sysctl.d/kubernetes.conf<br></code></pre></td></tr></table></figure>

<h5 id="9-å…³é—­æ— ç”¨æœåŠ¡"><a href="#9-å…³é—­æ— ç”¨æœåŠ¡" class="headerlink" title="9. å…³é—­æ— ç”¨æœåŠ¡"></a>9. å…³é—­æ— ç”¨æœåŠ¡</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl stop postfix.service <br>systemctl disable postfix.service<br></code></pre></td></tr></table></figure>

<h5 id="10-æ·»åŠ -host-dns-è§£æ"><a href="#10-æ·»åŠ -host-dns-è§£æ" class="headerlink" title="10. æ·»åŠ  host / dns è§£æ"></a>10. æ·»åŠ  host / dns è§£æ</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br>192.168.3.231    k8s-master01    etcd-01<br>192.168.3.232    k8s-master02    etcd-02<br>192.168.3.233    k8s-master03    etcd-03<br>192.168.3.234    k8s-node01<br>192.168.3.235    k8s-lb01<br>192.168.3.236    k8s-lb02<br>EOF<br></code></pre></td></tr></table></figure>



<h4 id="2ï¼‰è¿›è¡ŒèŠ‚ç‚¹é—´å…å¯†é€šä¿¡å¤„ç†"><a href="#2ï¼‰è¿›è¡ŒèŠ‚ç‚¹é—´å…å¯†é€šä¿¡å¤„ç†" class="headerlink" title="2ï¼‰è¿›è¡ŒèŠ‚ç‚¹é—´å…å¯†é€šä¿¡å¤„ç†"></a>2ï¼‰è¿›è¡ŒèŠ‚ç‚¹é—´å…å¯†é€šä¿¡å¤„ç†</h4><h5 id="1-å®‰è£…-sshpass"><a href="#1-å®‰è£…-sshpass" class="headerlink" title="1. å®‰è£… sshpass"></a>1. å®‰è£… sshpass</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y sshpass<br></code></pre></td></tr></table></figure>

<h5 id="2-åˆ›å»ºè‡ªåŠ¨å¤„ç†è„šæœ¬ssh-copy-id-sh-ï¼Œè„šæœ¬å¦‚ä¸‹"><a href="#2-åˆ›å»ºè‡ªåŠ¨å¤„ç†è„šæœ¬ssh-copy-id-sh-ï¼Œè„šæœ¬å¦‚ä¸‹" class="headerlink" title="2. åˆ›å»ºè‡ªåŠ¨å¤„ç†è„šæœ¬ssh-copy-id.sh ï¼Œè„šæœ¬å¦‚ä¸‹:"></a>2. åˆ›å»ºè‡ªåŠ¨å¤„ç†è„šæœ¬<code>ssh-copy-id.sh</code> ï¼Œè„šæœ¬å¦‚ä¸‹:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> ä»¥ä¸‹å˜é‡æ ¹æ®å®é™…æƒ…å†µè‡ªè¡Œä¿®æ”¹</span><br>IPArray=(192.168.3.231 192.168.3.232 192.168.3.233 192.168.3.234 192.168.3.235 192.168.3.236)<br>Port=36022<br>TargetPass=Union@#JuYin2021<br>TargetUser=uniondrug<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ›å»ºå¯†é’¥</span><br>rm ~/.ssh/id_rsa* -f<br>ssh-keygen -t rsa -f ~/.ssh/id_rsa -N &quot;&quot; -q<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘å…¬é’¥</span><br>for IP in $&#123;IPArray[@]&#125;<br>do<br><br>   sshpass -p &quot;$TargetPass&quot; ssh-copy-id -o &quot;StrictHostKeyChecking no&quot;  -i ~/.ssh/id_rsa.pub -p $Port $TargetUser@$IP &amp;&gt;/dev/null<br><br>done<br></code></pre></td></tr></table></figure>

<h5 id="3-è¿è¡Œè„šæœ¬ï¼š"><a href="#3-è¿è¡Œè„šæœ¬ï¼š" class="headerlink" title="3. è¿è¡Œè„šæœ¬ï¼š"></a>3. è¿è¡Œè„šæœ¬ï¼š</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sh -x ssh-copy-id.sh<br></code></pre></td></tr></table></figure>



<h4 id="3ï¼‰å®‰è£…æ‰¹ç®¡ç†å·¥å…·"><a href="#3ï¼‰å®‰è£…æ‰¹ç®¡ç†å·¥å…·" class="headerlink" title="3ï¼‰å®‰è£…æ‰¹ç®¡ç†å·¥å…·"></a>3ï¼‰å®‰è£…æ‰¹ç®¡ç†å·¥å…·</h4><h5 id="1-å®‰è£…-python3"><a href="#1-å®‰è£…-python3" class="headerlink" title="1. å®‰è£… python3"></a>1. å®‰è£… python3</h5><p>åˆ›å»ºè‡ªåŠ¨å¤„ç†è„šæœ¬ <code>install-python3.py</code>ï¼Œè„šæœ¬å¦‚ä¸‹:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#coding=utf-8</span><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> os,sys<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exe_cmd</span>(<span class="hljs-params">cmd</span>):</span><br>    p = subprocess.Popen(cmd, shell=<span class="hljs-literal">True</span>, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        next_line = p.stdout.readline()<br>        return_line = next_line.decode(<span class="hljs-string">&quot;utf-8&quot;</span>, <span class="hljs-string">&quot;ignore&quot;</span>)<br>        <span class="hljs-keyword">if</span> return_line == <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">and</span> p.poll() != <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-built_in">print</span>(return_line)<br>    stdout, stderr = p.communicate()<br>    <span class="hljs-keyword">if</span> p.returncode != <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;python 3.8.5 ä¸€é”®å®‰è£…å¼€å§‹ï¼&quot;</span>)<br>    backinfo = exe_cmd(<span class="hljs-string">&#x27;ping -c 1 -w 1 www.baidu.com&#x27;</span>)<br>    <span class="hljs-keyword">if</span> backinfo == <span class="hljs-literal">False</span>:<br>        <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;ç½‘ç»œæ£€æµ‹å¤±è´¥ç¨‹åºé€€å‡ºï¼Œè¯·é‡æ–°æ£€æµ‹ç½‘ç»œç¯å¢ƒ!&quot;</span>)<br>        sys.exit()<br>    <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;ç½‘ç»œè¿æ¥æ­£å¸¸!&quot;</span>)<br>    yum_jc = exe_cmd(<span class="hljs-string">&#x27;yum list&#x27;</span>)<br>    <span class="hljs-keyword">if</span> yum_jc == <span class="hljs-literal">False</span>:<br>        <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;yum ä¸å¯ç”¨ï¼Œè¯·å…ˆæ‰‹åŠ¨é…ç½®yumå®‰è£…!&quot;</span>)<br>        sys.exit()<br>    <span class="hljs-built_in">print</span> (<span class="hljs-string">&#x27;yumå®‰è£…æ£€æµ‹å¯ç”¨!&#x27;</span>)<br><br>    exe_cmd(<span class="hljs-string">&quot;yum install gcc -y&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;yum install openssl-devel bizp2-devel expat-devel gdbm-devel readline-devel sqlite-devel libffi-devel -y&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;wget http://npm.taobao.org/mirrors/python/3.8.5/Python-3.8.5.tgz&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;tar -zxvf Python-3.8.5.tgz&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;mv Python-3.8.5 /usr/local/&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;rm -rf Python-3.8.5.tgz&quot;</span>)<br>    os.chdir(<span class="hljs-string">&#x27;/usr/local/Python-3.8.5&#x27;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;./configure&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;make&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;make install&quot;</span>)<br>    <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;ç¨‹åºæ‰§è¡Œå®Œæˆï¼è¾“å…¥python3 æŸ¥çœ‹æ•ˆæœã€‚&quot;</span>)<br>    exe_cmd(<span class="hljs-string">&quot;python3 -V&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<h5 id="2-è¿è¡Œè„šæœ¬"><a href="#2-è¿è¡Œè„šæœ¬" class="headerlink" title="2. è¿è¡Œè„šæœ¬:"></a>2. è¿è¡Œè„šæœ¬:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python install-python3.py<br></code></pre></td></tr></table></figure>

<h5 id="3-å®‰è£…-ansible"><a href="#3-å®‰è£…-ansible" class="headerlink" title="3. å®‰è£… ansible"></a>3. å®‰è£… ansible</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple ansible==2.7.1<br></code></pre></td></tr></table></figure>

<h5 id="4-ç®¡ç†-ansible-é…ç½®"><a href="#4-ç®¡ç†-ansible-é…ç½®" class="headerlink" title="4. ç®¡ç† ansible é…ç½®"></a>4. ç®¡ç† ansible é…ç½®</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /etc/ansible/roles &amp;&amp; \<br>cat &gt; /etc/ansible/ansible.cfg &lt;&lt; EOF<br>[defaults]<br>inventory = /etc/ansible/hosts<br>remote_tmp = /tmp/.ansible/<br>local_tmp = ~/.ansible/tmp<br>remote_user = uniondrug<br>sudo_user = root<br>remote_port = 36022<br>host_key_checking = False  <br><br>roles_path = /etc/ansible/roles<br><br>EOF<br></code></pre></td></tr></table></figure>

<h5 id="5-ç®¡ç†-ansible-ä¸»æœºæ¸…å•"><a href="#5-ç®¡ç†-ansible-ä¸»æœºæ¸…å•" class="headerlink" title="5. ç®¡ç† ansible ä¸»æœºæ¸…å•"></a>5. ç®¡ç† ansible ä¸»æœºæ¸…å•</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /etc/ansible/hosts &lt;&lt; EOF<br>[k8s-master01]<br>192.168.3.231 ansible_ssh_port=36022 ansible_ssh_user=uniondrug ansible_become_pass=&#x27;*UiiJC9&amp;#CzV@b0H&#x27;<br><br>[k8s-master02]<br>192.168.3.232 ansible_ssh_port=36022 ansible_ssh_user=uniondrug ansible_become_pass=&#x27;*UiiJC9&amp;#CzV@b0H&#x27;<br><br>[k8s-master03]<br>192.168.3.233 ansible_ssh_port=36022 ansible_ssh_user=uniondrug ansible_become_pass=&#x27;*UiiJC9&amp;#CzV@b0H&#x27;<br><br>[k8s-node01]<br>192.168.3.234 ansible_ssh_port=36022 ansible_ssh_user=uniondrug ansible_become_pass=&#x27;*UiiJC9&amp;#CzV@b0H&#x27;<br><br>[k8s-lb01]<br>192.168.3.235 ansible_ssh_port=36022 ansible_ssh_user=uniondrug ansible_become_pass=&#x27;*UiiJC9&amp;#CzV@b0H&#x27;<br><br>[k8s-lb02]<br>192.168.3.236 ansible_ssh_port=36022 ansible_ssh_user=uniondrug ansible_become_pass=&#x27;*UiiJC9&amp;#CzV@b0H&#x27;<br><br>[k8s-master:children]<br>k8s-master01<br>k8s-master02<br>k8s-master03<br><br>[k8s-node:children]<br>k8s-master01<br>k8s-master02<br>k8s-master03<br>k8s-node01<br><br>[k8s-nginx:children]<br>k8s-lb01<br>k8s-lb02<br>EOF<br></code></pre></td></tr></table></figure>



<h4 id="4ï¼‰è®¾ç½®-rsyslogd-å’Œ-systemd-journald-æ—¥å¿—æŒä¹…åŒ–"><a href="#4ï¼‰è®¾ç½®-rsyslogd-å’Œ-systemd-journald-æ—¥å¿—æŒä¹…åŒ–" class="headerlink" title="4ï¼‰è®¾ç½® rsyslogd å’Œ systemd journald æ—¥å¿—æŒä¹…åŒ–"></a>4ï¼‰è®¾ç½® rsyslogd å’Œ systemd journald æ—¥å¿—æŒä¹…åŒ–</h4><blockquote>
<p>ğŸŒˆ systemd çš„ journald æ˜¯ CentOS 7 ç¼ºçœæ—¥å¿—è®°å½•å·¥å…·ï¼Œå®ƒè®°å½•äº†æ‰€æœ‰ç³»ç»Ÿã€å†…æ ¸ã€Service Unit çš„æ—¥å¿—ï¼Œç›¸è¾ƒäº systemd æœ¬èº«ï¼Œjournald çš„ä¼˜åŠ¿åœ¨äº:</p>
<ul>
<li>å¯ä»¥è®°å½•åˆ°å†…å­˜æˆ–æ–‡ä»¶ç³»ç»Ÿï¼›ï¼ˆé»˜è®¤è®°å½•åˆ°å†…å­˜ï¼Œå¯¹åº”çš„ä½ç½®ä¸º /run/log/journalï¼‰</li>
<li>å¯ä»¥é™åˆ¶å ç”¨çš„ç£ç›˜ç©ºé—´ã€ä¿è¯ç£ç›˜å‰©ä½™ç©ºé—´</li>
<li>å¯ä»¥é™åˆ¶æ—¥å¿—çš„å¤§å°ã€ä¿å­˜çš„æ—¶é—´</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>journald</code> é»˜è®¤ä¼šå°†æ—¥å¿—è½¬å‘ç»™ <code>rsyslog</code>ï¼Œè¿™ä¼šå¯¼è‡´æ—¥å¿—å†™äº†å¤šä»½ï¼Œ``/var/log/messages<code> </code>ä¸­åŒ…å«äº†å¤ªå¤šæ— å…³æ—¥å¿—ï¼Œä¸æ–¹ä¾¿åç»­æŸ¥çœ‹ï¼ŒåŒæ—¶ä¹Ÿå½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œæå‰åšä¼˜åŒ–å¤„ç†ã€‚</p>
</blockquote>
<h5 id="1-æ‰¹é‡åˆ›å»ºæ—¥å¿—ç›®å½•"><a href="#1-æ‰¹é‡åˆ›å»ºæ—¥å¿—ç›®å½•" class="headerlink" title="1. æ‰¹é‡åˆ›å»ºæ—¥å¿—ç›®å½•"></a>1. æ‰¹é‡åˆ›å»ºæ—¥å¿—ç›®å½•</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ›å»ºæ—¥å¿—æŒä¹…åŒ–ç›®å½•</span><br>ansible all -S -R root -m file -a &quot;path=/var/log/journal state=directory owner=root group=root mode=0755&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ›å»º journald å­é…ç½®æ–‡ä»¶ç›®å½•</span><br>ansible all -S -R root -m file -a &quot;path=/etc/systemd/journald.conf.d state=directory owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>

<h5 id="2-åˆ›å»º-journald-æŒä¹…åŒ–é…ç½®"><a href="#2-åˆ›å»º-journald-æŒä¹…åŒ–é…ç½®" class="headerlink" title="2. åˆ›å»º journald æŒä¹…åŒ–é…ç½®"></a>2. åˆ›å»º journald æŒä¹…åŒ–é…ç½®</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; 99-prophet.conf &lt;&lt;EOF<br>[Journal]<br><span class="hljs-meta">#</span><span class="bash"> æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜</span><br>Storage=persistent<br>     <br><span class="hljs-meta">#</span><span class="bash"> å‹ç¼©å†å²æ—¥å¿—</span><br>Compress=yes<br>     <br>SyncIntervalSec=5m<br>RateLimitInterval=30s<br>RateLimitBurst=1000<br>     <br><span class="hljs-meta">#</span><span class="bash"> æœ€å¤§å ç”¨ç©ºé—´ 10G</span><br>SystemMaxUse=10G<br>     <br><span class="hljs-meta">#</span><span class="bash"> å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 200M</span><br>SystemMaxFileSize=200M<br>     <br><span class="hljs-meta">#</span><span class="bash"> æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨</span><br>MaxRetentionSec=2week<br>     <br><span class="hljs-meta">#</span><span class="bash"> ä¸å°†æ—¥å¿—è½¬å‘åˆ° syslog</span><br>ForwardToSyslog=no<br>EOF<br></code></pre></td></tr></table></figure>

<h5 id="3-åˆ†å‘é…ç½®æ–‡ä»¶"><a href="#3-åˆ†å‘é…ç½®æ–‡ä»¶" class="headerlink" title="3. åˆ†å‘é…ç½®æ–‡ä»¶"></a>3. åˆ†å‘é…ç½®æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -S -R root -m copy -a &quot;src=99-prophet.conf dest=/etc/systemd/journald.conf.d/99-prophet.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>

<h5 id="4-æ‰¹é‡é‡å¯-journald"><a href="#4-æ‰¹é‡é‡å¯-journald" class="headerlink" title="4. æ‰¹é‡é‡å¯ journald"></a>4. æ‰¹é‡é‡å¯ journald</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -S -R root -m shell -a &quot;systemctl restart systemd-journald&quot;<br></code></pre></td></tr></table></figure>



<h4 id="5ï¼‰åˆ›å»º-Kubernetes-ç›¸å…³ç›®å½•"><a href="#5ï¼‰åˆ›å»º-Kubernetes-ç›¸å…³ç›®å½•" class="headerlink" title="5ï¼‰åˆ›å»º Kubernetes ç›¸å…³ç›®å½•"></a>5ï¼‰åˆ›å»º Kubernetes ç›¸å…³ç›®å½•</h4><h5 id="1-æ‰¹é‡åˆ›å»º-etcd-é›†ç¾¤ç›¸å…³ç›®å½•"><a href="#1-æ‰¹é‡åˆ›å»º-etcd-é›†ç¾¤ç›¸å…³ç›®å½•" class="headerlink" title="1. æ‰¹é‡åˆ›å»º etcd é›†ç¾¤ç›¸å…³ç›®å½•"></a>1. æ‰¹é‡åˆ›å»º etcd é›†ç¾¤ç›¸å…³ç›®å½•</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m shell -a &quot;mkdir -p /data/applications/etcd/&#123;bin,cfg,ssl,data,wal,logs&#125;&quot;<br></code></pre></td></tr></table></figure>

<h5 id="2-æ‰¹é‡åˆ›å»º-K8S-é›†ç¾¤ç›¸å…³ç›®å½•"><a href="#2-æ‰¹é‡åˆ›å»º-K8S-é›†ç¾¤ç›¸å…³ç›®å½•" class="headerlink" title="2. æ‰¹é‡åˆ›å»º K8S é›†ç¾¤ç›¸å…³ç›®å½•"></a>2. æ‰¹é‡åˆ›å»º K8S é›†ç¾¤ç›¸å…³ç›®å½•</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m shell -a &quot;mkdir -p /data/applications/kubernetes/&#123;bin,cfg,ssl,logs&#125;&quot;<br></code></pre></td></tr></table></figure>

<h5 id="3-æ‰¹é‡åˆ›å»º-docker-ç›¸å…³ç›®å½•"><a href="#3-æ‰¹é‡åˆ›å»º-docker-ç›¸å…³ç›®å½•" class="headerlink" title="3. æ‰¹é‡åˆ›å»º docker ç›¸å…³ç›®å½•"></a>3. æ‰¹é‡åˆ›å»º docker ç›¸å…³ç›®å½•</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m file -a &quot;path=/data/applications/docker state=directory owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>



<h4 id="6ï¼‰ä¸‹è½½-kubernetes-ç»„ä»¶"><a href="#6ï¼‰ä¸‹è½½-kubernetes-ç»„ä»¶" class="headerlink" title="6ï¼‰ä¸‹è½½ kubernetes ç»„ä»¶"></a>6ï¼‰ä¸‹è½½ kubernetes ç»„ä»¶</h4><h5 id="1-ä¸‹è½½è§£å‹-1-18-18-server-ç»„ä»¶"><a href="#1-ä¸‹è½½è§£å‹-1-18-18-server-ç»„ä»¶" class="headerlink" title="1. ä¸‹è½½è§£å‹ 1.18.18 server ç»„ä»¶"></a>1. ä¸‹è½½è§£å‹ 1.18.18 server ç»„ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~ &amp;&amp; \<br>wget -c https://dl.k8s.io/v1.18.18/kubernetes-server-linux-amd64.tar.gz &amp;&amp; \<br>tar xf kubernetes-server-linux-amd64.tar.gz<br></code></pre></td></tr></table></figure>

<h6 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯:"></a>éªŒè¯:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">~/kubernetes/server/bin/kube-apiserver --version<br>~/kubernetes/server/bin/kube-controller-manager --version<br>~/kubernetes/server/bin/kube-scheduler --version<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›éƒ½å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Kubernetes v1.18.18<br></code></pre></td></tr></table></figure>

<h5 id="2-ä¸‹è½½è§£å‹-1-18-18-node-ç»„ä»¶"><a href="#2-ä¸‹è½½è§£å‹-1-18-18-node-ç»„ä»¶" class="headerlink" title="2. ä¸‹è½½è§£å‹ 1.18.18 node ç»„ä»¶"></a>2. ä¸‹è½½è§£å‹ 1.18.18 node ç»„ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~ &amp;&amp; \<br>wget -c https://dl.k8s.io/v1.18.18/kubernetes-node-linux-amd64.tar.gz &amp;&amp; \<br>tar xf kubernetes-node-linux-amd64.tar.gz<br></code></pre></td></tr></table></figure>

<h6 id="éªŒè¯-1"><a href="#éªŒè¯-1" class="headerlink" title="éªŒè¯:"></a>éªŒè¯:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">~/kubernetes/node/bin/kubelet --version<br>~/kubernetes/node/bin/kube-proxy --version<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›éƒ½å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Kubernetes v1.18.18<br></code></pre></td></tr></table></figure>



<h4 id="7ï¼‰åˆ†å‘-Kubernetes-ç»„ä»¶"><a href="#7ï¼‰åˆ†å‘-Kubernetes-ç»„ä»¶" class="headerlink" title="7ï¼‰åˆ†å‘ Kubernetes ç»„ä»¶"></a>7ï¼‰åˆ†å‘ Kubernetes ç»„ä»¶</h4><h5 id="1-åˆ†å‘-server-ç»„ä»¶è‡³å„-master-èŠ‚ç‚¹"><a href="#1-åˆ†å‘-server-ç»„ä»¶è‡³å„-master-èŠ‚ç‚¹" class="headerlink" title="1. åˆ†å‘ server ç»„ä»¶è‡³å„ master èŠ‚ç‚¹"></a>1. åˆ†å‘ server ç»„ä»¶è‡³å„ master èŠ‚ç‚¹</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ kube-apiserver</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/bin/kube-apiserver dest=/data/applications/kubernetes/bin/kube-apiserver owner=root group=root mode=0755&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ kube-controller-manager</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/bin/kube-controller-manager dest=/data/applications/kubernetes/bin/kube-controller-manager owner=root group=root mode=0755&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ kube-scheduler</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/bin/kube-scheduler dest=/data/applications/kubernetes/bin/kube-scheduler owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>

<h5 id="2-åˆ†å‘-node-ç»„ä»¶è‡³å„-node-èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬-master-èŠ‚ç‚¹ï¼‰"><a href="#2-åˆ†å‘-node-ç»„ä»¶è‡³å„-node-èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬-master-èŠ‚ç‚¹ï¼‰" class="headerlink" title="2. åˆ†å‘ node ç»„ä»¶è‡³å„ node èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ master èŠ‚ç‚¹ï¼‰"></a>2. åˆ†å‘ node ç»„ä»¶è‡³å„ node èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ master èŠ‚ç‚¹ï¼‰</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ kubelet</span><br>ansible k8s-node -S -R root -m copy -a &quot;src=~/kubernetes/node/bin/kubelet dest=/data/applications/kubernetes/bin/kubelet owner=root group=root mode=0755&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ kube-proxy</span><br>ansible k8s-node -S -R root -m copy -a &quot;src=~/kubernetes/node/bin/kube-proxy dest=/data/applications/kubernetes/bin/kube-proxy owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>



<h4 id="8ï¼‰å®‰è£…-docker-ç¯å¢ƒ"><a href="#8ï¼‰å®‰è£…-docker-ç¯å¢ƒ" class="headerlink" title="8ï¼‰å®‰è£… docker ç¯å¢ƒ"></a>8ï¼‰å®‰è£… docker ç¯å¢ƒ</h4><blockquote>
<p>ğŸš© <strong>å…³äºæ˜¯å¦éœ€è¦å‡çº§ç³»ç»Ÿå†…æ ¸çš„æƒ…å†µè¯´æ˜</strong></p>
<p>CentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x çš„å†…æ ¸å­˜åœ¨ä¸å®¹å™¨å…¼å®¹æ€§ä¸Šçš„é—®é¢˜ï¼Œä¼šå¯¼è‡´ Dockerã€Kubernetes è¿è¡Œä¸ç¨³å®šï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>docker 1.13 ç‰ˆæœ¬åé»˜è®¤å¯ç”¨äº† 3.10 å†…æ ¸å®éªŒæ”¯æŒçš„ <code>kernel memory account</code> åŠŸèƒ½ä¸”æ— æ³•å…³é—­ï¼Œå½“èŠ‚ç‚¹å‹åŠ›å¤§ã€é¢‘ç¹å¯åŠ¨å’Œåœæ­¢å®¹å™¨æ—¶ä¼šå¯¼è‡´ <code>cgroup memory leak</code>ï¼›</li>
<li>ç½‘ç»œè®¾å¤‡å¼•ç”¨çš„è®¡æ•°æ³„æ¼ä¼šå¯¼è‡´ç±»ä¼¼æŠ¥é”™: <code>&quot;kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1&quot;</code></li>
</ul>
<p><strong>é’ˆå¯¹è¿™ç§é—®é¢˜æœ‰å¦‚ä¸‹å‡ ç§æ–¹æ¡ˆ:</strong></p>
<p>1.å‡çº§å†…æ ¸ç›´ 4.4.x ä»¥ä¸Šï¼ˆå·²åšå…¼å®¹æ€§å¤„ç†ï¼‰</p>
<p>2.æ‰‹åŠ¨ç¼–è¯‘å†…æ ¸ï¼Œdisable æ‰ <code>CONFIG_MEMCG_KMEM</code> ç‰¹æ€§</p>
<p>3.Docker 18.09.1 ç‰ˆæœ¬èµ·å·²ä¿®å¤äº†è¯¥å…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç›´æ¥é€‰æ‹©å®‰è£…é«˜ç‰ˆæœ¬çš„ Dockerï¼›ä½†ç”±äº kubelet ä¹Ÿä¼šè®¾ç½® kmemï¼ˆå®ƒ vendor äº† runcï¼‰ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç¼–è¯‘ kubelet å¹¶æŒ‡å®š GOFLAGS=<code>&quot;-tags=nokmem&quot;</code></p>
<p>ğŸŒˆ <strong>è§£å†³æ–¹æ¡ˆæ–‡æ¡£</strong></p>
<p>å¯çœ‹ä¹‹å‰çš„åšå®¢ï¼Œ<a href="https://tareya.github.io/2021/09/27/Kubernetes-kmem-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">Kubernetes kmem å†…å­˜æ³„æ¼é—®é¢˜è§£å†³æ–¹æ¡ˆ</a></p>
<p>ğŸŒŸ <strong>æ‰¹é‡æ›¿æ¢ runc</strong></p>
<p><a target="_blank" rel="noopener" href="https://uniondrug-devops.oss-cn-hangzhou.aliyuncs.com/runc">å·²å¤„ç† kmem runc äºŒè¿›åˆ¶åŒ…ä¸‹è½½</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -S -R root -m copy -a &quot;src=runc dest=/usr/bin/runc owner=root group=root mode=0755&quot;<br>ansible all -S -R root -m copy -a &quot;src=runc dest=/usr/bin/docker-runc owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="1-è‡ªåŠ¨å®‰è£…å‡çº§è„šæœ¬"><a href="#1-è‡ªåŠ¨å®‰è£…å‡çº§è„šæœ¬" class="headerlink" title="1. è‡ªåŠ¨å®‰è£…å‡çº§è„šæœ¬"></a>1. è‡ªåŠ¨å®‰è£…å‡çº§è„šæœ¬</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /tmp/install-docker.sh &lt;&lt; END<br><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><br>echo &quot;Docker ä¸€é”®å®‰è£…å¼€å§‹ï¼&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> æ¸…ç†æ®‹ç•™ç‰ˆæœ¬</span><br>yum remove -y docker \<br>	docker-client \<br>	docker-client-latest \<br>	docker-common \<br>	docker-latest \<br>	docker-latest-logrotate \<br>	docker-logrotate \<br>	docker-engine &amp;&amp; \<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®å­˜å‚¨åº“</span><br>yum install -y yum-utils \<br>  device-mapper-persistent-data \<br>  lvm2 wget&amp;&amp; \<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> æ·»åŠ  yum æº</span><br>wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo &amp;&amp; \<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> ä¿®æ”¹å›½å†…é•œåƒæº</span><br>sed -i &#x27;s#download.docker.com#mirrors.tuna.tsinghua.edu.cn/docker-ce#g&#x27; /etc/yum.repos.d/docker-ce.repo &amp;&amp; \<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼ˆä¹Ÿå¯ä»¥æŒ‡å®šç‰ˆæœ¬ï¼Œå¦‚ docker-ce-18.09.5-3.el7ï¼‰</span><br>yum install -y docker-ce &amp;&amp; \<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> æ·»åŠ å¼€æœºè‡ªå¯</span><br>systemctl enable docker <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> ç”Ÿæˆ docker é•œåƒåŠ é€Ÿåœ°å€ä»¥åŠæ—¥å¿—æ¸…ç†çš„é…ç½®æ–‡ä»¶ã€‚</span><br>if [ ! -d &quot;/etc/docker&quot; ]; then<br>mkdir /etc/docker<br>fi<br><br>cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://5a8zducs.mirror.aliyuncs.com&quot;],<br>  &quot;log-driver&quot;:&quot;json-file&quot;,<br>  &quot;log-opts&quot;: &#123;&quot;max-size&quot;:&quot;500m&quot;, &quot;max-file&quot;:&quot;3&quot;&#125;<br>&#125;<br>EOF<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> å¯åŠ¨ docker (å› ä¸ºè¦æ›´æ”¹ docker æ•°æ®ç›®å½•ï¼Œå»ºè®®ä¸ç›´æ¥å¯åŠ¨)</span><br><span class="hljs-meta">#</span><span class="bash"> systemctl start docker</span><br><br>echo &quot;Docker å®‰è£…å·²å®Œæˆ!&quot;<br><br>docker version<br><br>END<br></code></pre></td></tr></table></figure>

<h5 id="2-æ–°å»º-docker-systemd-unit-é…ç½®"><a href="#2-æ–°å»º-docker-systemd-unit-é…ç½®" class="headerlink" title="2. æ–°å»º docker systemd unit é…ç½®"></a>2. æ–°å»º docker systemd unit é…ç½®</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; docker.service &lt;&lt; EOF<br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service containerd.service<br>Wants=network-online.target<br>Requires=docker.socket containerd.service<br><br>[Service]<br>Type=notify<br><span class="hljs-meta">#</span><span class="bash"> the default is not to use systemd <span class="hljs-keyword">for</span> cgroups because the delegate issues still</span><br><span class="hljs-meta">#</span><span class="bash"> exists and systemd currently does not support the cgroup feature <span class="hljs-built_in">set</span> required</span><br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-keyword">for</span> containers run by docker</span><br>ExecStart=/usr/bin/dockerd -H fd:// --graph=/data/applications/docker --containerd=/run/containerd/containerd.sock<br>ExecReload=/bin/kill -s HUP $MAINPID<br>TimeoutSec=0<br>RestartSec=2<br>Restart=always<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Note that StartLimit* options were moved from <span class="hljs-string">&quot;Service&quot;</span> to <span class="hljs-string">&quot;Unit&quot;</span> <span class="hljs-keyword">in</span> systemd 229.</span><br><span class="hljs-meta">#</span><span class="bash"> Both the old, and new location are accepted by systemd 229 and up, so using the old location</span><br><span class="hljs-meta">#</span><span class="bash"> to make them work <span class="hljs-keyword">for</span> either version of systemd.</span><br>StartLimitBurst=3<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Note that StartLimitInterval was renamed to StartLimitIntervalSec <span class="hljs-keyword">in</span> systemd 230.</span><br><span class="hljs-meta">#</span><span class="bash"> Both the old, and new name are accepted by systemd 230 and up, so using the old name to make</span><br><span class="hljs-meta">#</span><span class="bash"> this option work <span class="hljs-keyword">for</span> either version of systemd.</span><br>StartLimitInterval=60s<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-keyword">in</span> the kernel. We recommend using cgroups to <span class="hljs-keyword">do</span> container-local accounting.</span><br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Comment TasksMax <span class="hljs-keyword">if</span> your systemd version does not support it.</span><br><span class="hljs-meta">#</span><span class="bash"> Only systemd 226 and above support this option.</span><br>TasksMax=infinity<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-built_in">set</span> delegate yes so that systemd does not reset the cgroups of docker containers</span><br>Delegate=yes<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-built_in">kill</span> only the docker process, not all processes <span class="hljs-keyword">in</span> the cgroup</span><br>KillMode=process<br>OOMScoreAdjust=-500<br><br>[Install]<br>WantedBy=multi-user.target<br><br>EOF<br></code></pre></td></tr></table></figure>

<h5 id="3-åˆ†å‘-systemd-unit-é…ç½®"><a href="#3-åˆ†å‘-systemd-unit-é…ç½®" class="headerlink" title="3. åˆ†å‘ systemd unit é…ç½®"></a>3. åˆ†å‘ systemd unit é…ç½®</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -S -R root -m copy -a &quot;src=docker.service dest=/usr/lib/systemd/system/docker.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>

<h5 id="4-æ‰¹é‡å¯åŠ¨-docker"><a href="#4-æ‰¹é‡å¯åŠ¨-docker" class="headerlink" title="4. æ‰¹é‡å¯åŠ¨ docker"></a>4. æ‰¹é‡å¯åŠ¨ docker</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible all -S -R root -m shell -a &quot;systemctl restart docker&quot;<br></code></pre></td></tr></table></figure>

<h5 id="5-éªŒè¯"><a href="#5-éªŒè¯" class="headerlink" title="5. éªŒè¯"></a>5. éªŒè¯</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ll /data/applications/docker/<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸æƒ…å†µï¼Œå­˜å‚¨ç›®å½•å·²è½¬ç§»è‡³<code>/data/applications/docker</code></p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20210930134233588.png" srcset="/img/loading.gif" lazyload alt="image-20210930134233588"></p>
<h3 id="2ã€ç”Ÿæˆè¯ä¹¦"><a href="#2ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="2ã€ç”Ÿæˆè¯ä¹¦"></a>2ã€ç”Ÿæˆè¯ä¹¦</h3><h4 id="1ï¼‰å‰æœŸå‡†å¤‡"><a href="#1ï¼‰å‰æœŸå‡†å¤‡" class="headerlink" title="1ï¼‰å‰æœŸå‡†å¤‡"></a>1ï¼‰å‰æœŸå‡†å¤‡</h4><h5 id="1-å®‰è£…-cfssl-å·¥å…·"><a href="#1-å®‰è£…-cfssl-å·¥å…·" class="headerlink" title="1. å®‰è£… cfssl å·¥å…·"></a>1. å®‰è£… cfssl å·¥å…·</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">export CFSSL_URL=&quot;https://pkg.cfssl.org/R1.2&quot;<br>wget &quot;$&#123;CFSSL_URL&#125;/cfssl_linux-amd64&quot; -O /usr/bin/cfssl<br>wget &quot;$&#123;CFSSL_URL&#125;/cfssljson_linux-amd64&quot; -O /usr/bin/cfssljson<br>wget &quot;$&#123;CFSSL_URL&#125;/cfssl-certinfo_linux-amd64&quot; -O /usr/bin/cfssl-certinfo<br>chmod +x /usr/bin/cfssl*<br></code></pre></td></tr></table></figure>

<h5 id="2-åˆ›å»ºè¯ä¹¦ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰"><a href="#2-åˆ›å»ºè¯ä¹¦ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰" class="headerlink" title="2. åˆ›å»ºè¯ä¹¦ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰"></a>2. åˆ›å»ºè¯ä¹¦ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p ~/tls<br></code></pre></td></tr></table></figure>

<h5 id="3-åˆ›å»º-k8s-ç›¸å…³ç»„ä»¶ã€é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰"><a href="#3-åˆ›å»º-k8s-ç›¸å…³ç»„ä»¶ã€é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰" class="headerlink" title="3. åˆ›å»º k8s ç›¸å…³ç»„ä»¶ã€é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰"></a>3. åˆ›å»º k8s ç›¸å…³ç»„ä»¶ã€é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ç›®å½•ï¼ˆç”±æ­¤åˆ†å‘è‡³æ­£å¼ç›®å½•ï¼‰</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p ~/kubernetes/&#123;server,node,client,etcd,network,prometheus,nginx&#125;/&#123;cfg,systemd&#125;<br></code></pre></td></tr></table></figure>



<h4 id="2ï¼‰ç”Ÿæˆ-ca-æ ¹è¯ä¹¦"><a href="#2ï¼‰ç”Ÿæˆ-ca-æ ¹è¯ä¹¦" class="headerlink" title="2ï¼‰ç”Ÿæˆ ca æ ¹è¯ä¹¦"></a>2ï¼‰ç”Ÿæˆ ca æ ¹è¯ä¹¦</h4><blockquote>
<p>ğŸš© <strong>æç¤ºï¼š</strong></p>
<p>ca è¯ä¹¦æ˜¯é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å¯ä»¥å…±äº«çš„ï¼Œæ‰€ä»¥åªéœ€è¦åˆ›å»ºä¸€ä¸ª ca è¯ä¹¦å³å¯ï¼Œåç»­åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦éƒ½ç”±å…¶ç­¾å‘ã€‚</p>
</blockquote>
<h5 id="1-åˆ›å»º-ca-é…ç½®æ–‡ä»¶"><a href="#1-åˆ›å»º-ca-é…ç½®æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º ca é…ç½®æ–‡ä»¶"></a>1. åˆ›å»º ca é…ç½®æ–‡ä»¶</h5><blockquote>
<p>ğŸŒˆ  ca é…ç½®æ–‡ä»¶ç”¨äºé…ç½®æ ¹è¯ä¹¦çš„ä½¿ç”¨åœºæ™¯ï¼ˆprofileï¼‰ å’Œå…·ä½“å‚æ•° (usagesï¼Œè¿‡æœŸæ—¶é—´ã€æœåŠ¡ç«¯è®¤è¯ã€å®¢æˆ·ç«¯è®¤è¯ã€åŠ å¯†ç­‰)ï¼Œåç»­åœ¨ç­¾åå…¶å®ƒè¯ä¹¦æ—¶éœ€è¦æŒ‡å®šç‰¹å®šåœºæ™¯ã€‚</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">cat &gt; ~/tls/ca-config.json &lt;&lt;EOF<br>&#123;<br>  <span class="hljs-attr">&quot;signing&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;default&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;87600h&quot;</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;profiles&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;kubernetes&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;usages&quot;</span>: [<br>            <span class="hljs-string">&quot;signing&quot;</span>,<br>            <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>            <span class="hljs-string">&quot;server auth&quot;</span>,<br>            <span class="hljs-string">&quot;client auth&quot;</span><br>        ],<br>        <span class="hljs-attr">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;87600h&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜"><a href="#é…ç½®å‚æ•°è¯´æ˜" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>signing</td>
<td>è¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶ä»–è¯ä¹¦ï¼Œç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUE</td>
</tr>
<tr>
<td>server auth</td>
<td>è¡¨ç¤º client å¯ä»¥é€šè¿‡è¯¥è¯ä¹¦å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯</td>
</tr>
<tr>
<td>client auth</td>
<td>è¡¨ç¤º server å¯ä»¥é€šè¿‡è¯¥è¯ä¹¦å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯</td>
</tr>
<tr>
<td>expiry</td>
<td>è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º 8760hï¼Œå³1å¹´</td>
</tr>
</tbody></table>
<h5 id="2-åˆ›å»º-ca-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#2-åˆ›å»º-ca-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="2. åˆ›å»º ca è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>2. åˆ›å»º ca è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/tls/ca-csr.json &lt;&lt;EOF<br>&#123;<br>  &quot;CN&quot;: &quot;kubernetes&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;k8s&quot;,<br>      &quot;OU&quot;: &quot;system&quot;<br>    &#125;<br>  ],<br>  &quot;ca&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>  &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-1"><a href="#é…ç½®å‚æ•°è¯´æ˜-1" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>CN</td>
<td>Common Nameï¼Œkube-apiserver ä¼šä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·åï¼ˆUser Nameï¼‰ã€æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™çš„åˆæ³•æ€§</td>
</tr>
<tr>
<td>C</td>
<td>Countryï¼Œå›½å®¶</td>
</tr>
<tr>
<td>L</td>
<td>Localityï¼Œåœ°åŒºï¼ŒåŸå¸‚</td>
</tr>
<tr>
<td>ST</td>
<td>Stateï¼Œæ´²ï¼Œçœ</td>
</tr>
<tr>
<td>O</td>
<td>Organizationï¼Œç»„ç»‡åç§°ï¼Œå…¬å¸åç§°ï¼Œkube-apiserver ä¼šä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºç”¨æˆ·æ‰€å±çš„ç»„ï¼ˆGroupï¼‰</td>
</tr>
<tr>
<td>OU</td>
<td>Organization Unitï¼Œç»„ç»‡å•ä½åç§°ï¼Œå…¬å¸éƒ¨é—¨</td>
</tr>
</tbody></table>
<blockquote>
<p>âš ï¸ <strong>æ³¨æ„:</strong></p>
<p>kube-apiserver ä¼šæå– Group å’Œ User ä½œä¸º K8S RBAC æˆæƒçš„ç”¨æˆ·æ ‡è¯†ï¼Œæ‰€ä»¥ CN å’Œ O çš„å‘½åå’Œé‡è¦ï¼Œå»ºè®®å‘½åè¦è§„èŒƒã€‚</p>
</blockquote>
<h5 id="3-ç”Ÿæˆ-CA-è¯ä¹¦å’Œç§é’¥"><a href="#3-ç”Ÿæˆ-CA-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="3. ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥"></a>3. ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/tls &amp;&amp; \<br>cfssl gencert -initca ca-csr.json | cfssljson -bare ca<br></code></pre></td></tr></table></figure>



<h5 id="4-è¯ä¹¦æ–‡ä»¶è¯´æ˜"><a href="#4-è¯ä¹¦æ–‡ä»¶è¯´æ˜" class="headerlink" title="4. è¯ä¹¦æ–‡ä»¶è¯´æ˜"></a>4. è¯ä¹¦æ–‡ä»¶è¯´æ˜</h5><table>
<thead>
<tr>
<th>è¯ä¹¦è·¯å¾„</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>~/tls/ca.csr</td>
<td>ca è¯ä¹¦çš„ç­¾åè¯·æ±‚æ–‡ä»¶</td>
</tr>
<tr>
<td>~/tls/ca.pem</td>
<td>ca è¯ä¹¦æ–‡ä»¶ï¼Œå³åé¢ K8S ç»„ä»¶ä½¿ç”¨çš„ RootCA</td>
</tr>
<tr>
<td>~/tls/ca-key.pem</td>
<td>ca è¯ä¹¦çš„ç§é’¥æ–‡ä»¶</td>
</tr>
</tbody></table>
<h5 id="5-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶"><a href="#5-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶" class="headerlink" title="5. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶"></a>5. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ ca è¯ä¹¦ï¼ˆk8s æ‰€æœ‰èŠ‚ç‚¹ã€etcd æ‰€æœ‰èŠ‚ç‚¹ï¼‰</span><br>ansible k8s-node -S -R root -m copy -a &quot;src=~/tls/ca.pem dest=/data/applications/kubernetes/ssl/ca.pem owner=root group=root mode=0644&quot; <br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/ca.pem dest=/data/applications/etcd/ssl/ca.pem owner=root group=root mode=0644&quot; <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ ca è¯ä¹¦ç§é’¥ï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œæƒé™è®¾ç½®ä»–äººæ— æƒé™ï¼ˆk8s masterèŠ‚ç‚¹ã€etcd æ‰€æœ‰èŠ‚ç‚¹ï¼‰</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/ca-key.pem  dest=/data/applications/kubernetes/ssl/ca-key.pem owner=root group=root mode=0600&quot; <br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/ca-key.pem  dest=/data/applications/etcd/ssl/ca-key.pem owner=root group=root mode=0600&quot; <br></code></pre></td></tr></table></figure>



<h4 id="3ï¼‰ç”Ÿæˆ-server-è¯ä¹¦"><a href="#3ï¼‰ç”Ÿæˆ-server-è¯ä¹¦" class="headerlink" title="3ï¼‰ç”Ÿæˆ server è¯ä¹¦"></a>3ï¼‰ç”Ÿæˆ server è¯ä¹¦</h4><blockquote>
<p>ğŸš© <strong>æç¤º:</strong></p>
<p>æ­¤å¤„ç”Ÿæˆçš„ server è¯ä¹¦åŒæ—¶å¯æä¾› etcd é›†ç¾¤å’Œ kube-apiserver ä½¿ç”¨ï¼ˆå¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ‹†åˆ†æˆ2å¥—ï¼‰</p>
</blockquote>
<h5 id="1-åˆ›å»º-server-ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#1-åˆ›å»º-server-ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º server ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>1. åˆ›å»º server ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/tls/server-csr.json &lt;&lt;EOF<br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;hosts&quot;: [<br>      &quot;10.0.0.1&quot;,<br>      &quot;127.0.0.1&quot;,<br>      &quot;192.168.3.230&quot;,<br>      &quot;192.168.3.231&quot;,<br>      &quot;192.168.3.232&quot;,<br>      &quot;192.168.3.233&quot;,<br>      &quot;k8s-master01&quot;,<br>      &quot;k8s-master02&quot;,<br>      &quot;k8s-master03&quot;,<br>      &quot;etcd-01&quot;,<br>      &quot;etcd-02&quot;,<br>      &quot;etcd-03&quot;,<br>      &quot;kubernetes&quot;,<br>      &quot;kubernetes.default&quot;,<br>      &quot;kubernetes.default.svc&quot;,<br>      &quot;kubernetes.default.svc.cluster&quot;,<br>      &quot;kubernetes.default.svc.cluster.local&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;BeiJing&quot;,<br>            &quot;ST&quot;: &quot;BeiJing&quot;,<br>            &quot;O&quot;: &quot;k8s&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<blockquote>
<p>âš ï¸ <strong>æ³¨æ„:</strong></p>
<p>å¦‚æœ hosts å­—æ®µçš„å€¼ä¸ä¸ºç©ºå°±éœ€è¦æŒ‡å®šå…·ä½“æˆæƒçš„ IP å’Œ åŸŸååˆ—è¡¨ï¼Œè¿™é‡Œåˆ—å‡ºäº† vipã€apiserver èŠ‚ç‚¹ ipã€kubernetes æœåŠ¡ ip å’ŒåŸŸå</p>
<p>server è¯ä¹¦åç»­ä¼šè¢« etcd é›†ç¾¤å’Œ K8S master èŠ‚ç‚¹ä½¿ç”¨ï¼Œæ‰€ä»¥è¦å°† etcdã€master èŠ‚ç‚¹å’Œ kube-apiserver çš„vipéƒ½å¡«ä¸Šï¼ŒåŒæ—¶è¿˜æœ‰service ç½‘ç»œçš„é¦–IPä¹Ÿéœ€è¦å¡«ä¸Šã€‚(ä¸€èˆ¬æ˜¯ kube-apiserver æŒ‡å®š <code>--service-cluster-ip-range</code> çš„ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.0.0.1)</p>
<hr>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨åŸŸåçš„è¯ï¼ŒåŸŸåæœ€åçš„å­—ç¬¦ä¸èƒ½æ˜¯ . ï¼Œå¦‚ä¸èƒ½ä¸º <code>kubernetes.default.svc.cluster.local.</code> ã€‚è™½ç„¶æŒ‰å¸¸è§„dnsè§£æçš„è¯æœ€åå¸¦ . è¡¨ç¤ºæ ¹åŸŸï¼Œä½†æ˜¯åœ¨ k8s ä¸­ä¼šå¯¼è‡´è§£æå¤±è´¥ï¼Œæç¤º <code>x509: cannot parse dnsName &quot;kubernetes.default.svc.cluster.local.&quot;</code></p>
<p>å¦å¤–ï¼Œå¦‚æœè¦ä½¿ç”¨é <code>cluster.local</code> çš„åŸŸåï¼Œå¦‚ <code>tareya.cn</code>ï¼Œåˆ™éœ€è¦ä¿®æ”¹åŸŸååˆ—è¡¨ä¸­æœ€åä¸¤ä¸ªåŸŸåä¸º <code>kubernetes.default.svc.tareya</code> å’Œ <code>kubernetes.default.svc.tareya.cn</code></p>
</blockquote>
<h5 id="2-ç”Ÿæˆ-server-è¯ä¹¦å’Œç§é’¥"><a href="#2-ç”Ÿæˆ-server-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="2. ç”Ÿæˆ server è¯ä¹¦å’Œç§é’¥"></a>2. ç”Ÿæˆ server è¯ä¹¦å’Œç§é’¥</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/tls &amp;&amp; \<br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server<br></code></pre></td></tr></table></figure>



<h5 id="3-è¯ä¹¦æ–‡ä»¶è¯´æ˜"><a href="#3-è¯ä¹¦æ–‡ä»¶è¯´æ˜" class="headerlink" title="3. è¯ä¹¦æ–‡ä»¶è¯´æ˜"></a>3. è¯ä¹¦æ–‡ä»¶è¯´æ˜</h5><table>
<thead>
<tr>
<th>è¯ä¹¦è·¯å¾„</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>~/tls/server.csr</td>
<td>server è¯ä¹¦çš„ç­¾åè¯·æ±‚æ–‡ä»¶</td>
</tr>
<tr>
<td>~/tls/server.pem</td>
<td>server è¯ä¹¦ï¼Œä¸º etcdã€kube-apiserver ä½¿ç”¨</td>
</tr>
<tr>
<td>~/tls/server-key.pem</td>
<td>server è¯ä¹¦çš„ç§é’¥æ–‡ä»¶</td>
</tr>
</tbody></table>
<h5 id="4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶"><a href="#4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶" class="headerlink" title="4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶"></a>4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ server è¯ä¹¦ï¼ˆk8s masterèŠ‚ç‚¹ã€etcd æ‰€æœ‰èŠ‚ç‚¹ï¼‰</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/server.pem dest=/data/applications/kubernetes/ssl/server.pem owner=root group=root mode=0644&quot; <br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/server.pem dest=/data/applications/etcd/ssl/server.pem owner=root group=root mode=0644&quot; <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ server è¯ä¹¦ç§é’¥ï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œæƒé™è®¾ç½®ä»–äººæ— æƒé™ï¼ˆk8s masterèŠ‚ç‚¹ã€etcd æ‰€æœ‰èŠ‚ç‚¹ï¼‰</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/server-key.pem dest=/data/applications/kubernetes/ssl/server-key.pem owner=root group=root mode=0600&quot; <br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/server-key.pem dest=/data/applications/etcd/ssl/server-key.pem owner=root group=root mode=0600&quot; <br></code></pre></td></tr></table></figure>



<h4 id="4ï¼‰ç”Ÿæˆ-etcd-è¯ä¹¦"><a href="#4ï¼‰ç”Ÿæˆ-etcd-è¯ä¹¦" class="headerlink" title="4ï¼‰ç”Ÿæˆ etcd è¯ä¹¦"></a>4ï¼‰ç”Ÿæˆ etcd è¯ä¹¦</h4><h4 id="5ï¼‰ç”Ÿæˆ-admin-è¯ä¹¦"><a href="#5ï¼‰ç”Ÿæˆ-admin-è¯ä¹¦" class="headerlink" title="5ï¼‰ç”Ÿæˆ admin è¯ä¹¦"></a>5ï¼‰ç”Ÿæˆ admin è¯ä¹¦</h4><blockquote>
<p>ğŸš© <strong>æç¤º:</strong></p>
<p>k8s çš„å®¢æˆ·ç«¯å·¥å…·ï¼ˆå¦‚ kubectlï¼‰å’Œ apiserver ä¹‹é—´æ˜¯é€šè¿‡ httpså®‰å…¨ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œapiserver ä¼šå¯¹å®¢æˆ·ç«¯æä¾›çš„è¯ä¹¦è¿›è¡Œè®¤è¯ã€æˆæƒã€‚å®¢æˆ·ç«¯å·¥å…·é€šè¿‡ kubeconfig æ–‡ä»¶æ¥è¿›è¡Œé‰´æƒã€‚</p>
<p>kubectl ä½œä¸ºæ•´ä¸ªé›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œéœ€è¦è¢«æˆäºˆæœ€é«˜çš„æƒé™ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬åˆ›å»ºå…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ã€‚</p>
</blockquote>
<h5 id="1-åˆ›å»º-admin-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#1-åˆ›å»º-admin-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º admin è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>1. åˆ›å»º admin è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/tls/admin-csr.json &lt;&lt;EOF<br>&#123;<br>  &quot;CN&quot;: &quot;admin&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;system&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-2"><a href="#é…ç½®å‚æ•°è¯´æ˜-2" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><blockquote>
<p>è¿™é‡Œå°† O è®¾ç½®ä¸º <code>system:masters</code>ï¼Œkube-apiserver ä¼šæå–è¯¥å­—æ®µï¼Œå°†è¯·æ±‚çš„ Group è®¾ç½®ä¸º <code>system:masters</code>ï¼›</p>
<p>Kube-apiserver é¢„å®šä¹‰çš„ ClusterRoleBinding <code>cluster-admin</code> å°† Group <code>system:masters</code> å’Œ ClusterRole <code>cluster-admin</code> ç»‘å®šï¼Œè¯¥ Role æˆæƒè®¿é—®æ‰€æœ‰ API çš„æƒé™ï¼›</p>
<p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“ä½œ client è¯ä¹¦ä½¿ç”¨ï¼Œå› æ­¤ hosts å­—æ®µä¸éœ€è¦é™å®šIPã€åŸŸåï¼Œè®¾ç½®ä¸ºç©ºå³å¯ã€‚</p>
</blockquote>
<h5 id="2-ç”Ÿæˆ-admin-è¯ä¹¦å’Œç§é’¥"><a href="#2-ç”Ÿæˆ-admin-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="2. ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥"></a>2. ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/tls &amp;&amp; \<br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin<br></code></pre></td></tr></table></figure>



<h5 id="3-è¯ä¹¦æ–‡ä»¶è¯´æ˜-1"><a href="#3-è¯ä¹¦æ–‡ä»¶è¯´æ˜-1" class="headerlink" title="3. è¯ä¹¦æ–‡ä»¶è¯´æ˜"></a>3. è¯ä¹¦æ–‡ä»¶è¯´æ˜</h5><table>
<thead>
<tr>
<th>è¯ä¹¦è·¯å¾„</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>~/tls/admin.csr</td>
<td>admin è¯ä¹¦çš„ç­¾åè¯·æ±‚æ–‡ä»¶</td>
</tr>
<tr>
<td>~/tls/admin.pem</td>
<td>admin è¯ä¹¦ï¼Œkubectl å’Œå…¶ä»– k8s å®¢æˆ·ç«¯ä½¿ç”¨</td>
</tr>
<tr>
<td>~/tls/admin-key.pem</td>
<td>admin è¯ä¹¦çš„ç§é’¥æ–‡ä»¶</td>
</tr>
</tbody></table>
<h5 id="4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶-1"><a href="#4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶-1" class="headerlink" title="4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶"></a>4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ admin è¯ä¹¦ï¼ˆk8s masterèŠ‚ç‚¹ï¼‰</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/admin.pem dest=/data/applications/kubernetes/ssl/admin.pem owner=root group=root mode=0644&quot; <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ admin è¯ä¹¦ç§é’¥ï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œæƒé™è®¾ç½®ä»–äººæ— æƒé™ï¼ˆk8s masterèŠ‚ç‚¹ï¼‰</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/admin-key.pem dest=/data/applications/kubernetes/ssl/admin-key.pem owner=root group=root mode=0600&quot; <br></code></pre></td></tr></table></figure>



<h4 id="6ï¼‰ç”Ÿæˆ-metrics-server-è¯ä¹¦"><a href="#6ï¼‰ç”Ÿæˆ-metrics-server-è¯ä¹¦" class="headerlink" title="6ï¼‰ç”Ÿæˆ metrics-server è¯ä¹¦"></a>6ï¼‰ç”Ÿæˆ metrics-server è¯ä¹¦</h4><h5 id="1-åˆ›å»º-metrics-server-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#1-åˆ›å»º-metrics-server-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º metrics-server è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>1. åˆ›å»º metrics-server è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/tls/metrics-server-csr.json  &lt;&lt;EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:metrics-server&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;k8s&quot;,<br>      &quot;OU&quot;: &quot;system&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-3"><a href="#é…ç½®å‚æ•°è¯´æ˜-3" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><blockquote>
<p>è¿™é‡Œ CN è®¾å®šçš„åç§°ï¼Œéœ€è¦ä¸åç»­ metrics-server çš„ <code>--requestheader-allowed-names</code> å‚æ•°é…ç½®ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šè¢« metrics-server æ‹’ç»è®¿é—®ï¼Œ</p>
<p>åç»­éœ€è¦å¯¹ metrics-server è¿›è¡Œä¸“é—¨çš„ RBAC æˆæƒï¼Œå»ºè®® CN é…ç½®å’Œ RBAC æˆæƒç”¨æˆ·ä¿æŒä¸€è‡´ã€‚</p>
</blockquote>
<h5 id="2-ç”Ÿæˆ-metrics-server-è¯ä¹¦å’Œç§é’¥"><a href="#2-ç”Ÿæˆ-metrics-server-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="2. ç”Ÿæˆ metrics-server è¯ä¹¦å’Œç§é’¥"></a>2. ç”Ÿæˆ metrics-server è¯ä¹¦å’Œç§é’¥</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/tls &amp;&amp; \<br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes metrics-server-csr.json | cfssljson -bare metrics-server<br></code></pre></td></tr></table></figure>



<h5 id="3-è¯ä¹¦æ–‡ä»¶è¯´æ˜-2"><a href="#3-è¯ä¹¦æ–‡ä»¶è¯´æ˜-2" class="headerlink" title="3. è¯ä¹¦æ–‡ä»¶è¯´æ˜"></a>3. è¯ä¹¦æ–‡ä»¶è¯´æ˜</h5><table>
<thead>
<tr>
<th>è¯ä¹¦è·¯å¾„</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>~/tls/metrics-server.csr</td>
<td>metrics-server è¯ä¹¦çš„ç­¾åè¯·æ±‚æ–‡ä»¶</td>
</tr>
<tr>
<td>~/tls/metrics-server.pem</td>
<td>metrics-server è¯ä¹¦ï¼Œmetrics-server ä½¿ç”¨</td>
</tr>
<tr>
<td>~/tls/metrics-server-key.pem</td>
<td>metrics-server è¯ä¹¦çš„ç§é’¥æ–‡ä»¶</td>
</tr>
</tbody></table>
<h5 id="4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶-2"><a href="#4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶-2" class="headerlink" title="4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶"></a>4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ metrics-server è¯ä¹¦ï¼ˆk8s masterèŠ‚ç‚¹ï¼‰</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/metrics-server.pem dest=/data/applications/kubernetes/ssl/metrics-server.pem owner=root group=root mode=0644&quot; <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ metrics-server è¯ä¹¦ç§é’¥ï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œæƒé™è®¾ç½®ä»–äººæ— æƒé™ï¼ˆk8s masterèŠ‚ç‚¹ï¼‰</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/tls/metrics-server-key.pem dest=/data/applications/kubernetes/ssl/metrics-server-key.pem owner=root group=root mode=0600&quot; <br></code></pre></td></tr></table></figure>



<h4 id="7ï¼‰ç”Ÿæˆ-kube-proxy-è¯ä¹¦"><a href="#7ï¼‰ç”Ÿæˆ-kube-proxy-è¯ä¹¦" class="headerlink" title="7ï¼‰ç”Ÿæˆ kube-proxy è¯ä¹¦"></a>7ï¼‰ç”Ÿæˆ kube-proxy è¯ä¹¦</h4><h5 id="1-åˆ›å»º-kube-proxy-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#1-åˆ›å»º-kube-proxy-è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º kube-proxy è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>1. åˆ›å»º kube-proxy è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/tls/kube-proxy-csr.json &lt;&lt;EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-proxy&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;k8s&quot;,<br>      &quot;OU&quot;: &quot;system&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-4"><a href="#é…ç½®å‚æ•°è¯´æ˜-4" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><blockquote>
<p>è¿™é‡Œå°† CN è®¾ç½®ä¸º <code>system:kube-proxy</code>ï¼Œkube-apiserver ä¼šæå–è¯¥å­—æ®µï¼Œå°†è¯·æ±‚çš„ Userè®¾ç½®ä¸º <code>system:kube-proxy</code>ï¼›</p>
<p>Kube-apiserver é¢„å®šä¹‰çš„ ClusterRoleBinding <code>system:node-proxier</code> å°† User <code>system:kube-proxy</code> å’Œ ClusterRole<code>system:node-proxier </code> ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p>
<p>è¯¥è¯ä¹¦åªä¼šè¢« kube-proxy å½“ä½œ client è¯ä¹¦ä½¿ç”¨ï¼Œå› æ­¤ hosts å­—æ®µä¸éœ€è¦é™å®šIPã€åŸŸåï¼Œè®¾ç½®ä¸ºç©ºå³å¯ã€‚</p>
</blockquote>
<h5 id="2-ç”Ÿæˆ-kube-proxy-è¯ä¹¦å’Œç§é’¥"><a href="#2-ç”Ÿæˆ-kube-proxy-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="2. ç”Ÿæˆ kube-proxy è¯ä¹¦å’Œç§é’¥"></a>2. ç”Ÿæˆ kube-proxy è¯ä¹¦å’Œç§é’¥</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/tls &amp;&amp; \<br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy<br></code></pre></td></tr></table></figure>



<h5 id="3-è¯ä¹¦æ–‡ä»¶è¯´æ˜-3"><a href="#3-è¯ä¹¦æ–‡ä»¶è¯´æ˜-3" class="headerlink" title="3. è¯ä¹¦æ–‡ä»¶è¯´æ˜"></a>3. è¯ä¹¦æ–‡ä»¶è¯´æ˜</h5><table>
<thead>
<tr>
<th>è¯ä¹¦è·¯å¾„</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>~/tls/kube-proxy.csr</td>
<td>kube-proxy è¯ä¹¦çš„ç­¾åè¯·æ±‚æ–‡ä»¶</td>
</tr>
<tr>
<td>~/tls/kube-proxy.pem</td>
<td>kube-proxy è¯ä¹¦ï¼Œkube-proxy ä½¿ç”¨</td>
</tr>
<tr>
<td>~/tls/kube-proxy-key.pem</td>
<td>Kube-proxy è¯ä¹¦çš„ç§é’¥æ–‡ä»¶</td>
</tr>
</tbody></table>
<h5 id="4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶-3"><a href="#4-æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶-3" class="headerlink" title="4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶"></a>4. æ‰¹é‡åˆ†å‘è¯ä¹¦æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ kube-proxy è¯ä¹¦ï¼ˆk8s æ‰€æœ‰èŠ‚ç‚¹ï¼‰</span><br>ansible k8s-node -S -R root -m copy -a &quot;src=~/tls/kube-proxy.pem dest=/data/applications/kubernetes/ssl/kube-proxy.pem owner=root group=root mode=0644&quot; <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ kube-proxy è¯ä¹¦ç§é’¥ï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œæƒé™è®¾ç½®ä»–äººæ— æƒé™ï¼ˆk8s æ‰€æœ‰èŠ‚ç‚¹ï¼‰</span><br>ansible k8s-node -S -R root -m copy -a &quot;src=~/tls/kube-proxy-key.pem dest=/data/applications/kubernetes/ssl/kube-proxy-key.pem owner=root group=root mode=0600&quot; <br></code></pre></td></tr></table></figure>





<h3 id="2ã€éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·"><a href="#2ã€éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="2ã€éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·"></a>2ã€éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·</h3><h4 id="1ï¼‰ä¸‹è½½-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#1ï¼‰ä¸‹è½½-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="1ï¼‰ä¸‹è½½ kubectl äºŒè¿›åˆ¶æ–‡ä»¶"></a>1ï¼‰ä¸‹è½½ kubectl äºŒè¿›åˆ¶æ–‡ä»¶</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md">å®˜æ–¹ä¸‹è½½åœ°å€</a></p>
<p>è™½ç„¶ kubectl æ˜¯å…·å¤‡å‘ä¸‹å…¼å®¹èƒ½åŠ›çš„ï¼Œä½†æ˜¯åœ¨é€‰æ‹©ç‰ˆæœ¬æ—¶è¿˜æ˜¯å»ºè®®å°½é‡ä¸ K8S ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œå¦‚æœ¬æ–‡ K8S ç‰ˆæœ¬ä¸º 1.18.18ï¼Œæ•… kubectl ç‰ˆæœ¬ä¹Ÿé€‰ç”¨ 1.18.18 ã€‚ä¸‹è½½äºŒè¿›åˆ¶æ—¶ï¼Œæ³¨æ„å¹³å°åŒ¹é…ã€‚</p>
</blockquote>
<h5 id="1-ä¸‹è½½è§£å‹-1-18-18-kubectl-äºŒè¿›åˆ¶åŒ…"><a href="#1-ä¸‹è½½è§£å‹-1-18-18-kubectl-äºŒè¿›åˆ¶åŒ…" class="headerlink" title="1. ä¸‹è½½è§£å‹ 1.18.18 kubectl äºŒè¿›åˆ¶åŒ…"></a>1. ä¸‹è½½è§£å‹ 1.18.18 kubectl äºŒè¿›åˆ¶åŒ…</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~ &amp;&amp; \<br>wget -c https://dl.k8s.io/v1.18.18/kubernetes-client-linux-amd64.tar.gz &amp;&amp; \<br>tar xf kubernetes-client-linux-amd64.tar.gz<br></code></pre></td></tr></table></figure>

<h5 id="2-éªŒè¯"><a href="#2-éªŒè¯" class="headerlink" title="2. éªŒè¯"></a>2. éªŒè¯</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd kubernetes/client/bin/ &amp;&amp; ./kubectl version<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Client Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;18&quot;, GitVersion:&quot;v1.18.18&quot;, GitCommit:&quot;6f6ce59dc8fefde25a3ba0ef0047f4ec6662ef24&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2021-04-15T03:31:30Z&quot;, GoVersion:&quot;go1.13.15&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;<br></code></pre></td></tr></table></figure>



<h4 id="2ï¼‰åˆ†å‘-kubectl-è‡³å„-master-èŠ‚ç‚¹"><a href="#2ï¼‰åˆ†å‘-kubectl-è‡³å„-master-èŠ‚ç‚¹" class="headerlink" title="2ï¼‰åˆ†å‘ kubectl è‡³å„ master èŠ‚ç‚¹"></a>2ï¼‰åˆ†å‘ kubectl è‡³å„ master èŠ‚ç‚¹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/client/bin/kubectl dest=/usr/bin/kubectl owner=root<br>group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>



<h4 id="3ï¼‰åˆ›å»º-kubeconfig"><a href="#3ï¼‰åˆ›å»º-kubeconfig" class="headerlink" title="3ï¼‰åˆ›å»º kubeconfig"></a>3ï¼‰åˆ›å»º kubeconfig</h4><h5 id="1-è®¾ç½®é›†ç¾¤å‚æ•°"><a href="#1-è®¾ç½®é›†ç¾¤å‚æ•°" class="headerlink" title="1. è®¾ç½®é›†ç¾¤å‚æ•°"></a>1. è®¾ç½®é›†ç¾¤å‚æ•°</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl config set-cluster kubernetes \<br>  --certificate-authority=/data/applications/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$HOME/.kube/kubectl.kubeconfig<br></code></pre></td></tr></table></figure>

<h6 id="å‚æ•°è¯´æ˜"><a href="#å‚æ•°è¯´æ˜" class="headerlink" title="å‚æ•°è¯´æ˜:"></a>å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>â€“certificate-authority</td>
<td>éªŒè¯ kube-apiserver è¯ä¹¦çš„æ ¹è¯ä¹¦</td>
</tr>
<tr>
<td>â€“embed-certs=true</td>
<td>å°†è¯ä¹¦å†…å®¹åŠ å¯†åµŒå…¥kubeconfigä¸­ï¼Œå¦‚æœè®¾ä¸º false åˆ™é€šè¿‡æŒ‡å‘çš„æ–‡ä»¶è·¯å¾„è¯»å–æ–‡ä»¶</td>
</tr>
<tr>
<td>â€“server</td>
<td>apiserver çš„åŠ å¯†é€šä¿¡åœ°å€</td>
</tr>
<tr>
<td>â€“kubeconfig</td>
<td>kubeconfig ç”Ÿæˆè·¯å¾„</td>
</tr>
</tbody></table>
<h5 id="2-è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°"><a href="#2-è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°" class="headerlink" title="2. è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°"></a>2. è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl config set-credentials admin \<br>  --client-certificate=/data/applications/kubernetes/ssl/admin.pem \<br>  --client-key=/data/applications/kubernetes/ssl/admin-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$HOME/.kube/kubectl.kubeconfig<br></code></pre></td></tr></table></figure>

<h6 id="å‚æ•°è¯´æ˜-1"><a href="#å‚æ•°è¯´æ˜-1" class="headerlink" title="å‚æ•°è¯´æ˜:"></a>å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>â€“client-certificate</td>
<td>è¿æ¥ apiserver æ—¶ï¼Œè®¤è¯ä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦</td>
</tr>
<tr>
<td>â€“client-key</td>
<td>è¿æ¥ apiserver æ—¶ï¼Œè®¤è¯ä½¿ç”¨çš„è¯ä¹¦ç§é’¥</td>
</tr>
</tbody></table>
<h5 id="3-è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°"><a href="#3-è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°" class="headerlink" title="3. è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°"></a>3. è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl config set-context kubernetes \<br> --cluster=kubernetes \<br> --user=admin \<br> --kubeconfig=$HOME/.kube/kubectl.kubeconfig<br></code></pre></td></tr></table></figure>

<h5 id="4-è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡"><a href="#4-è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡" class="headerlink" title="4. è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡"></a>4. è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl config use-context kubernetes --kubeconfig=$HOME/.kube/kubectl.kubeconfig<br></code></pre></td></tr></table></figure>



<h4 id="4ï¼‰åˆ†å‘-kubeconfig-è‡³å„-master-èŠ‚ç‚¹"><a href="#4ï¼‰åˆ†å‘-kubeconfig-è‡³å„-master-èŠ‚ç‚¹" class="headerlink" title="4ï¼‰åˆ†å‘ kubeconfig è‡³å„ master èŠ‚ç‚¹"></a>4ï¼‰åˆ†å‘ kubeconfig è‡³å„ master èŠ‚ç‚¹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> root ç”¨æˆ·</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=$HOME/.kube/kubectl.kubeconfig dest=/root/.kube/kubectl.kubeconfig owner=root group=root mode=0600&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> æ™®é€šç”¨æˆ·</span><br>ansible k8s-master -m copy -a &quot;src=$HOME/.kube/kubectl.kubeconfig dest=$HOME/.kube/kubectl.kubeconfig mode=0600&quot;<br></code></pre></td></tr></table></figure>





<h3 id="3ã€éƒ¨ç½²-etcd-é›†ç¾¤"><a href="#3ã€éƒ¨ç½²-etcd-é›†ç¾¤" class="headerlink" title="3ã€éƒ¨ç½² etcd é›†ç¾¤"></a>3ã€éƒ¨ç½² etcd é›†ç¾¤</h3><p><strong>åŸºç¡€ç»„ä»¶ä»‹ç» â€”â€” etcd:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-etcd/#Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-etcd">ä¼ é€é—¨</a></p>
<blockquote>
<p>ğŸŒˆ etcd ä» 3.4 ç‰ˆæœ¬å¼€å§‹ä¼šè‡ªåŠ¨é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡å‚æ•°ï¼ŒEnvironmentFile æ–‡ä»¶ä¸­æœ‰çš„å‚æ•°ä¸éœ€è¦åœ¨ systems unit çš„ ExecStart ä¸­æ·»åŠ äº†ï¼Œå¯ä»¥æ›´åŠ çš„ç²¾ç®€åŒ–é…ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œæˆ‘ä»¬é€‰ç”¨ 3.4 ç‰ˆæœ¬çš„ etcdã€‚æ–¹ä¾¿åæœŸç»Ÿä¸€çš„é…ç½®ç®¡ç†ã€‚</p>
</blockquote>
<h4 id="1ï¼‰ä¸‹è½½-etcd-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#1ï¼‰ä¸‹è½½-etcd-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="1ï¼‰ä¸‹è½½ etcd äºŒè¿›åˆ¶æ–‡ä»¶"></a>1ï¼‰ä¸‹è½½ etcd äºŒè¿›åˆ¶æ–‡ä»¶</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases">å®˜æ–¹ä¸‹è½½åœ°å€</a></p>
</blockquote>
<h5 id="1-ä¸‹è½½è§£å‹-3-4-14-etcd-å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äºŒè¿›åˆ¶åŒ…"><a href="#1-ä¸‹è½½è§£å‹-3-4-14-etcd-å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äºŒè¿›åˆ¶åŒ…" class="headerlink" title="1. ä¸‹è½½è§£å‹ 3.4.14 etcd å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äºŒè¿›åˆ¶åŒ…"></a>1. ä¸‹è½½è§£å‹ 3.4.14 etcd å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äºŒè¿›åˆ¶åŒ…</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~ &amp;&amp; \<br>wget -c https://github.com/coreos/etcd/releases/download/v3.4.14/etcd-v3.4.14-linux-amd64.tar.gz &amp;&amp; \<br>tar xf etcd-v3.4.14-linux-amd64.tar.gz<br></code></pre></td></tr></table></figure>

<h5 id="2-éªŒè¯-1"><a href="#2-éªŒè¯-1" class="headerlink" title="2. éªŒè¯"></a>2. éªŒè¯</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd etcd-v3.4.14-linux-amd64 &amp;&amp; ./etcdctl version<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">etcdctl version: 3.4.14<br>API version: 3.4<br></code></pre></td></tr></table></figure>



<h4 id="2ï¼‰åˆ†å‘-etcd-è‡³å„-master-èŠ‚ç‚¹"><a href="#2ï¼‰åˆ†å‘-etcd-è‡³å„-master-èŠ‚ç‚¹" class="headerlink" title="2ï¼‰åˆ†å‘ etcd è‡³å„ master èŠ‚ç‚¹"></a>2ï¼‰åˆ†å‘ etcd è‡³å„ master èŠ‚ç‚¹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ etcd server ç«¯</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/etcd-v3.4.14-linux-amd64/etcd dest=/data/applications/etcd/bin/etcd owner=root group=root mode=0755&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ etcd client å·¥å…·</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/etcd-v3.4.14-linux-amd64/etcdctl dest=/data/applications/etcd/bin/etcdctl owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>



<h4 id="3ï¼‰åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#3ï¼‰åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="3ï¼‰åˆ›å»ºé…ç½®æ–‡ä»¶"></a>3ï¼‰åˆ›å»ºé…ç½®æ–‡ä»¶</h4><h5 id="1-æ–°å»º-etcd-é…ç½®æ–‡ä»¶-etcd-conf"><a href="#1-æ–°å»º-etcd-é…ç½®æ–‡ä»¶-etcd-conf" class="headerlink" title="1. æ–°å»º etcd é…ç½®æ–‡ä»¶ etcd.conf"></a>1. æ–°å»º etcd é…ç½®æ–‡ä»¶ <code>etcd.conf</code></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/kubernetes/etcd/cfg/etcd.conf &lt;&lt; EOF<br><span class="hljs-meta">#</span><span class="bash">[Member]</span><br>ETCD_NAME=&quot;etcd-1&quot;<br>ETCD_DATA_DIR=&quot;/data/applications/etcd/data&quot;<br>ETCD_WAL_DIR=&quot;/data/applications/etcd/wal&quot;<br>ETCD_LISTEN_PEER_URLS=&quot;https://192.168.3.231:2380&quot;<br>ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.3.231:2379,http://127.0.0.1:2379&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash">[Clustering]</span><br>ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.3.231:2380&quot;<br>ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.3.231:2379&quot;<br>ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.3.231:2380,etcd-2=https://192.168.3.232:2380,etcd-3=https://192.168.3.233:2380&quot;<br>ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster-0&quot;<br>ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;<br>ETCD_ENABLE_V2=&quot;true&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash">[Security]</span><br>ETCD_CERT_FILE=&quot;/data/applications/etcd/ssl/server.pem&quot;<br>ETCD_KEY_FILE=&quot;/data/applications/etcd/ssl/server-key.pem&quot;<br>ETCD_TRUSTED_CA_FILE=&quot;/data/applications/etcd/ssl/ca.pem&quot;<br>ETCD_CLIENT_CERT_AUTH=&quot;true&quot;<br>ETCD_PEER_CERT_FILE=&quot;/data/applications/etcd/ssl/server.pem&quot;<br>ETCD_PEER_KEY_FILE=&quot;/data/applications/etcd/ssl/server-key.pem&quot;<br>ETCD_PEER_TRUSTED_CA_FILE=&quot;/data/applications/etcd/ssl/ca.pem&quot;<br>ETCD_PEER_CLIENT_CERT_AUTH=&quot;true&quot;<br><br>EOF<br></code></pre></td></tr></table></figure>

<blockquote>
<p>âš ï¸ <strong>æ³¨æ„:</strong></p>
<p>etcd æ¯ä¸ªèŠ‚ç‚¹çš„é…ç½®ä¸åŒï¼Œæ ¹æ®å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹ï¼Œå¯ä»¥é€šè¿‡ jinja æ¨¡ç‰ˆæ¸²æŸ“ã€‚</p>
<p>3.4 ç‰ˆæœ¬çš„ etcd é»˜è®¤ä½¿ç”¨çš„æ˜¯ v3 ç‰ˆæœ¬çš„APIï¼Œå¹¶é»˜è®¤å…³é—­äº† v2 ç‰ˆæœ¬APIçš„ä½¿ç”¨ï¼Œå¦‚æœè¦ç»§ç»­ä½¿ç”¨çš„è¯ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® <code>ETCD_ENABLE_V2=&quot;true&quot;</code>ï¼Œæˆ–è€…åœ¨ä½¿ç”¨å‘½ä»¤è¡Œæ—¶è®¾ç½® <code>ETCDCTL_API</code> ç¯å¢ƒå˜é‡ï¼Œå¦‚<code>ETCDCTL_API=2 etcdctl</code>ã€‚</p>
<p>flannel æ“ä½œ etcd ä½¿ç”¨çš„æ˜¯ v2 çš„APIï¼Œ kubernetes æ“ä½œ etcd ä½¿ç”¨çš„ v3 çš„APIï¼Œcalico 3.x ç‰ˆæœ¬ä¹Ÿä½¿ç”¨ v3 çš„ APIã€‚</p>
</blockquote>
<h5 id="2-æ–°å»º-systemd-unit-é…ç½®-etcd-service"><a href="#2-æ–°å»º-systemd-unit-é…ç½®-etcd-service" class="headerlink" title="2. æ–°å»º systemd unit é…ç½® etcd.service"></a>2. æ–°å»º systemd unit é…ç½® <code>etcd.service</code></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/kubernetes/etcd/systemd/etcd.service &lt;&lt; EOF<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br>   <br>[Service]<br>Type=notify<br>EnvironmentFile=/data/applications/etcd/cfg/etcd.conf<br>ExecStart=/data/applications/etcd/bin/etcd \<br>--auto-compaction-mode=periodic \<br>--auto-compaction-retention=1 \<br>--max-request-bytes=33554432 \<br>--quota-backend-bytes=6442450944 \<br>--heartbeat-interval=250 \<br>--election-timeout=2000 \<br>--logger=zap<br>Restart=on-failure<br>RestartSec=5<br>LimitNOFILE=65536<br>   <br>[Install]<br>WantedBy=multi-user.target<br><br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="é‡è¦é…ç½®å‚æ•°è¯´æ˜"><a href="#é‡è¦é…ç½®å‚æ•°è¯´æ˜" class="headerlink" title="é‡è¦é…ç½®å‚æ•°è¯´æ˜:"></a>é‡è¦é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th>é‡è¦å‚æ•°</th>
<th>å‚æ•°è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>EnvironmentFile</td>
<td>ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨æ”¹æ–¹å¼å¯ä»¥ä»¥åŠ è½½å˜é‡çš„å½¢å¼åˆ¶ä½œç»Ÿä¸€çš„ unit æ¨¡ç‰ˆ</td>
</tr>
<tr>
<td>â€“cert-file / â€“key-file</td>
<td>etcd server ä¸ client é€šä¿¡æ—¶ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥</td>
</tr>
<tr>
<td>â€“trusted-ca-file</td>
<td>ç­¾å‘ client è¯ä¹¦çš„ ca è¯ä¹¦ï¼Œç”¨äºéªŒè¯ client è¯ä¹¦ï¼›</td>
</tr>
<tr>
<td>â€“peer-cert-file / â€“peer-key-file</td>
<td>etcd peer ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</td>
</tr>
<tr>
<td>â€“peer-trusted-ca-file</td>
<td>ç­¾å‘ peer è¯ä¹¦çš„ ca è¯ä¹¦ï¼Œç”¨äºéªŒè¯ peer è¯ä¹¦ï¼Œå¯ä»¥å’Œ client è¯ä¹¦ä½¿ç”¨åŒä¸€å¥—ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸åŒçš„ï¼›</td>
</tr>
</tbody></table>
<h4 id="4ï¼‰åˆ†å‘é…ç½®æ–‡ä»¶"><a href="#4ï¼‰åˆ†å‘é…ç½®æ–‡ä»¶" class="headerlink" title="4ï¼‰åˆ†å‘é…ç½®æ–‡ä»¶"></a>4ï¼‰åˆ†å‘é…ç½®æ–‡ä»¶</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ systemd unit é…ç½®æ–‡ä»¶</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/etcd/systemd/etcd.service dest=/usr/lib/systemd/system/etcd.service owner=root group=root mode=0644&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ etcd é…ç½®æ–‡ä»¶</span><br>ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/etcd/cfg/etcd.conf dest=/data/applications/etcd/cfg/etcd.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h4 id="5ï¼‰å¯åŠ¨é›†ç¾¤"><a href="#5ï¼‰å¯åŠ¨é›†ç¾¤" class="headerlink" title="5ï¼‰å¯åŠ¨é›†ç¾¤"></a>5ï¼‰å¯åŠ¨é›†ç¾¤</h4><h5 id="1-æ‰¹é‡å¯åŠ¨-etcd"><a href="#1-æ‰¹é‡å¯åŠ¨-etcd" class="headerlink" title="1. æ‰¹é‡å¯åŠ¨ etcd"></a>1. æ‰¹é‡å¯åŠ¨ etcd</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl enable etcd.service&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl start etcd.service&quot;<br></code></pre></td></tr></table></figure>

<h5 id="2-éªŒè¯æœåŠ¡çŠ¶æ€"><a href="#2-éªŒè¯æœåŠ¡çŠ¶æ€" class="headerlink" title="2. éªŒè¯æœåŠ¡çŠ¶æ€"></a>2. éªŒè¯æœåŠ¡çŠ¶æ€</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m shell -a &quot;ETCDCTL_API=3 /data/applications/etcd/bin/etcdctl  --endpoints=http://127.0.0.1:2379 --cacert=/data/applications/etcd/ssl/ca.pem --cert=/data/applications/etcd/ssl/server.pem --key=/data/applications/etcd/ssl/server-key.pem endpoint health&quot;<br></code></pre></td></tr></table></figure>

<h6 id="æ­£å¸¸è¿”å›ç»“æœ"><a href="#æ­£å¸¸è¿”å›ç»“æœ" class="headerlink" title="æ­£å¸¸è¿”å›ç»“æœ:"></a>æ­£å¸¸è¿”å›ç»“æœ:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> å‡è¿”å› healthy æ—¶ï¼Œé›†ç¾¤çŠ¶æ€æœªæ­£å¸¸</span><br>192.168.3.233 | CHANGED | rc=0 &gt;&gt;<br>http://127.0.0.1:2379 is healthy: successfully committed proposal: took = 2.802973ms<br><br>192.168.3.231 | CHANGED | rc=0 &gt;&gt;<br>http://127.0.0.1:2379 is healthy: successfully committed proposal: took = 2.426585ms<br><br>192.168.3.232 | CHANGED | rc=0 &gt;&gt;<br>http://127.0.0.1:2379 is healthy: successfully committed proposal: took = 3.491516ms<br></code></pre></td></tr></table></figure>

<h5 id="3-æŸ¥çœ‹é›†ç¾¤-leader"><a href="#3-æŸ¥çœ‹é›†ç¾¤-leader" class="headerlink" title="3. æŸ¥çœ‹é›†ç¾¤ leader"></a>3. æŸ¥çœ‹é›†ç¾¤ leader</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ETCDCTL_API=3 /data/applications/etcd/bin/etcdctl -w table  --endpoints=https://192.168.3.231:2379,https://192.168.3.232:2379,https://192.168.3.233:2379 --cacert=/data/applications/etcd/ssl/ca.pem --cert=/data/applications/etcd/ssl/server.pem --key=/data/applications/etcd/ssl/server-key.pem endpoint status<br></code></pre></td></tr></table></figure>

<h6 id="æ­£å¸¸è¿”å›ç»“æœ-1"><a href="#æ­£å¸¸è¿”å›ç»“æœ-1" class="headerlink" title="æ­£å¸¸è¿”å›ç»“æœ:"></a>æ­£å¸¸è¿”å›ç»“æœ:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> å½“å‰ etcd raft leader ä¸º 192.168.3.231</span><br><br>+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br>|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |<br>+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br>| https://192.168.3.231:2379 | e7d52edc2101ab48 |  3.4.14 |   20 kB |      true |      false |         5 |         28 |                 28 |        |<br>| https://192.168.3.232:2379 | a191bc097f41b735 |  3.4.14 |   20 kB |     false |      false |         5 |         28 |                 28 |        |<br>| https://192.168.3.233:2379 | 307ec828b6239718 |  3.4.14 |   20 kB |     false |      false |         5 |         28 |                 28 |        |<br>+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br></code></pre></td></tr></table></figure>





<h3 id="4ã€éƒ¨ç½²å››å±‚ä»£ç†-HA-ç¯å¢ƒ"><a href="#4ã€éƒ¨ç½²å››å±‚ä»£ç†-HA-ç¯å¢ƒ" class="headerlink" title="4ã€éƒ¨ç½²å››å±‚ä»£ç† HA ç¯å¢ƒ"></a>4ã€éƒ¨ç½²å››å±‚ä»£ç† HA ç¯å¢ƒ</h3><blockquote>
<p>ğŸš© <strong>ç”¨ nginx 4 å±‚é€æ˜ä»£ç†æ¥åšè´Ÿè½½å‡è¡¡çš„åŠŸèƒ½</strong></p>
<p>æ­å»ºnginx+keepalivedç¯å¢ƒï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„vipåœ°å€ï¼Œåç«¯å¯¹æ¥å¤šä¸ª apiserver å®ä¾‹ï¼Œnginx å¯¹å®ƒä»¬åšå¥åº·æ£€æŸ¥å’Œè´Ÿè½½å‡è¡¡ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ openrestyï¼Œå…¶å®è´¨ä»ç„¶æ˜¯ nginxï¼Œåªæ˜¯å°è£…äº† luaã€‚<code>kubelet</code>ã€<code>kube-proxy</code>ã€<code>controller-manager</code>ã€<code>scheduler</code> é€šè¿‡vipåœ°å€è®¿é—® kube-apiserverï¼Œä»è€Œå®ç° kube-apiserver çš„é«˜å¯ç”¨ï¼›</p>
<p>master èŠ‚ç‚¹çš„ <code>kube-controller-manager</code>ã€<code>kube-schedule</code>r æ˜¯å¤šå®ä¾‹(3ä¸ª)éƒ¨ç½²ï¼Œè‡ªèº«å³å­˜åœ¨é«˜å¯ç”¨æœºåˆ¶ï¼Œæ‰€ä»¥åªè¦æœ‰ä¸€ä¸ªå®ä¾‹æ­£å¸¸ï¼Œå°±å¯ä»¥ä¿è¯é«˜å¯ç”¨ã€‚</p>
</blockquote>
<h4 id="1ï¼‰å®‰è£…-openresty"><a href="#1ï¼‰å®‰è£…-openresty" class="headerlink" title="1ï¼‰å®‰è£… openresty"></a>1ï¼‰å®‰è£… openresty</h4><blockquote>
<p>ğŸš© ä»¥ä¸‹æ“ä½œåœ¨æ‰€æœ‰ lb èŠ‚ç‚¹è¿›è¡Œ</p>
</blockquote>
<h5 id="1-å®‰è£…ä¾èµ–åº“"><a href="#1-å®‰è£…ä¾èµ–åº“" class="headerlink" title="1. å®‰è£…ä¾èµ–åº“"></a>1. å®‰è£…ä¾èµ–åº“</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y curl git gcc glibc gcc-c++ openssl-devel pcre-devel yum-utils<br></code></pre></td></tr></table></figure>

<h5 id="2-å®‰è£…openrestyä»¥åŠopenssl-ä¾èµ–"><a href="#2-å®‰è£…openrestyä»¥åŠopenssl-ä¾èµ–" class="headerlink" title="2. å®‰è£…openrestyä»¥åŠopenssl ä¾èµ–"></a>2. å®‰è£…openrestyä»¥åŠopenssl ä¾èµ–</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo &amp;&amp; \<br>yum install -y openresty openresty-openssl111-devel<br></code></pre></td></tr></table></figure>

<h5 id="3-è½¯é“¾è‡³æ ‡å‡†ç›®å½•"><a href="#3-è½¯é“¾è‡³æ ‡å‡†ç›®å½•" class="headerlink" title="3. è½¯é“¾è‡³æ ‡å‡†ç›®å½•"></a>3. è½¯é“¾è‡³æ ‡å‡†ç›®å½•</h5><p>ä½¿ç”¨yumå®‰è£…ï¼Œé»˜è®¤å®‰è£…è·¯å¾„åœ¨<code>/usr/local/openresty</code> ï¼Œå°†å…¶è½¯é“¾åˆ°æ ‡å‡†ç›®å½• <code>/data/applications</code>ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -s /usr/local/openresty /data/applications<br></code></pre></td></tr></table></figure>

<p>ä¸ºäº†ä½¿ç”¨ä¹ æƒ¯ï¼Œå¯ä»¥å°† openresty åˆ«åä¸º nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -s /usr/bin/openresty /usr/bin/nginx<br></code></pre></td></tr></table></figure>

<h5 id="4-æ–‡ä»¶å¥æŸ„ä¼˜åŒ–"><a href="#4-æ–‡ä»¶å¥æŸ„ä¼˜åŒ–" class="headerlink" title="4. æ–‡ä»¶å¥æŸ„ä¼˜åŒ–"></a>4. æ–‡ä»¶å¥æŸ„ä¼˜åŒ–</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ulimit -n 65525<br></code></pre></td></tr></table></figure>

<p>ç¼–è¾‘æ–‡ä»¶ <code>/etc/security/limits.conf </code>ï¼Œè¿½åŠ ä»¥ä¸‹å†…å®¹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> æ–‡ä»¶åº•éƒ¨æ·»åŠ ä¸‹é¢å››è¡Œå†…å®¹</span><br>* soft nofile 65525<br>* hard nofile 65525<br>* soft nproc 65525<br>* hard nproc 65525<br></code></pre></td></tr></table></figure>



<h4 id="2ï¼‰åˆ›å»º-nginx-stream-é…ç½®æ–‡ä»¶"><a href="#2ï¼‰åˆ›å»º-nginx-stream-é…ç½®æ–‡ä»¶" class="headerlink" title="2ï¼‰åˆ›å»º nginx stream é…ç½®æ–‡ä»¶"></a>2ï¼‰åˆ›å»º nginx stream é…ç½®æ–‡ä»¶</h4><blockquote>
<p>ğŸš© ä»¥ä¸‹æ“ä½œåœ¨ k8s-master01 è¿›è¡Œ</p>
</blockquote>
<h5 id="1-ç¼–è¾‘é…ç½®æ–‡ä»¶"><a href="#1-ç¼–è¾‘é…ç½®æ–‡ä»¶" class="headerlink" title="1. ç¼–è¾‘é…ç½®æ–‡ä»¶"></a>1. ç¼–è¾‘é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/nginx/cfg/kube-nginx.conf</code> ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">worker_processes</span> <span class="hljs-number">2</span>;<br> <br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">65525</span>;<br>&#125;<br> <br><span class="hljs-section">stream</span> &#123;<br>    <span class="hljs-attribute">upstream</span> apiserver &#123;<br>        <span class="hljs-attribute">hash</span> $remote_addr consistent;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">172.16.60.231:6443</span>        max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">172.16.60.232:6443</span>        max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">172.16.60.233:6443</span>        max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>    &#125;<br> <br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">8443</span>;<br>        <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">1s</span>;<br>        <span class="hljs-attribute">proxy_pass</span> apiserver;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2-åˆ†å‘é…ç½®æ–‡ä»¶"><a href="#2-åˆ†å‘é…ç½®æ–‡ä»¶" class="headerlink" title="2. åˆ†å‘é…ç½®æ–‡ä»¶"></a>2. åˆ†å‘é…ç½®æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-nginx -S -R root -m copy -a &quot;src=~/kubernetes/nginx/cfg/kube-nginx.conf dest=/data/applications/openresty/nginx/conf/kube-nginx.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h4 id="3ï¼‰åˆ›å»º-nginx-systemd-unit-æ–‡ä»¶"><a href="#3ï¼‰åˆ›å»º-nginx-systemd-unit-æ–‡ä»¶" class="headerlink" title="3ï¼‰åˆ›å»º nginx systemd unit æ–‡ä»¶"></a>3ï¼‰åˆ›å»º nginx systemd unit æ–‡ä»¶</h4><blockquote>
<p>ğŸš© ä»¥ä¸‹æ“ä½œåœ¨ k8s-master01 è¿›è¡Œ</p>
</blockquote>
<h5 id="1-ç¼–è¾‘é…ç½®æ–‡ä»¶-1"><a href="#1-ç¼–è¾‘é…ç½®æ–‡ä»¶-1" class="headerlink" title="1. ç¼–è¾‘é…ç½®æ–‡ä»¶"></a>1. ç¼–è¾‘é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/nginx/systemd/kube-nginx.service</code> ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx">[Unit]<br>Description=kube-<span class="hljs-attribute">apiserver</span> nginx proxy<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br> <br>[Service]<br>Type=forking<br>ExecStartPre=/usr/bin/nginx -c /data/applications/openresty/nginx/conf/kube-nginx.conf -p /data/applications/openresty/nginx -t<br>ExecStart=/usr/bin/nginx -c /data/applications/openresty/nginx/conf/kube-nginx.conf -p /data/applications/openresty/nginx<br>ExecReload=/usr/bin/nginx -c data/applications/openresty/nginx/conf/kube-nginx.conf -p /data/applications/openresty/nginx -s reload<br>PrivateTmp=<span class="hljs-literal">true</span><br>Restart=always<br>RestartSec=<span class="hljs-number">5</span><br>StartLimitInterval=<span class="hljs-number">0</span><br>LimitNOFILE=<span class="hljs-number">65536</span><br> <br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h5 id="2-åˆ†å‘é…ç½®æ–‡ä»¶-1"><a href="#2-åˆ†å‘é…ç½®æ–‡ä»¶-1" class="headerlink" title="2. åˆ†å‘é…ç½®æ–‡ä»¶"></a>2. åˆ†å‘é…ç½®æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-nginx -S -R root -m copy -a &quot;src=~/kubernetes/nginx/systemd/kube-nginx.service dest=/usr/lib/systemd/system/kube-nginx.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h4 id="4ï¼‰å¯åŠ¨-nginx-ä»£ç†"><a href="#4ï¼‰å¯åŠ¨-nginx-ä»£ç†" class="headerlink" title="4ï¼‰å¯åŠ¨ nginx ä»£ç†"></a>4ï¼‰å¯åŠ¨ nginx ä»£ç†</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-nginx -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-nginx -S -R root -m shell -a &quot;systemctl enable kube-nginx.service&quot;<br>ansible k8s-nginx -S -R root -m shell -a &quot;systemctl start kube-nginx.service&quot;<br>ansible k8s-nginx -S -R root -m shell -a &quot;systemctl status kube-nginx.service&quot;<br></code></pre></td></tr></table></figure>



<h4 id="5ï¼‰å®‰è£…-keepalived"><a href="#5ï¼‰å®‰è£…-keepalived" class="headerlink" title="5ï¼‰å®‰è£… keepalived"></a>5ï¼‰å®‰è£… keepalived</h4><blockquote>
<p>ğŸš© ä»¥ä¸‹æ“ä½œåœ¨æ‰€æœ‰ lb èŠ‚ç‚¹è¿›è¡Œ</p>
</blockquote>
<h5 id="1-é…ç½®å†…æ ¸å‚æ•°"><a href="#1-é…ç½®å†…æ ¸å‚æ•°" class="headerlink" title="1. é…ç½®å†…æ ¸å‚æ•°"></a>1. é…ç½®å†…æ ¸å‚æ•°</h5><p>ç¼–è¾‘æ–‡ä»¶ <code>/etc/sysctl.d/kubernetes.conf </code>ï¼Œè¿½åŠ ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">net.ipv4.ip_nonlocal_bind = 1					# å¼€å¯å…è®¸ç»‘å®šéæœ¬æœºIP<br>net.ipv4.conf.lo.arp_announce = 2			# arp ç›¸å…³é…ç½®(lvs çš„ DRã€TUN æ¨¡å¼éœ€è¦)<br>net.ipv4.conf.all.arp_announce = 2<br>net.ipv4.conf.lo.arp_ignore = 1<br>net.ipv4.conf.all.arp_ignore = 1<br></code></pre></td></tr></table></figure>

<h6 id="åŠ è½½é…ç½®"><a href="#åŠ è½½é…ç½®" class="headerlink" title="åŠ è½½é…ç½®:"></a>åŠ è½½é…ç½®:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sysctl -p /etc/sysctl.d/kubernetes.conf <br></code></pre></td></tr></table></figure>

<h5 id="2-éƒ¨ç½²-keepalived"><a href="#2-éƒ¨ç½²-keepalived" class="headerlink" title="2. éƒ¨ç½² keepalived"></a>2. éƒ¨ç½² keepalived</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y keepalived<br></code></pre></td></tr></table></figure>

<h5 id="3-é…ç½®-keepalived-ç‹¬ç«‹æ—¥å¿—"><a href="#3-é…ç½®-keepalived-ç‹¬ç«‹æ—¥å¿—" class="headerlink" title="3. é…ç½® keepalived ç‹¬ç«‹æ—¥å¿—"></a>3. é…ç½® keepalived ç‹¬ç«‹æ—¥å¿—</h5><p>æ–‡ä»¶è·¯å¾„: <code>/etc/sysconfig/keepalived</code>ï¼Œä¿®æ”¹ <code>KEEPALIVED_OPTIONS</code> é…ç½®</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sed -i &#x27;s/&quot;-D&quot;/&quot;-D -d -S 0&quot;/g&#x27; /etc/sysconfig/keepalived <br></code></pre></td></tr></table></figure>

<p>æ–‡ä»¶è·¯å¾„: <code>/etc/rsyslog.conf </code>ï¼Œæœ«å°¾è¿½åŠ é…ç½®</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo &quot;local0.*                                                 /var/log/keepalived.log&quot; &gt;&gt; /etc/rsyslog.conf<br></code></pre></td></tr></table></figure>

<h5 id="4-é…ç½®-keepalived-æ—¥å¿—åˆ‡å‰²"><a href="#4-é…ç½®-keepalived-æ—¥å¿—åˆ‡å‰²" class="headerlink" title="4. é…ç½® keepalived æ—¥å¿—åˆ‡å‰²"></a>4. é…ç½® keepalived æ—¥å¿—åˆ‡å‰²</h5><p>æ–‡ä»¶è·¯å¾„: <code>/etc/logrotate.d/keepalived</code>ï¼Œç¼–è¾‘ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">/var/log/keepalived.log &#123;<br>    daily<br>    missingok<br>    dateext<br>    rotate 7<br>    create 0600 root root<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="5-é‡å¯-rsyslog-æœåŠ¡"><a href="#5-é‡å¯-rsyslog-æœåŠ¡" class="headerlink" title="5. é‡å¯ rsyslog æœåŠ¡"></a>5. é‡å¯ rsyslog æœåŠ¡</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl restart rsyslog.service <br></code></pre></td></tr></table></figure>



<h4 id="6ï¼‰åˆ›å»º-keepalived-é…ç½®æ–‡ä»¶"><a href="#6ï¼‰åˆ›å»º-keepalived-é…ç½®æ–‡ä»¶" class="headerlink" title="6ï¼‰åˆ›å»º keepalived é…ç½®æ–‡ä»¶"></a>6ï¼‰åˆ›å»º keepalived é…ç½®æ–‡ä»¶</h4><h5 id="1-ç¼–è¾‘-master-é…ç½®æ–‡ä»¶"><a href="#1-ç¼–è¾‘-master-é…ç½®æ–‡ä»¶" class="headerlink" title="1. ç¼–è¾‘ master é…ç½®æ–‡ä»¶"></a>1. ç¼–è¾‘ master é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/nginx/cfg/keepalived-master.conf</code> ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell">! Configuration File for keepalived    <br>   <br>global_defs &#123;<br>		router_id master<br>		<br>    script_user root<br>    enable_script_security  <br>&#125;<br>   <br>vrrp_script chk_http_port &#123;     <br>    script &quot;/etc/keepalived/chk_nginx.sh&quot; <br>    interval 2                  <br>    weight -5                  <br>    fall 2              <br>    rise 1                 <br>&#125;<br>   <br>vrrp_instance VI_1 &#123;   <br>    state MASTER   <br>    interface eth0     <br>    virtual_router_id 51        <br>    priority 101               <br>    advert_int 1                <br>    authentication &#123;           <br>        auth_type PASS         <br>        auth_pass kubernetes         <br>    &#125;<br>    <br>    virtual_ipaddress &#123;       <br>        192.168.3.230 dev eth0 label eth0:1<br>    &#125;<br>  <br>		track_script &#123;                     <br>		   chk_http_port                   <br>		&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="2-ç¼–è¾‘-backup-é…ç½®æ–‡ä»¶"><a href="#2-ç¼–è¾‘-backup-é…ç½®æ–‡ä»¶" class="headerlink" title="2. ç¼–è¾‘ backup é…ç½®æ–‡ä»¶"></a>2. ç¼–è¾‘ backup é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/nginx/cfg/keepalived-backup.conf</code> ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell">! Configuration File for keepalived    <br>   <br>global_defs &#123;<br>		router_id backup<br>		<br>    script_user root<br>    enable_script_security  <br>&#125;<br>   <br>vrrp_script chk_http_port &#123;     <br>    script &quot;/etc/keepalived/chk_nginx.sh&quot; <br>    interval 2                  <br>    weight -5                  <br>    fall 2              <br>    rise 1                 <br>&#125;<br>   <br>vrrp_instance VI_1 &#123;   <br>    state BACKUP   <br>    interface eth0     <br>    virtual_router_id 50     <br>    priority 99               <br>    advert_int 1                <br>    authentication &#123;           <br>        auth_type PASS         <br>        auth_pass kubernetes         <br>    &#125;<br>    <br>    virtual_ipaddress &#123;       <br>        192.168.3.230 dev eth0 label eth0:1<br>    &#125;<br>  <br>		track_script &#123;                     <br>		   chk_http_port                   <br>		&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="3-ç¼–è¾‘-nginx-ç›‘æ§è„šæœ¬"><a href="#3-ç¼–è¾‘-nginx-ç›‘æ§è„šæœ¬" class="headerlink" title="3. ç¼–è¾‘ nginx ç›‘æ§è„šæœ¬"></a>3. ç¼–è¾‘ nginx ç›‘æ§è„šæœ¬</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/nginx/cfg/chk_nginx.sh</code> ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>counter=$(ps -ef|grep -w kube-nginx|grep -v grep|wc -l)<br>if [ &quot;$&#123;counter&#125;&quot; = &quot;0&quot; ]; then<br>    systemctl restart kube-nginx<br>    sleep 2<br>    counter=$(ps -ef|grep kube-nginx|grep -v grep|wc -l)<br>    if [ &quot;$&#123;counter&#125;&quot; = &quot;0&quot; ]; then<br>        systemctl stop keepalived<br>    fi<br>fi<br></code></pre></td></tr></table></figure>



<h5 id="4-åˆ†å‘é…ç½®æ–‡ä»¶"><a href="#4-åˆ†å‘é…ç½®æ–‡ä»¶" class="headerlink" title="4. åˆ†å‘é…ç½®æ–‡ä»¶"></a>4. åˆ†å‘é…ç½®æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> master é…ç½®æ–‡ä»¶åˆ†å‘åˆ° lb01</span><br>ansible k8s-lb01 -S -R root -m copy -a &quot;src=~/kubernetes/nginx/cfg/keepalived-master.conf dest=/etc/keepalived/keepalived.conf owner=root group=root mode=0644&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> backend é…ç½®æ–‡ä»¶åˆ†å‘åˆ° lb02</span><br>ansible k8s-lb02 -S -R root -m copy -a &quot;src=~/kubernetes/nginx/cfg/keepalived-backup.conf dest=/etc/keepalived/keepalived.conf owner=root group=root mode=0644&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> ç›‘æ§è„šæœ¬åˆ†å‘åˆ° 2ä¸ªèŠ‚ç‚¹</span><br>ansible k8s-nginx -S -R root -m copy -a &quot;src=~/kubernetes/nginx/cfg/chk_nginx.sh dest=/etc/keepalived/chk_nginx.sh owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>





<h4 id="7ï¼‰åˆ›å»º-keepalived-systemd-unit-é…ç½®æ–‡ä»¶"><a href="#7ï¼‰åˆ›å»º-keepalived-systemd-unit-é…ç½®æ–‡ä»¶" class="headerlink" title="7ï¼‰åˆ›å»º keepalived systemd unit é…ç½®æ–‡ä»¶"></a>7ï¼‰åˆ›å»º keepalived systemd unit é…ç½®æ–‡ä»¶</h4><h5 id="1-ç¼–è¾‘é…ç½®æ–‡ä»¶-2"><a href="#1-ç¼–è¾‘é…ç½®æ–‡ä»¶-2" class="headerlink" title="1. ç¼–è¾‘é…ç½®æ–‡ä»¶"></a>1. ç¼–è¾‘é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/nginx/systemd/keepalived.service</code> ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=LVS and VRRP High Availability Monitor<br>After=syslog.target network-online.target<br><br>[Service]<br>Type=forking<br>PIDFile=/var/run/keepalived.pid<br>KillMode=process<br>EnvironmentFile=-/etc/sysconfig/keepalived<br>ExecStart=/usr/sbin/keepalived $KEEPALIVED_OPTIONS<br>ExecReload=/bin/kill -HUP $MAINPID<br><br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h5 id="2-åˆ†å‘é…ç½®æ–‡ä»¶-2"><a href="#2-åˆ†å‘é…ç½®æ–‡ä»¶-2" class="headerlink" title="2. åˆ†å‘é…ç½®æ–‡ä»¶"></a>2. åˆ†å‘é…ç½®æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-nginx -S -R root -m copy -a &quot;src=~/kubernetes/nginx/systemd/keepalived.service dest=/usr/lib/systemd/system/keepalived.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h4 id="8ï¼‰å¯åŠ¨-keepalived-HA"><a href="#8ï¼‰å¯åŠ¨-keepalived-HA" class="headerlink" title="8ï¼‰å¯åŠ¨ keepalived HA"></a>8ï¼‰å¯åŠ¨ keepalived HA</h4><h5 id="1-æ‰¹é‡å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯"><a href="#1-æ‰¹é‡å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯" class="headerlink" title="1. æ‰¹é‡å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯"></a>1. æ‰¹é‡å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-nginx -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-nginx -S -R root -m shell -a &quot;systemctl enable keepalived.service&quot;<br>ansible k8s-nginx -S -R root -m shell -a &quot;systemctl start keepalived.service&quot;<br>ansible k8s-nginx -S -R root -m shell -a &quot;systemctl status keepalived.service&quot;<br></code></pre></td></tr></table></figure>

<h5 id="2-éªŒè¯-vip-çŠ¶æ€"><a href="#2-éªŒè¯-vip-çŠ¶æ€" class="headerlink" title="2. éªŒè¯ vip çŠ¶æ€"></a>2. éªŒè¯ vip çŠ¶æ€</h5><blockquote>
<p>ğŸš© ç”±äº master èŠ‚ç‚¹çš„çš„æƒé‡é«˜ï¼Œæ‰€ä»¥ vip é»˜è®¤ä¼šèµ·åœ¨ master èŠ‚ç‚¹ä¸Šï¼Œåœ¨ k8s-lb01 æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤:</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ifconfig <br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500<br>        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255<br>        ether 02:42:86:cf:0e:ee  txqueuelen 0  (Ethernet)<br>        RX packets 0  bytes 0 (0.0 B)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 0  bytes 0 (0.0 B)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 192.168.3.235  netmask 255.255.255.0  broadcast 192.168.3.255<br>        ether 00:50:56:b0:b7:c1  txqueuelen 1000  (Ethernet)<br>        RX packets 4501804  bytes 410256599 (391.2 MiB)<br>        RX errors 0  dropped 259641  overruns 0  frame 0<br>        TX packets 51487  bytes 4490345 (4.2 MiB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>eth0:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 192.168.3.230  netmask 255.255.255.255  broadcast 0.0.0.0<br>        ether 00:50:56:b0:b7:c1  txqueuelen 1000  (Ethernet)<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 0  bytes 0 (0.0 B)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 0  bytes 0 (0.0 B)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>ç”±äºæˆ‘ä»¬ç»™ vip ç»‘å®šåšäº†åˆ«åï¼Œæ•…è¿™è¾¹å¯ä»¥çœ‹åˆ° <code>eth0:1</code> çš„è™šæ‹Ÿç½‘å¡ï¼Œè¯æ˜ vip çš„ç¡®èµ·åœ¨ master èŠ‚ç‚¹ä¸Šäº†</p>
</blockquote>
<h3 id="5ã€éƒ¨ç½²-Kubernetes-master-èŠ‚ç‚¹"><a href="#5ã€éƒ¨ç½²-Kubernetes-master-èŠ‚ç‚¹" class="headerlink" title="5ã€éƒ¨ç½² Kubernetes master èŠ‚ç‚¹"></a>5ã€éƒ¨ç½² Kubernetes master èŠ‚ç‚¹</h3><blockquote>
<p>ğŸŒˆ <strong>å…³äº master èŠ‚ç‚¹</strong></p>
<p>éƒ¨ç½²åœ¨ master èŠ‚ç‚¹çš„å¿…è¦ç»„ä»¶æœ‰ <code>kube-apiserver</code>ã€<code>kube-scheduler</code> å’Œ <code>kube-controller-manager</code> ï¼Œå‡ä¸ºå¤šå®ä¾‹æ¨¡å¼è¿è¡Œã€‚</p>
</blockquote>
<h4 id="1ï¼‰éƒ¨ç½²-kube-apiserver"><a href="#1ï¼‰éƒ¨ç½²-kube-apiserver" class="headerlink" title="1ï¼‰éƒ¨ç½² kube-apiserver"></a>1ï¼‰éƒ¨ç½² kube-apiserver</h4><p><strong>åŸºç¡€ç»„ä»¶ä»‹ç» â€”â€” kube-apiserver:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-kube-apiserver/">ä¼ é€é—¨</a></p>
<blockquote>
<p>ğŸš© è¿™é‡Œéƒ¨ç½²çš„æ˜¯ä¸€ä¸ªä¸‰å®ä¾‹çš„ kube-apiserver é›†ç¾¤ç¯å¢ƒï¼Œkube-apiserver æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šè¿‡ nginx å››å±‚ä»£ç†è¿›è¡Œè®¿é—®ï¼Œå¹¶å¯¹å¤–æä¾›ç»Ÿä¸€çš„ vip åœ°å€ï¼Œä»¥æ­¤æ¥ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</p>
<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨ k8s-master01 ä¸Šè¿›è¡Œï¼Œç„¶åå†é€šè¿‡æ‰¹ç®¡ç†å·¥å…·åˆ†å‘è‡³å…¶ä»–èŠ‚ç‚¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</strong></p>
</blockquote>
<h5 id="1-åˆ›å»º-TLS-Bootstrap-è®¤è¯-token-æ–‡ä»¶"><a href="#1-åˆ›å»º-TLS-Bootstrap-è®¤è¯-token-æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º TLS Bootstrap è®¤è¯ token æ–‡ä»¶"></a>1. åˆ›å»º TLS Bootstrap è®¤è¯ token æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> ç”Ÿæˆä¸€ä¸ªåŠ å¯†token</span><br>export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;) <br><span class="hljs-meta">#</span><span class="bash"> åˆ›å»º tokenæ–‡ä»¶</span><br>cat &gt; ~/kubernetes/server/cfg/token.csv &lt;&lt;EOF<br><span class="hljs-meta">$</span><span class="bash">&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,<span class="hljs-string">&quot;system:node-bootstrap&quot;</span></span><br>EOF<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸŒˆ tokenæ–‡ä»¶çš„æ ¼å¼ä¸º token,ç”¨æˆ·,uid,ç”¨æˆ·ç»„</p>
</blockquote>
<h6 id="åˆ†å‘-token-è‡³å„-master-èŠ‚ç‚¹"><a href="#åˆ†å‘-token-è‡³å„-master-èŠ‚ç‚¹" class="headerlink" title="åˆ†å‘ token è‡³å„ master èŠ‚ç‚¹"></a>åˆ†å‘ token è‡³å„ master èŠ‚ç‚¹</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/cfg/token.csv dest=/data/applications/kubernetes/cfg/token.csv owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="2-åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"><a href="#2-åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶" class="headerlink" title="2. åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"></a>2. åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/kubernetes/server/cfg/audit-policy.yaml &lt;&lt;EOF<br>apiVersion: audit.k8s.io/v1beta1<br>kind: Policy<br>rules:<br><span class="hljs-meta">  #</span><span class="bash"> The following requests were manually identified as high-volume and low-risk, so drop them.</span><br>  - level: None<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - endpoints<br>          - services<br>          - services/status<br>    users:<br>      - &#x27;system:kube-proxy&#x27;<br>    verbs:<br>      - watch<br>   <br>  - level: None<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - nodes<br>          - nodes/status<br>    userGroups:<br>      - &#x27;system:nodes&#x27;<br>    verbs:<br>      - get<br>   <br>  - level: None<br>    namespaces:<br>      - kube-system<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - endpoints<br>    users:<br>      - &#x27;system:kube-controller-manager&#x27;<br>      - &#x27;system:kube-scheduler&#x27;<br>      - &#x27;system:serviceaccount:kube-system:endpoint-controller&#x27;<br>    verbs:<br>      - get<br>      - update<br>   <br>  - level: None<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - namespaces<br>          - namespaces/status<br>          - namespaces/finalize<br>    users:<br>      - &#x27;system:apiserver&#x27;<br>    verbs:<br>      - get<br>   <br><span class="hljs-meta">  #</span><span class="bash"> Don<span class="hljs-string">&#x27;t log HPA fetching metrics.</span></span><br>  - level: None<br>    resources:<br>      - group: metrics.k8s.io<br>    users:<br>      - &#x27;system:kube-controller-manager&#x27;<br>    verbs:<br>      - get<br>      - list<br>   <br><span class="hljs-meta">  #</span><span class="bash"><span class="hljs-string"> Don&#x27;</span>t <span class="hljs-built_in">log</span> these read-only URLs.</span><br>  - level: None<br>    nonResourceURLs:<br>      - &#x27;/healthz*&#x27;<br>      - /version<br>      - &#x27;/swagger*&#x27;<br>   <br><span class="hljs-meta">  #</span><span class="bash"> Don<span class="hljs-string">&#x27;t log events requests.</span></span><br>  - level: None<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - events<br>   <br><span class="hljs-meta">  #</span><span class="bash"><span class="hljs-string"> node and pod status calls from nodes are high-volume and can be large, don&#x27;</span>t <span class="hljs-built_in">log</span> responses <span class="hljs-keyword">for</span> expected updates from nodes</span><br>  - level: Request<br>    omitStages:<br>      - RequestReceived<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - nodes/status<br>          - pods/status<br>    users:<br>      - kubelet<br>      - &#x27;system:node-problem-detector&#x27;<br>      - &#x27;system:serviceaccount:kube-system:node-problem-detector&#x27;<br>    verbs:<br>      - update<br>      - patch<br>   <br>  - level: Request<br>    omitStages:<br>      - RequestReceived<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - nodes/status<br>          - pods/status<br>    userGroups:<br>      - &#x27;system:nodes&#x27;<br>    verbs:<br>      - update<br>      - patch<br>   <br><span class="hljs-meta">  #</span><span class="bash"> deletecollection calls can be large, don<span class="hljs-string">&#x27;t log responses for expected namespace deletions</span></span><br>  - level: Request<br>    omitStages:<br>      - RequestReceived<br>    users:<br>      - &#x27;system:serviceaccount:kube-system:namespace-controller&#x27;<br>    verbs:<br>      - deletecollection<br>   <br><span class="hljs-meta">  #</span><span class="bash"><span class="hljs-string"> Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span><br><span class="hljs-meta">  #</span><span class="bash"><span class="hljs-string"> so only log at the Metadata level.</span></span><br>  - level: Metadata<br>    omitStages:<br>      - RequestReceived<br>    resources:<br>      - group: &quot;&quot;<br>        resources:<br>          - secrets<br>          - configmaps<br>      - group: authentication.k8s.io<br>        resources:<br>          - tokenreviews<br><span class="hljs-meta">  #</span><span class="bash"><span class="hljs-string"> Get repsonses can be large; skip them.</span></span><br>  - level: Request<br>    omitStages:<br>      - RequestReceived<br>    resources:<br>      - group: &quot;&quot;<br>      - group: admissionregistration.k8s.io<br>      - group: apiextensions.k8s.io<br>      - group: apiregistration.k8s.io<br>      - group: apps<br>      - group: authentication.k8s.io<br>      - group: authorization.k8s.io<br>      - group: autoscaling<br>      - group: batch<br>      - group: certificates.k8s.io<br>      - group: extensions<br>      - group: metrics.k8s.io<br>      - group: networking.k8s.io<br>      - group: policy<br>      - group: rbac.authorization.k8s.io<br>      - group: scheduling.k8s.io<br>      - group: settings.k8s.io<br>      - group: storage.k8s.io<br>    verbs:<br>      - get<br>      - list<br>      - watch<br>   <br><span class="hljs-meta">  #</span><span class="bash"><span class="hljs-string"> Default level for known APIs</span></span><br>  - level: RequestResponse<br>    omitStages:<br>      - RequestReceived<br>    resources:<br>      - group: &quot;&quot;<br>      - group: admissionregistration.k8s.io<br>      - group: apiextensions.k8s.io<br>      - group: apiregistration.k8s.io<br>      - group: apps<br>      - group: authentication.k8s.io<br>      - group: authorization.k8s.io<br>      - group: autoscaling<br>      - group: batch<br>      - group: certificates.k8s.io<br>      - group: extensions<br>      - group: metrics.k8s.io<br>      - group: networking.k8s.io<br>      - group: policy<br>      - group: rbac.authorization.k8s.io<br>      - group: scheduling.k8s.io<br>      - group: settings.k8s.io<br>      - group: storage.k8s.io<br>         <br><span class="hljs-meta">  #</span><span class="bash"><span class="hljs-string"> Default level for all other requests.</span></span><br>  - level: Metadata<br>    omitStages:<br>      - RequestReceived<br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘å®¡è®¡ç­–ç•¥æ–‡ä»¶"><a href="#åˆ†å‘å®¡è®¡ç­–ç•¥æ–‡ä»¶" class="headerlink" title="åˆ†å‘å®¡è®¡ç­–ç•¥æ–‡ä»¶:"></a>åˆ†å‘å®¡è®¡ç­–ç•¥æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/cfg/audit-policy.yaml dest=/data/applications/kubernetes/cfg/audit-policy.yaml owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="3-åˆ›å»º-kube-apiserver-é…ç½®æ–‡ä»¶"><a href="#3-åˆ›å»º-kube-apiserver-é…ç½®æ–‡ä»¶" class="headerlink" title="3. åˆ›å»º kube-apiserver é…ç½®æ–‡ä»¶"></a>3. åˆ›å»º kube-apiserver é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/server/cfg/kube-apiserver.conf</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹: (èŠ‚ç‚¹IPæ ¹æ®å®é™…æƒ…å†µæ›¿æ¢)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_APISERVER_OPTS=&quot;--advertise-address=192.168.3.231 \<br>--bind-address=192.168.3.231 \<br>--secure-port=6443 \<br>--insecure-port=8080 \<br>--service-cluster-ip-range=10.0.0.0/16 \<br>--service-node-port-range=30000-50000 \<br>--default-not-ready-toleration-seconds=360 \<br>--default-unreachable-toleration-seconds=360 \<br>--feature-gates=DynamicAuditing=true \<br>--max-mutating-requests-inflight=2000 \<br>--max-requests-inflight=4000 \<br>--default-watch-cache-size=200 \<br>--delete-collection-workers=2 \<br>--etcd-cafile=/data/applications/etcd/ssl/ca.pem \<br>--etcd-certfile=/data/applications/etcd/ssl/server.pem \<br>--etcd-keyfile=/data/applications/etcd/ssl/server-key.pem \<br>--etcd-servers=https://192.168.3.231:2379,https://192.168.3.232:2379,https://192.168.3.233:2379 \<br>--tls-cert-file=/data/applications/kubernetes/ssl/server.pem  \<br>--tls-private-key-file=/data/applications/kubernetes/ssl/server-key.pem \<br>--client-ca-file=/data/applications/kubernetes/ssl/ca.pem \<br>--service-account-key-file=/data/applications/kubernetes/ssl/ca-key.pem \<br>--audit-log-maxage=30 \<br>--audit-log-maxbackup=3 \<br>--audit-log-maxsize=100 \<br>--audit-log-mode=batch \<br>--audit-log-truncate-enabled \<br>--audit-log-batch-buffer-size=20000 \<br>--audit-log-batch-max-size=2 \<br>--audit-log-path=/data/applications/kubernetes/logs/k8s-audit.log \<br>--audit-policy-file=/data/applications/kubernetes/cfg/audit-policy.yaml \<br>--profiling \<br>--enable-bootstrap-token-auth=true \<br>--token-auth-file=/data/applications/kubernetes/cfg/token.csv \<br>--authorization-mode=RBAC,Node \<br>--runtime-config=api/all=true \<br>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \<br>--allow-privileged=true \<br>--apiserver-count=3 \<br>--event-ttl=168h \<br>--kubelet-certificate-authority=/data/applications/kubernetes/ssl/ca.pem \<br>--kubelet-client-certificate=/data/applications/kubernetes/ssl/server.pem \<br>--kubelet-client-key=/data/applications/kubernetes/ssl/server-key.pem \<br>--kubelet-https=true \<br>--kubelet-timeout=10s \<br>--proxy-client-cert-file=/data/applications/kubernetes/ssl/metrics-server.pem \<br>--proxy-client-key-file=/data/applications/kubernetes/ssl/metrics-server-key.pem \<br>--logtostderr=true \<br>--log-dir=/data/applications/kubernetes/logs \<br>--v=2 \<br>--enable-aggregator-routing=true&quot;<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-5"><a href="#é…ç½®å‚æ•°è¯´æ˜-5" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th>é…ç½®å‚æ•°</th>
<th>å‚æ•°è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/cfg/kube-apiserver.conf dest=/data/applications/kubernetes/cfg/kube-apiserver.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>âš ï¸ <strong>æ³¨æ„</strong></p>
<p>åˆ†å‘åè¦ä¿®æ”¹å¯¹åº”èŠ‚ç‚¹çš„ <code>advertise-address</code> å’Œ <code>bind-address</code></p>
</blockquote>
<h5 id="4-åˆ›å»º-systemd-unit-æ–‡ä»¶"><a href="#4-åˆ›å»º-systemd-unit-æ–‡ä»¶" class="headerlink" title="4. åˆ›å»º systemd unit æ–‡ä»¶"></a>4. åˆ›å»º systemd unit æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/server/systemd/kube-apiserver.service</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Kubernetes API Server<br>Documentation=https://github.com/kubernetes/kubernetes<br>After=network.target<br>After=etcd.service<br>Wants=etcd.service<br><br>[Service]<br>EnvironmentFile=/data/application/kubernetes/cfg/kube-apiserver.conf<br>ExecStart=/data/applications/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS<br>Restart=on-failure<br>RestartSec=10<br>Type=notify<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘-systemd-æ–‡ä»¶"><a href="#åˆ†å‘-systemd-æ–‡ä»¶" class="headerlink" title="åˆ†å‘ systemd æ–‡ä»¶:"></a>åˆ†å‘ systemd æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/systemd/kube-apiserver.service dest=/usr/lib/systemd/system/kube-apiserver.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="5-å¯åŠ¨-kube-apiserver-é›†ç¾¤"><a href="#5-å¯åŠ¨-kube-apiserver-é›†ç¾¤" class="headerlink" title="5. å¯åŠ¨ kube-apiserver é›†ç¾¤"></a>5. å¯åŠ¨ kube-apiserver é›†ç¾¤</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl enable kube-apiserver.service&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl start kube-apiserver.service&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl status kube-apiserver.service&quot;<br></code></pre></td></tr></table></figure>

<h5 id="6-éªŒè¯kube-apiserver-é›†ç¾¤çŠ¶æ€"><a href="#6-éªŒè¯kube-apiserver-é›†ç¾¤çŠ¶æ€" class="headerlink" title="6. éªŒè¯kube-apiserver é›†ç¾¤çŠ¶æ€"></a>6. éªŒè¯kube-apiserver é›†ç¾¤çŠ¶æ€</h5><h6 id="1âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯"><a href="#1âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯" class="headerlink" title="1âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯:"></a>1âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl cluster-info<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">Kubernetes master is running at https://192.168.3.230:8443<br><br>To further debug and diagnose cluster problems, use &#x27;kubectl cluster-info dump&#x27;.<br></code></pre></td></tr></table></figure>

<h6 id="2âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰å†…å®¹"><a href="#2âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰å†…å®¹" class="headerlink" title="2âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰å†…å®¹:"></a>2âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰å†…å®¹:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get all --all-namespaces<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>default     service/kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   49m<br></code></pre></td></tr></table></figure>

<h6 id="3âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯"><a href="#3âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯" class="headerlink" title="3âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯:"></a>3âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get componentstatuses # æˆ–æ‰§è¡Œ kubectl get cs<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME                 STATUS      MESSAGE                                                                                     ERROR<br>scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused   <br>controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused   <br>etcd-0               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                                           <br>etcd-2               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                                           <br>etcd-1               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;    <br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸš© æ­¤æ—¶è¿˜æ²¡æœ‰éƒ¨ç½² <code>controller-managerhe</code> å’Œ <code>schedule</code> è¿™ä¸¤ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥çŠ¶æ€ä¸º Unhealthyï¼Œå¾…åç»­éƒ¨ç½²å¥½ä¹‹åå†æŸ¥çœ‹ã€‚</p>
</blockquote>
<h5 id="7-æŸ¥çœ‹-kube-apiserver-å†™å…¥-etcd-ä¸­çš„æ•°æ®"><a href="#7-æŸ¥çœ‹-kube-apiserver-å†™å…¥-etcd-ä¸­çš„æ•°æ®" class="headerlink" title="7. æŸ¥çœ‹ kube-apiserver å†™å…¥ etcd ä¸­çš„æ•°æ®"></a>7. æŸ¥çœ‹ kube-apiserver å†™å…¥ etcd ä¸­çš„æ•°æ®</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">ETCDCTL_API=3 /data/applications/etcd/bin/etcdctl \<br>--endpoints=https://192.168.3.231:2379,https://192.168.3.232:2379,https://192.168.3.233:2379 \<br>--cacert=/data/applications/etcd/ssl/ca.pem \<br>--cert=/data/applications/etcd/ssl/server.pem \<br>--key=/data/applications/etcd/ssl/server-key.pem \<br>get /registry/ --prefix --keys-only<br></code></pre></td></tr></table></figure>



<h5 id="8-æˆæƒ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™"><a href="#8-æˆæƒ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™" class="headerlink" title="8. æˆæƒ kube-apiserver è®¿é—® kubelet API çš„æƒé™"></a>8. æˆæƒ kube-apiserver è®¿é—® kubelet API çš„æƒé™</h5><blockquote>
<p>ğŸš© åœ¨æ‰§è¡Œ kubectl execã€runã€logs ç­‰å‘½ä»¤æ—¶ï¼Œapiserver ä¼šå°†è¯·æ±‚è½¬å‘åˆ° kubelet çš„ https ç«¯å£ï¼Œå› æ­¤åœ¨è¿™è¾¹å®šä¹‰ RBAC è§„åˆ™ï¼Œæˆæƒ apiserver ä½¿ç”¨è¯ä¹¦ï¼ˆserver.pemï¼‰ç”¨æˆ·åï¼ˆkubernetesï¼‰è®¿é—® kubelet API çš„æƒé™ã€‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes<br></code></pre></td></tr></table></figure>



<h4 id="2ï¼‰éƒ¨ç½²-kube-controller-manager"><a href="#2ï¼‰éƒ¨ç½²-kube-controller-manager" class="headerlink" title="2ï¼‰éƒ¨ç½² kube-controller-manager"></a>2ï¼‰éƒ¨ç½² kube-controller-manager</h4><p><strong>åŸºç¡€ç»„ä»¶ä»‹ç» â€”â€” kube-controller-manager:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-kube-controller-manager/">ä¼ é€é—¨</a></p>
<blockquote>
<p>ğŸš© è¿™é‡Œéƒ¨ç½²çš„æ˜¯ä¸€ä¸ªä¸‰å®ä¾‹çš„ kube-controller-manager é›†ç¾¤ï¼Œå¯åŠ¨åä¼šé€šè¿‡é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leaderï¼ˆç±»ä¼¼ consul æˆ– etcdçš„æœºåˆ¶ï¼‰ï¼Œå…¶ä»–èŠ‚ç‚¹å¤„äºå µå¡çŠ¶æ€ï¼Œå½“ leader èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œå‰©ä½™çš„å µå¡èŠ‚ç‚¹ä¼šå†æ¬¡é€‰ä¸¾äº§ç”Ÿæ–°çš„ leaderï¼Œä»çƒ­ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ã€‚</p>
<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨ k8s-master01 ä¸Šè¿›è¡Œï¼Œç„¶åå†é€šè¿‡æ‰¹ç®¡ç†å·¥å…·åˆ†å‘è‡³å…¶ä»–èŠ‚ç‚¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</strong></p>
</blockquote>
<h5 id="1-åˆ›å»º-kube-controller-manager-é…ç½®æ–‡ä»¶"><a href="#1-åˆ›å»º-kube-controller-manager-é…ç½®æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º kube-controller-manager é…ç½®æ–‡ä»¶"></a>1. åˆ›å»º kube-controller-manager é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/server/cfg/kube-controller-manager.conf</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--v=2 \<br>--logtostderr=true \<br>--log-dir=/data/applications/kubernetes/logs \<br>--profiling \<br>--cluster-name=kubernetes \<br>--bind-address=127.0.0.1 \<br>--master=127.0.0.1:8080 \<br>--service-cluster-ip-range=10.0.0.0/16 \<br>--cluster-cidr=10.244.0.0/16 \<br>--allocate-node-cidrs=true \<br>--cluster-signing-cert-file=/data/applications/kubernetes/ssl/ca.pem \<br>--cluster-signing-key-file=/data/applications/kubernetes/ssl/ca-key.pem  \<br>--service-account-private-key-file=/data/applications/kubernetes/ssl/ca-key.pem \<br>--root-ca-file=/data/applications/kubernetes/ssl/ca.pem \<br>--controllers=*,bootstrapsigner,tokencleaner \<br>--kube-api-qps=1000 \<br>--kube-api-burst=2000 \<br>--leader-elect=true \<br>--use-service-account-credentials=true \<br>--horizontal-pod-autoscaler-sync-period=10s \<br>--concurrent-service-syncs=2 \<br>--concurrent-deployment-syncs=10 \<br>--concurrent-gc-syncs=30 \<br>--node-cidr-mask-size=24 \<br>--pod-eviction-timeout=6m \<br>--terminated-pod-gc-threshold=10000 \<br>--experimental-cluster-signing-duration=87600h0m0s \<br>--feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true&quot;<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-6"><a href="#é…ç½®å‚æ•°è¯´æ˜-6" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶ï¼š"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶ï¼š" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶ï¼š"></a>åˆ†å‘é…ç½®æ–‡ä»¶ï¼š</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/cfg/kube-controller-manager.conf dest=/data/applications/kubernetes/cfg/kube-controller-manager.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="2-åˆ›å»º-systemd-unit-æ–‡ä»¶"><a href="#2-åˆ›å»º-systemd-unit-æ–‡ä»¶" class="headerlink" title="2. åˆ›å»º systemd unit æ–‡ä»¶"></a>2. åˆ›å»º systemd unit æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/server/systemd/kube-controller-manager.service</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Kubernetes Controller Manager<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/data/applications/kubernetes/cfg/kube-controller-manager.conf<br>ExecStart=/data/applications/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS<br>Restart=on-failure<br>RestartSec=5<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-1"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-1" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/systemd/kube-controller-manager.service dest=/usr/lib/systemd/system/kube-controller-manager.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="3-å¯åŠ¨-kube-controller-manager-é›†ç¾¤"><a href="#3-å¯åŠ¨-kube-controller-manager-é›†ç¾¤" class="headerlink" title="3. å¯åŠ¨ kube-controller-manager é›†ç¾¤"></a>3. å¯åŠ¨ kube-controller-manager é›†ç¾¤</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl enable kube-controller-manager.service&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl start kube-controller-manager.service&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl status kube-controller-manager.service&quot;<br></code></pre></td></tr></table></figure>



<h5 id="4-éªŒè¯-kube-controller-manager-é›†ç¾¤çŠ¶æ€"><a href="#4-éªŒè¯-kube-controller-manager-é›†ç¾¤çŠ¶æ€" class="headerlink" title="4. éªŒè¯ kube-controller-manager é›†ç¾¤çŠ¶æ€"></a>4. éªŒè¯ kube-controller-manager é›†ç¾¤çŠ¶æ€</h5><h6 id="1âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯"><a href="#1âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯" class="headerlink" title="1âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯:"></a>1âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get componentstatuses # æˆ–æ‰§è¡Œ kubectl get cs<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME                 STATUS      MESSAGE                                                                                     ERROR<br>scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused   <br>controller-manager   Healthy     ok                                                                                          <br>etcd-0               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                                           <br>etcd-1               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                                           <br>etcd-2               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125; <br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸš© æ£€æŸ¥é›†ç¾¤çŠ¶æ€ï¼Œcontroller-managerçš„çŠ¶æ€ä¸ºâ€okâ€</p>
<p>å½“ <code>kube-controller-manager</code> é›†ç¾¤ä¸­çš„1ä¸ªæˆ–2ä¸ªèŠ‚ç‚¹çš„ <code>controller-manager</code> æœåŠ¡æŒ‚æ‰ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„ <code>controller-manager</code> æœåŠ¡æ´»ç€ï¼Œåˆ™é›†ç¾¤ä¸­ <code>controller-manager</code> çš„çŠ¶æ€ä»ç„¶ä¸º <strong>â€œokâ€</strong> ,ä»ç„¶ä¼šç»§ç»­æä¾›æœåŠ¡ï¼</p>
</blockquote>
<h6 id="2âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£"><a href="#2âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£" class="headerlink" title="2âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:"></a>2âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">netstat -lntp | grep kube-controller <br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">tcp        0      0 127.0.0.1:10257         0.0.0.0:*               LISTEN      494/kube-controller <br>tcp6       0      0 :::10252                :::*                    LISTEN      494/kube-controller <br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸŒˆ kube-controller-manager ç›‘å¬ç«¯å£ä¸º 10252 å’Œ 10257</p>
<p><code>10257</code>ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œéå®‰å…¨ç«¯å£ï¼Œä¸éœ€è¦è®¤è¯æˆæƒï¼›<br><code>10252</code>ï¼šæ¥æ”¶ https è¯·æ±‚ï¼Œå®‰å…¨ç«¯å£ï¼Œéœ€è¦è®¤è¯æˆæƒï¼›<br>ä¸¤ä¸ªæ¥å£éƒ½å¯¹å¤–æä¾› <code>/metrics</code> å’Œ <code>/healthz</code> çš„è®¿é—®ã€‚</p>
</blockquote>
<h6 id="3âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„-leader"><a href="#3âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„-leader" class="headerlink" title="3âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„ leader:"></a>3âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„ leader:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get endpoints kube-controller-manager --namespace=kube-system  -o yaml<br></code></pre></td></tr></table></figure>

<p>è¿”å›å¦‚ä¸‹ï¼Œå¯è§å½“ç„¶ leader ä¸º <code>k8s-master01</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">apiVersion: v1<br>kind: Endpoints<br>metadata:<br>  annotations:<br>    control-plane.alpha.kubernetes.io/leader: &#x27;&#123;&quot;holderIdentity&quot;:&quot;k8s-master01_a6307360-f814-4a7d-82cc-d4b89928438b&quot;,&quot;leaseDurationSeconds&quot;:15,&quot;acquireTime&quot;:&quot;2021-10-06T13:37:48Z&quot;,&quot;renewTime&quot;:&quot;2021-10-06T13:39:47Z&quot;,&quot;leaderTransitions&quot;:1&#125;&#x27;<br>  creationTimestamp: &quot;2021-10-06T13:11:30Z&quot;<br>  managedFields:<br>  - apiVersion: v1<br>    fieldsType: FieldsV1<br>    fieldsV1:<br>      f:metadata:<br>        f:annotations:<br>          .: &#123;&#125;<br>          f:control-plane.alpha.kubernetes.io/leader: &#123;&#125;<br>    manager: kube-controller-manager<br>    operation: Update<br>    time: &quot;2021-10-06T13:11:30Z&quot;<br>  name: kube-controller-manager<br>  namespace: kube-system<br>  resourceVersion: &quot;7596&quot;<br>  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager<br>  uid: ccc812be-c1cf-4e2c-a1cb-5133198aae47<br></code></pre></td></tr></table></figure>



<h4 id="3ï¼‰éƒ¨ç½²-kube-scheduler"><a href="#3ï¼‰éƒ¨ç½²-kube-scheduler" class="headerlink" title="3ï¼‰éƒ¨ç½² kube-scheduler"></a>3ï¼‰éƒ¨ç½² kube-scheduler</h4><p><strong>åŸºç¡€ç»„ä»¶ä»‹ç» â€”â€” kube-scheduler:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-kube-scheduler/">ä¼ é€é—¨</a></p>
<blockquote>
<p>ğŸš©  è¿™é‡Œéƒ¨ç½²çš„æ˜¯ä¸€ä¸ªä¸‰å®ä¾‹çš„ kube-scheduler é›†ç¾¤ï¼Œå¯åŠ¨åä¼šé€šè¿‡é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leaderï¼Œå…¶ä»–èŠ‚ç‚¹å¤„äºå µå¡çŠ¶æ€ï¼Œå½“ leader èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œå‰©ä½™çš„å µå¡èŠ‚ç‚¹ä¼šå†æ¬¡é€‰ä¸¾äº§ç”Ÿæ–°çš„ leaderï¼Œä»çƒ­ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ã€‚</p>
<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨ k8s-master01 ä¸Šè¿›è¡Œï¼Œç„¶åå†é€šè¿‡æ‰¹ç®¡ç†å·¥å…·åˆ†å‘è‡³å…¶ä»–èŠ‚ç‚¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</strong></p>
</blockquote>
<h5 id="1-åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#1-åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶"></a>1. åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/server/cfg/kube-scheduler.conf</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_SCHEDULER_OPTS=&quot;--master=127.0.0.1:8080 \<br>--address=127.0.0.1 \<br>--leader-elect \<br>--logtostderr=true \<br>--log-dir=/data/applications/kubernetes/logs \<br>--v=2&quot;<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-7"><a href="#é…ç½®å‚æ•°è¯´æ˜-7" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-2"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-2" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/cfg/kube-scheduler.conf dest=/data/applications/kubernetes/cfg/kube-scheduler.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="2-åˆ›å»º-systemd-unit-æ–‡ä»¶-1"><a href="#2-åˆ›å»º-systemd-unit-æ–‡ä»¶-1" class="headerlink" title="2. åˆ›å»º systemd unit æ–‡ä»¶"></a>2. åˆ›å»º systemd unit æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/server/systemd/kube-scheduler.service</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Kubernetes Scheduler<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/data/applications/kubernetes/cfg/kube-scheduler.conf<br>ExecStart=/data/applications/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS<br>Restart=on-failure<br>RestartSec=5<br>StartLimitInterval=0<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-3"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-3" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m copy -a &quot;src=~/kubernetes/server/systemd/kube-scheduler.service dest=/usr/lib/systemd/system/kube-scheduler.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="3-å¯åŠ¨-kube-scheduler-é›†ç¾¤"><a href="#3-å¯åŠ¨-kube-scheduler-é›†ç¾¤" class="headerlink" title="3. å¯åŠ¨ kube-scheduler é›†ç¾¤"></a>3. å¯åŠ¨ kube-scheduler é›†ç¾¤</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-master -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl enable kube-scheduler.service&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl start kube-scheduler.service&quot;<br>ansible k8s-master -S -R root -m shell -a &quot;systemctl status kube-scheduler.service&quot;<br></code></pre></td></tr></table></figure>



<h5 id="4-éªŒè¯-kube-scheduler-é›†ç¾¤çŠ¶æ€"><a href="#4-éªŒè¯-kube-scheduler-é›†ç¾¤çŠ¶æ€" class="headerlink" title="4. éªŒè¯ kube-scheduler é›†ç¾¤çŠ¶æ€"></a>4. éªŒè¯ kube-scheduler é›†ç¾¤çŠ¶æ€</h5><h6 id="1âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯-1"><a href="#1âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯-1" class="headerlink" title="1âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯:"></a>1âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get componentstatuses # æˆ–æ‰§è¡Œ kubectl get cs<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME                 STATUS    MESSAGE             ERROR<br>controller-manager   Healthy   ok                  <br>scheduler            Healthy   ok                  <br>etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   <br>etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   <br>etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125; <br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸš© æ£€æŸ¥é›†ç¾¤çŠ¶æ€ï¼Œé›†ç¾¤çš„çŠ¶æ€å°±å…¨éƒ½ä¸ºâ€okâ€</p>
<p>å½“ <code>kube-scheduler </code> é›†ç¾¤ä¸­çš„1ä¸ªæˆ–2ä¸ªèŠ‚ç‚¹çš„ <code>scheduler </code> æœåŠ¡æŒ‚æ‰ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„ <code>scheduler </code> æœåŠ¡æ´»ç€ï¼Œåˆ™é›†ç¾¤ä¸­<code>scheduler</code> çš„çŠ¶æ€ä»ç„¶ä¸º <strong>â€œokâ€</strong>,ä»ç„¶ä¼šç»§ç»­æä¾›æœåŠ¡ï¼</p>
</blockquote>
<h6 id="2âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£-1"><a href="#2âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£-1" class="headerlink" title="2âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:"></a>2âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">netstat -lntp | grep kube-scheduler<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">tcp        0      0 127.0.0.1:10251         0.0.0.0:*               LISTEN      2049/kube-scheduler <br>tcp6       0      0 :::10259                :::*                    LISTEN      2049/kube-scheduler cai<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸŒˆ kube-scheduler ç›‘å¬ç«¯å£ä¸º 10251 å’Œ 10259</p>
<p><code>10251</code>ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œéå®‰å…¨ç«¯å£ï¼Œä¸éœ€è¦è®¤è¯æˆæƒï¼›<br><code>10259</code>ï¼šæ¥æ”¶ https è¯·æ±‚ï¼Œå®‰å…¨ç«¯å£ï¼Œéœ€è¦è®¤è¯æˆæƒï¼›<br>ä¸¤ä¸ªæ¥å£éƒ½å¯¹å¤–æä¾› <code>/metrics</code> å’Œ <code>/healthz</code> çš„è®¿é—®ã€‚</p>
</blockquote>
<h6 id="3âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„-leader-1"><a href="#3âƒ£ï¸-æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„-leader-1" class="headerlink" title="3âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„ leader:"></a>3âƒ£ï¸ æŸ¥çœ‹é›†ç¾¤å½“ä¸­çš„ leader:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get endpoints kube-scheduler --namespace=kube-system  -o yaml<br></code></pre></td></tr></table></figure>

<p>è¿”å›å¦‚ä¸‹ï¼Œå¯è§å½“ç„¶ leader ä¸º <code>k8s-master03</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">apiVersion: v1<br>kind: Endpoints<br>metadata:<br>  annotations:<br>    control-plane.alpha.kubernetes.io/leader: &#x27;&#123;&quot;holderIdentity&quot;:&quot;k8s-master03_cd78cdca-b2e3-4f36-b2c3-234bb8651d08&quot;,&quot;leaseDurationSeconds&quot;:15,&quot;acquireTime&quot;:&quot;2021-10-07T02:36:24Z&quot;,&quot;renewTime&quot;:&quot;2021-10-07T02:46:33Z&quot;,&quot;leaderTransitions&quot;:0&#125;&#x27;<br>  creationTimestamp: &quot;2021-10-07T02:36:24Z&quot;<br>  managedFields:<br>  - apiVersion: v1<br>    fieldsType: FieldsV1<br>    fieldsV1:<br>      f:metadata:<br>        f:annotations:<br>          .: &#123;&#125;<br>          f:control-plane.alpha.kubernetes.io/leader: &#123;&#125;<br>    manager: kube-scheduler<br>    operation: Update<br>    time: &quot;2021-10-07T02:36:24Z&quot;<br>  name: kube-scheduler<br>  namespace: kube-system<br>  resourceVersion: &quot;69322&quot;<br>  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler<br>  uid: 645f7d7d-6413-4ef4-bd2b-61a5a82adfe8<br></code></pre></td></tr></table></figure>





<h3 id="6ã€éƒ¨ç½²-Kubernetes-node-èŠ‚ç‚¹"><a href="#6ã€éƒ¨ç½²-Kubernetes-node-èŠ‚ç‚¹" class="headerlink" title="6ã€éƒ¨ç½² Kubernetes node èŠ‚ç‚¹"></a>6ã€éƒ¨ç½² Kubernetes node èŠ‚ç‚¹</h3><blockquote>
<p>ğŸŒˆ <strong>å…³äº node èŠ‚ç‚¹</strong></p>
<p>éƒ¨ç½²åœ¨ master èŠ‚ç‚¹çš„å¿…è¦ç»„ä»¶æœ‰ <code>docker</code>ã€<code>kubelet</code> ã€ <code>kube-proxy</code> ã€<code>ç½‘ç»œç»„ä»¶</code>ï¼Œç”±äºè€ƒè™‘åˆ°åç»­ mertics-serverã€istio ç­‰æœåŠ¡çš„ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬å°† master èŠ‚ç‚¹ä¹Ÿä½œä¸º node åŠ å…¥é›†ç¾¤ï¼Œä½†æ˜¯é€šè¿‡æ±¡ç‚¹çš„æ–¹å¼ç¦æ­¢ç›´æ¥è°ƒåº¦ã€‚</p>
</blockquote>
<h4 id="1ï¼‰éƒ¨ç½²-kubelet"><a href="#1ï¼‰éƒ¨ç½²-kubelet" class="headerlink" title="1ï¼‰éƒ¨ç½² kubelet"></a>1ï¼‰éƒ¨ç½² kubelet</h4><p><strong>åŸºç¡€ç»„ä»¶ä»‹ç» â€”â€” kubelet:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-kubelet/">ä¼ é€é—¨</a></p>
<blockquote>
<p>ğŸš© kubelet è¿è¡Œåœ¨æ¯ä¸ªnodeèŠ‚ç‚¹ä¸Šï¼Œæ¥æ”¶ kube-apiserver å‘é€çš„è¯·æ±‚ï¼Œç®¡ç† Pod å®¹å™¨ï¼Œæ‰§è¡Œäº¤äº’å¼å‘½ä»¤ï¼Œå¦‚ execã€runã€logs ç­‰ã€‚kubelet å¯åŠ¨æ—¶è‡ªåŠ¨å‘ kube-apiserver æ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå†…ç½®çš„ cadvisor ç»Ÿè®¡å’Œç›‘æ§èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨éƒ¨ç½²æ—¶ç›´æ¥å¼€å¯ TLS bootstrapï¼Œä»¥æ­¤æ¥è‡ªåŠ¨ç­¾å‘ kubelet çš„è¯ä¹¦ã€‚</p>
<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨ k8s-master01 ä¸Šè¿›è¡Œï¼Œç„¶åå†é€šè¿‡æ‰¹ç®¡ç†å·¥å…·åˆ†å‘è‡³å…¶ä»–èŠ‚ç‚¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</strong></p>
</blockquote>
<h5 id="1-åˆ›å»º-kubelet-çš„-kubeconfig-é…ç½®æ–‡ä»¶"><a href="#1-åˆ›å»º-kubelet-çš„-kubeconfig-é…ç½®æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º kubelet çš„ kubeconfig é…ç½®æ–‡ä»¶"></a>1. åˆ›å»º kubelet çš„ kubeconfig é…ç½®æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®å¿…è¦å˜é‡</span><br>BOOTSTRAP_TOKEN=$(cat /data/applications/kubernetes/cfg/token.csv | awk -F &#x27;,&#x27; &#x27;&#123;print $1&#125;&#x27;)<br>KUBE_APISERVER=&quot;https://$(hostname -i):6443&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®é›†ç¾¤å‚æ•°</span><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/data/applications/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/bootstrap.kubeconfig<br><span class="hljs-meta">  </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span><br>kubectl config set-credentials kubelet-bootstrap \<br>  --token=$&#123;BOOTSTRAP_TOKEN&#125; \<br>  --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/bootstrap.kubeconfig<br><span class="hljs-meta">  </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span><br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kubelet-bootstrap \<br>  --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/bootstrap.kubeconfig<br><span class="hljs-meta">  </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span><br>kubectl config use-context default --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/bootstrap.kubeconfig<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-4"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-4" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy  -a &quot;src=~/kubernetes/node/cfg/bootstrap.kubeconfig dest=/data/applications/kubernetes/cfg/bootstrap.kubeconfig owner=root group=root mode=0600&quot;<br></code></pre></td></tr></table></figure>



<h5 id="2-åˆ›å»º-kubelet-å‚æ•°-yaml-é…ç½®æ–‡ä»¶"><a href="#2-åˆ›å»º-kubelet-å‚æ•°-yaml-é…ç½®æ–‡ä»¶" class="headerlink" title="2. åˆ›å»º kubelet å‚æ•° yaml é…ç½®æ–‡ä»¶"></a>2. åˆ›å»º kubelet å‚æ•° yaml é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/node/cfg/kubelet-config.yml</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">KubeletConfiguration</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubelet.config.k8s.io/v1beta1</span><br><span class="hljs-attr">address:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">10250</span><br><span class="hljs-attr">readOnlyPort:</span> <span class="hljs-number">10255</span><br><span class="hljs-attr">cgroupDriver:</span> <span class="hljs-string">cgroupfs</span><br><span class="hljs-attr">clusterDNS:</span><br><span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span><br><span class="hljs-attr">clusterDomain:</span> <span class="hljs-string">cluster.local</span> <br><span class="hljs-attr">failSwapOn:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">authentication:</span><br>  <span class="hljs-attr">anonymous:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">webhook:</span><br>    <span class="hljs-attr">cacheTTL:</span> <span class="hljs-string">2m0s</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">x509:</span><br>    <span class="hljs-attr">clientCAFile:</span> <span class="hljs-string">/data/applications/kubernetes/ssl/ca.pem</span> <br><span class="hljs-attr">authorization:</span><br>  <span class="hljs-attr">mode:</span> <span class="hljs-string">Webhook</span><br>  <span class="hljs-attr">webhook:</span><br>    <span class="hljs-attr">cacheAuthorizedTTL:</span> <span class="hljs-string">5m0s</span><br>    <span class="hljs-attr">cacheUnauthorizedTTL:</span> <span class="hljs-string">30s</span><br><span class="hljs-attr">evictionHard:</span><br>  <span class="hljs-attr">imagefs.available:</span> <span class="hljs-number">15</span><span class="hljs-string">%</span><br>  <span class="hljs-attr">memory.available:</span> <span class="hljs-string">100Mi</span><br>  <span class="hljs-attr">nodefs.available:</span> <span class="hljs-number">10</span><span class="hljs-string">%</span><br>  <span class="hljs-attr">nodefs.inodesFree:</span> <span class="hljs-number">5</span><span class="hljs-string">%</span><br><span class="hljs-attr">maxOpenFiles:</span> <span class="hljs-number">1000000</span><br><span class="hljs-attr">maxPods:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">featureGates:</span><br>  <span class="hljs-attr">RotateKubeletServerCertificate:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">rotateCertificates:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">serverTLSBootstrap:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-8"><a href="#é…ç½®å‚æ•°è¯´æ˜-8" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-5"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-5" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy  -a &quot;src=~/kubernetes/node/cfg/kubelet-config.yml dest=/data/applications/kubernetes/cfg/kubelet-config.yml owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="3-åˆ›å»º-kubelet-é…ç½®æ–‡ä»¶"><a href="#3-åˆ›å»º-kubelet-é…ç½®æ–‡ä»¶" class="headerlink" title="3. åˆ›å»º kubelet é…ç½®æ–‡ä»¶"></a>3. åˆ›å»º kubelet é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/node/cfg/kubelet.conf</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹: (<code>hostname-override</code> æ ¹æ®å®é™…æƒ…å†µæ›¿æ¢)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBELET_OPTS=&quot;--hostname-override=k8s-master01 \<br>--pod_infra_container_image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 \<br>--bootstrap-kubeconfig=/data/applications/kubernetes/cfg/bootstrap.kubeconfig \<br>--kubeconfig=/data/application/kubernetes/cfg/kubelet.kubeconfig \<br>--config=/data/applications/kubernetes/cfg/kubelet-config.yml \<br>--cert-dir=/data/applications/kubernetes/ssl \<br>--network-plugin=cni \<br>--fail-swap-on=false \<br>--logtostderr=true \<br>--v=2 \<br>--log-dir=/data/applications/kubernetes/logs \<br>--node-labels=node.kubernetes.io/k8s-master=true&quot;<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-6"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-6" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy  -a &quot;src=~/kubernetes/node/cfg/kubelet.conf dest=/data/applications/kubernetes/cfg/kubelet.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>âš ï¸ <strong>æ³¨æ„:</strong></p>
<p><code>hostname-override</code> è®¾ç½®ä¸ºå„nodeèŠ‚ç‚¹ä¸»æœºIPï¼ˆæˆ– ä¸»æœºådnsè§£æï¼‰</p>
<p><code>KUBELET_POD_INFRA_CONTAINER</code> å¯è®¾ç½®ä¸ºç§æœ‰å®¹å™¨ä»“åº“åœ°å€ï¼Œå¦‚æœ‰å¯è®¾ç½®ä¸º <code>KUBELET_POD_INFRA_CONTAINER=&quot;--pod_infra_container_image=&#123;ç§æœ‰é•œåƒä»“åº“ip&#125;:80/k8s/pause-amd64:v3.1&quot;</code></p>
<p><code>node-labels</code> å¦‚æ˜¯ master èŠ‚ç‚¹åˆ™è®¾ç½®ä¸º masterï¼Œnode èŠ‚ç‚¹åˆ™è®¾ç½®ä¸º node</p>
</blockquote>
<h5 id="4-åˆ›å»º-systemd-unit-æ–‡ä»¶-1"><a href="#4-åˆ›å»º-systemd-unit-æ–‡ä»¶-1" class="headerlink" title="4. åˆ›å»º systemd unit æ–‡ä»¶"></a>4. åˆ›å»º systemd unit æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/node/systemd/kubelet.service</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Kubernetes Kubelet<br>Documentation=https://github.com/GoogleCloudPlatform/kubernetes<br>After=docker.service<br>Requires=docker.service<br><br>[Service]<br>EnvironmentFile=/data/applications/kubernetes/cfg/kubelet.conf <br>ExecStart=/data/applications/kubernetes/bin/kubelet $KUBELET_OPTS<br>Restart=always<br>RestartSec=5<br>StartLimitInterval=0<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-7"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-7" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy -a &quot;src=~/kubernetes/node/systemd/kubelet.service dest=/usr/lib/systemd/system/kubelet.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="5-å¯åŠ¨-kubelet-æœåŠ¡"><a href="#5-å¯åŠ¨-kubelet-æœåŠ¡" class="headerlink" title="5. å¯åŠ¨ kubelet æœåŠ¡"></a>5. å¯åŠ¨ kubelet æœåŠ¡</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;systemctl enable kubelet.service&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;systemctl start kubelet.service&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;systemctl status kubelet.service&quot;<br></code></pre></td></tr></table></figure>



<h5 id="6-bootstrap-token-è®¤è¯æˆæƒ"><a href="#6-bootstrap-token-è®¤è¯æˆæƒ" class="headerlink" title="6. bootstrap token è®¤è¯æˆæƒ"></a>6. bootstrap token è®¤è¯æˆæƒ</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap<br></code></pre></td></tr></table></figure>



<h5 id="7-è‡ªåŠ¨-approce-CSR-è¯·æ±‚"><a href="#7-è‡ªåŠ¨-approce-CSR-è¯·æ±‚" class="headerlink" title="7. è‡ªåŠ¨ approce CSR è¯·æ±‚"></a>7. è‡ªåŠ¨ approce CSR è¯·æ±‚</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/yaml/csr-crb.yaml </code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> Approve all CSRs <span class="hljs-keyword">for</span> the group <span class="hljs-string">&quot;system:bootstrappers&quot;</span></span><br>kind: ClusterRoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: auto-approve-csrs-for-group<br>subjects:<br>- kind: Group<br>  name: system:node-bootstrap<br>  apiGroup: rbac.authorization.k8s.io<br>roleRef:<br>  kind: ClusterRole<br>  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient<br>  apiGroup: rbac.authorization.k8s.io<br>---<br><span class="hljs-meta">#</span><span class="bash"> To <span class="hljs-built_in">let</span> a node of the group <span class="hljs-string">&quot;system:nodes&quot;</span> renew its own credentials</span><br>kind: ClusterRoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: node-client-cert-renewal<br>subjects:<br>- kind: Group<br>  name: system:nodes<br>  apiGroup: rbac.authorization.k8s.io<br>roleRef:<br>  kind: ClusterRole<br>  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient<br>  apiGroup: rbac.authorization.k8s.io<br>---<br><span class="hljs-meta">#</span><span class="bash"> A ClusterRole <span class="hljs-built_in">which</span> instructs the CSR approver to approve a node requesting a</span><br><span class="hljs-meta">#</span><span class="bash"> serving cert matching its client cert.</span><br>kind: ClusterRole<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: approve-node-server-renewal-csr<br>rules:<br>- apiGroups: [&quot;certificates.k8s.io&quot;]<br>  resources: [&quot;certificatesigningrequests/selfnodeserver&quot;]<br>  verbs: [&quot;create&quot;]<br>---<br><span class="hljs-meta">#</span><span class="bash"> To <span class="hljs-built_in">let</span> a node of the group <span class="hljs-string">&quot;system:nodes&quot;</span> renew its own server credentials</span><br>kind: ClusterRoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: node-server-cert-renewal<br>subjects:<br>- kind: Group<br>  name: system:nodes<br>  apiGroup: rbac.authorization.k8s.io<br>roleRef:<br>  kind: ClusterRole<br>  name: approve-node-server-renewal-csr<br>  apiGroup: rbac.authorization.k8s.io<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸŒˆ <strong>rbacè§„åˆ™è§£é‡Šè¯´æ˜</strong></p>
<p><code>auto-approve-csrs-for-group</code>ï¼š</p>
<ul>
<li>è‡ªåŠ¨ approve node çš„ç¬¬ä¸€æ¬¡ CSRï¼› æ³¨æ„ç¬¬ä¸€æ¬¡ CSR æ—¶ï¼Œè¯·æ±‚çš„ Group ä¸º system:bootstrapï¼ˆæ³¨æ„ group è¦å’Œè®¤è¯ç”¨çš„ token.csv ä¸­çš„ group ä¿æŒä¸€è‡´ï¼‰ï¼›</li>
</ul>
<p><code>node-client-cert-renewal</code>ï¼š</p>
<ul>
<li>è‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ client è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodesï¼›</li>
</ul>
<p><code>node-server-cert-renewal</code>ï¼š</p>
<p>è‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ server è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;`</p>
</blockquote>
<h6 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º:"></a>æ‰§è¡Œåˆ›å»º:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f ~/kubernetes/yaml/csr-crb.yaml <br></code></pre></td></tr></table></figure>



<h5 id="8-æŸ¥çœ‹CSRè¯ä¹¦è¯·æ±‚å¹¶æ‰¹å‡†-kubelet-çš„-TLS-è¯ä¹¦è¯·æ±‚"><a href="#8-æŸ¥çœ‹CSRè¯ä¹¦è¯·æ±‚å¹¶æ‰¹å‡†-kubelet-çš„-TLS-è¯ä¹¦è¯·æ±‚" class="headerlink" title="8. æŸ¥çœ‹CSRè¯ä¹¦è¯·æ±‚å¹¶æ‰¹å‡† kubelet çš„ TLS è¯ä¹¦è¯·æ±‚"></a>8. æŸ¥çœ‹CSRè¯ä¹¦è¯·æ±‚å¹¶æ‰¹å‡† kubelet çš„ TLS è¯ä¹¦è¯·æ±‚</h5><blockquote>
<p>ğŸš© å¦‚æœé€šè¿‡ TLS bootstrap ç®¡ç†åï¼Œkubelet çš„ è¯ä¹¦å°±ä¼šå˜æˆè½®è¯¢è¯ä¹¦çš„å½¢å¼ï¼Œclient è¯ä¹¦ä¼šè‡ªåŠ¨ç­¾å‘ï¼Œserver è¯ä¹¦åŸºäºå®‰å…¨æ€§è€ƒè™‘ï¼ŒCSR approving controllers ä¸ä¼šè‡ªåŠ¨ approve kubelet server è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ¨ approveï¼Œä½†æ˜¯é€šè¿‡è‡ªå®šä¹‰çš„è§¦å‘å™¨ï¼ŒåŒæ ·ä¹Ÿèƒ½å®ç°è‡ªåŠ¨åŒ–ã€‚å¹¶ä¸”ä¼šè‡ªåŠ¨ç”Ÿæˆ kubelet.kubeconfig ä¸“é—¨ç”¨äºè¯ä¹¦çš„è®¤è¯å’Œç­¾å‘ç®¡ç†ã€‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> æ‰¹é‡ç­¾å‘(Pending çš„ CSR ç”¨äºåˆ›å»º kubelet server è¯ä¹¦ï¼Œéœ€è¦æ‰‹åŠ¨ approve)</span><br>kubectl get csr|grep &#x27;Pending&#x27; | awk &#x27;NR&gt;0&#123;print $1&#125;&#x27;|xargs kubectl certificate approve<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> æŸ¥çœ‹ csr è¯·æ±‚ï¼ˆæ‰¹å‡†ç”³è¯·æŸ¥çœ‹åCONDITIONæ˜¾ç¤ºApproved,Issuedå³å¯ï¼‰</span><br>kubectl get csr<br></code></pre></td></tr></table></figure>



<h5 id="9-éªŒè¯-TLS-bootstrap-ç®¡ç†è¯ä¹¦"><a href="#9-éªŒè¯-TLS-bootstrap-ç®¡ç†è¯ä¹¦" class="headerlink" title="9. éªŒè¯ TLS bootstrap ç®¡ç†è¯ä¹¦:"></a>9. éªŒè¯ TLS bootstrap ç®¡ç†è¯ä¹¦:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ll /data/applications/kubernetes/ssl/kubelet-*.pem<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸æƒ…å†µï¼Œç»“æœå¦‚ä¸‹:</p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20211008113644603.png" srcset="/img/loading.gif" lazyload alt="image-20211008113644603"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /data/applications/kubernetes/cfg/kubelet.kubeconfig <br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸æƒ…å†µï¼Œç»“æœå¦‚ä¸‹:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">clusters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">certificate-authority-data:</span> <span class="hljs-string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR2akNDQXFhZ0F3SUJBZ0lVR0lHZ2VQSWNoSWtKRnFZOTJ6MWE2Z1RCNVBnd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1pURUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFVcHBibWN4RURBT0JnTlZCQWNUQjBKbAphVXBwYm1jeEREQUtCZ05WQkFvVEEyczRjekVQTUEwR0ExVUVDeE1HYzNsemRHVnRNUk13RVFZRFZRUURFd3ByCmRXSmxjbTVsZEdWek1CNFhEVEl4TURreU16QTVNVEF3TUZvWERUTXhNRGt5TVRBNU1UQXdNRm93WlRFTE1Ba0cKQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFVcHBibWN4RURBT0JnTlZCQWNUQjBKbGFVcHBibWN4RERBSwpCZ05WQkFvVEEyczRjekVQTUEwR0ExVUVDeE1HYzNsemRHVnRNUk13RVFZRFZRUURFd3ByZFdKbGNtNWxkR1Z6Ck1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBeUU4ZytUWUhMdCtjQXJSRkRyZTYKNmp5ZG9VbFkvM29TeW1uT3d6dEhHMFk0ZDhPOXVBZVZRTTdNWm1BMGhpRHhXUVZiWHlKQTBvNkVwVzFvRlR3YgpHdG5QUWlqSVFJTWlnZVNTNnVHVEZiRklpUTNBam53Y2tGdlI5WHlRTHVyejBRNnJFM21yc3RMNlBLYUx1SEJwCmo1SDZsRUx3OTdxdCtjR0NtQnMraEdFc202THVEWmwxRGlBb1RQQnduZTdlWHRqM2xmam5oUW44a0IrbGJMSmYKYjRSakFSbkN5RUgwMnBzTXNUcW85ckhiZEczUUNCeHlGZ2s1ZHRNczQwVFMyV0VzQjNyRnJnaHF0R2hPRWM2cApGZytrMjZEL0RMTHpNTWxCLzBKOXlkN0FkOUZlbkdjeUZIc2FKclMvM3RCVlFpWk5oaTBaZzlWM013Rk0zUHZPClZ3SURBUUFCbzJZd1pEQU9CZ05WSFE4QkFmOEVCQU1DQVFZd0VnWURWUjBUQVFIL0JBZ3dCZ0VCL3dJQkFqQWQKQmdOVkhRNEVGZ1FVREhEaGVia1hzWlRPZWw3TTdhQmtML2cxSUtvd0h3WURWUjBqQkJnd0ZvQVVESERoZWJrWApzWlRPZWw3TTdhQmtML2cxSUtvd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFFSjZZby9oNklsTWlZSFVHY1NhCkNJKytuUTNHWklKQlJYc0huMWlSRGVUaVBtejQvQm5pWmJlT3dXK1V2WVIwcytEMTlVeTRwa2cvb2tYUGdUM1oKdjBIN1IzdHpmMklGUVNhbnhBTE9hVTdxbm5tWU9JOUpYa0FDclR6QjJ5TlhWSXpZamRDMkxZS1kzRDI2TVZFZwpLQWtVWG5ybWxZcGUxOUh5UWFiVy9uSklPTDNJUzZRQlp2WGZ1aHpRMEJXL3g5OWdPV2swVGFrYnIrdlhhdWZxCk9Eb2hJT0E1cmk0UkVWN0M4WE1QYWNpREVGRVVGNG9hZlV6eFVjNVlIbDhkMnQwN1k3Mkl3WTdFaDY5ZG8weGkKQjNRZS8xc2dLRWZBZXp1NXV5eGhTZlpqODYybzQ1WGpCMzc1dHRETlEwdlhkcVRBUGU1SFpaUzUyeDAyRVFLWAp1V2c9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://192.168.3.231:6443</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-cluster</span><br><span class="hljs-attr">contexts:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">context:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">default-cluster</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">default-auth</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-context</span><br><span class="hljs-attr">current-context:</span> <span class="hljs-string">default-context</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Config</span><br><span class="hljs-attr">preferences:</span> &#123;&#125;<br><span class="hljs-attr">users:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">default-auth</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">client-certificate:</span> <span class="hljs-string">/data/applications/kubernetes/ssl/kubelet-client-current.pem</span><br>    <span class="hljs-attr">client-key:</span> <span class="hljs-string">/data/applications/kubernetes/ssl/kubelet-client-current.pem</span><br></code></pre></td></tr></table></figure>



<h5 id="10-éªŒè¯èŠ‚ç‚¹çŠ¶æ€"><a href="#10-éªŒè¯èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="10. éªŒè¯èŠ‚ç‚¹çŠ¶æ€"></a>10. éªŒè¯èŠ‚ç‚¹çŠ¶æ€</h5><h6 id="1âƒ£ï¸-æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯"><a href="#1âƒ£ï¸-æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯" class="headerlink" title="1âƒ£ï¸ æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯:"></a>1âƒ£ï¸ æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get nodes<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸æƒ…å†µï¼Œè¿”å›å¦‚ä¸‹: (æ­¤æ—¶å‘ç°æ‰€æœ‰nodeèŠ‚ç‚¹çŠ¶æ€å‡ä¸º â€œreadyâ€)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME           STATUS   ROLES    AGE   VERSION<br>k8s-master01   Ready    &lt;none&gt;   12h   v1.18.18<br>k8s-master02   Ready    &lt;none&gt;   12h   v1.18.18<br>k8s-master03   Ready    &lt;none&gt;   12h   v1.18.18<br>k8s-node1      Ready    &lt;none&gt;   12h   v1.18.18<br></code></pre></td></tr></table></figure>

<h6 id="2âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£-2"><a href="#2âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£-2" class="headerlink" title="2âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:"></a>2âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">netstat -lntp|grep kubelet<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">tcp        0      0 127.0.0.1:40621         0.0.0.0:*               LISTEN      28305/kubelet       <br>tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      28305/kubelet       <br>tcp6       0      0 :::10250                :::*                    LISTEN      28305/kubelet       <br>tcp6       0      0 :::10255                :::*                    LISTEN      28305/kubelet    <br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸŒˆ kubelet ç›‘å¬ç«¯å£ä¸º 10248ã€10250ã€10255</p>
<p><code>10248</code>ï¼šhealthz httpæœåŠ¡ç«¯å£ï¼Œå³å¥åº·æ£€æŸ¥æœåŠ¡çš„ç«¯å£ï¼Œæ¥æ”¶ http è¯·æ±‚ï¼Œä¸éœ€è¦è®¤è¯æˆæƒï¼›<br><code>10250</code>ï¼škubelet æœåŠ¡ç›‘å¬çš„ç«¯å£, api ä¼šæ£€æµ‹ä»–æ˜¯å¦å­˜æ´»ã€‚æ¥æ”¶ https è¯·æ±‚ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—®<code>/healthz</code>ä¹Ÿéœ€è¦ï¼‰ï¼›</p>
<p><code>10255</code>: åªè¯»ç«¯å£ï¼Œå¯ä»¥ä¸ç”¨éªŒè¯å’Œæˆæƒæœºåˆ¶ï¼Œç›´æ¥è®¿é—®ã€‚é…ç½® <code>&quot;readOnlyPort: 0&quot;</code> åˆ™è¡¨ç¤ºå…³é—­åªè¯»ç«¯å£ï¼›</p>
</blockquote>
<h4 id="2ï¼‰éƒ¨ç½²-kube-proxy"><a href="#2ï¼‰éƒ¨ç½²-kube-proxy" class="headerlink" title="2ï¼‰éƒ¨ç½² kube-proxy"></a>2ï¼‰éƒ¨ç½² kube-proxy</h4><p><strong>åŸºç¡€ç»„ä»¶ä»‹ç» â€”â€” kube-proxy:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-kube-proxy/">ä¼ é€é—¨</a></p>
<blockquote>
<p>ğŸš© kube-proxyè¿è¡Œåœ¨æ‰€æœ‰çš„nodeèŠ‚ç‚¹ä¸Šï¼Œå®ƒç›‘å¬apiserverä¸­serviceå’Œendpointçš„å˜åŒ–æƒ…å†µï¼Œåˆ›å»ºè·¯ç”±è§„åˆ™ä»¥æä¾›æœåŠ¡IPå’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p>
<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨ k8s-master01 ä¸Šè¿›è¡Œï¼Œç„¶åå†é€šè¿‡æ‰¹ç®¡ç†å·¥å…·åˆ†å‘è‡³å…¶ä»–èŠ‚ç‚¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</strong></p>
</blockquote>
<h5 id="1-åˆ›å»º-kube-proxy-çš„-kubeconfig-é…ç½®æ–‡ä»¶"><a href="#1-åˆ›å»º-kube-proxy-çš„-kubeconfig-é…ç½®æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º kube-proxy çš„ kubeconfig é…ç½®æ–‡ä»¶"></a>1. åˆ›å»º kube-proxy çš„ kubeconfig é…ç½®æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_APISERVER=&quot;https://$(hostname -i):6443&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®é›†ç¾¤å‚æ•°</span><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/data/applications/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/kube-proxy.kubeconfig<br><span class="hljs-meta"> </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span> <br>kubectl config set-credentials kube-proxy \<br>  --client-certificate=/data/applications/kubernetes/ssl/kube-proxy.pem \<br>  --client-key=/data/applications/kubernetes/ssl/kube-proxy-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/kube-proxy.kubeconfig<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span><br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-proxy \<br>  --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/kube-proxy.kubeconfig<br><span class="hljs-meta">  </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span> <br>kubectl config use-context default --kubeconfig=$&#123;HOME&#125;/kubernetes/node/cfg/kube-proxy.kubeconfig<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-8"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-8" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy  -a &quot;src=~/kubernetes/node/cfg/kube-proxy.kubeconfig dest=/data/applications/kubernetes/cfg/kube-proxy.kubeconfig owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="2-åˆ›å»º-kube-proxy-å‚æ•°-yaml-é…ç½®æ–‡ä»¶"><a href="#2-åˆ›å»º-kube-proxy-å‚æ•°-yaml-é…ç½®æ–‡ä»¶" class="headerlink" title="2. åˆ›å»º kube-proxy å‚æ•° yaml é…ç½®æ–‡ä»¶"></a>2. åˆ›å»º kube-proxy å‚æ•° yaml é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/node/cfg/kube-proxy-config.yml</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:  (<code>hostname-override</code> æ ¹æ®å®é™…æƒ…å†µæ›¿æ¢)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">kind: KubeProxyConfiguration<br>apiVersion: kubeproxy.config.k8s.io/v1alpha1<br>hostnameOverride: k8s-master01<br>address: 0.0.0.0<br>metricsBindAddress: 0.0.0.0:10249<br>healthzBindAddress: 0.0.0.0:10256<br>clientConnection:<br>  burst: 200<br>  kubeconfig: &quot;/data/applications/kubernetes/cfg/kube-proxy.kubeconfig&quot;<br>  qps: 100<br>enableProfiling: true<br>clusterCIDR: 10.0.0.0/16<br>portRange: &quot;&quot;<br>mode: &quot;ipvs&quot;<br>kubeProxyIPTablesConfiguration:<br>  masqueradeAll: true<br>kubeProxyIPVSConfiguration:<br>  scheduler: rr<br>  excludeCIDRs: []<br></code></pre></td></tr></table></figure>

<h6 id="é…ç½®å‚æ•°è¯´æ˜-9"><a href="#é…ç½®å‚æ•°è¯´æ˜-9" class="headerlink" title="é…ç½®å‚æ•°è¯´æ˜:"></a>é…ç½®å‚æ•°è¯´æ˜:</h6><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-9"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-9" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy  -a &quot;src=~/kubernetes/node/cfg/kube-proxy-config.yml dest=/data/applications/kubernetes/cfg/kube-proxy-config.yml owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="3-åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#3-åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="3. åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶"></a>3. åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/node/cfg/kube-proxy.conf</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_PROXY_OPTS=&quot;--logtostderr=true \<br>--v=2 \<br>--log-dir=/data/applications/kubernetes/logs \<br>--ipvs-min-sync-period=5s \<br>--ipvs-sync-period=5s \<br>--config=/data/applications/kubernetes/cfg/kube-proxy-config.yml&quot;<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-10"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-10" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy  -a &quot;src=~/kubernetes/node/cfg/kube-proxy.conf dest=/data/applications/kubernetes/cfg/kube-proxy.conf owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="4-åˆ›å»º-systemd-unit-æ–‡ä»¶-2"><a href="#4-åˆ›å»º-systemd-unit-æ–‡ä»¶-2" class="headerlink" title="4. åˆ›å»º systemd unit æ–‡ä»¶"></a>4. åˆ›å»º systemd unit æ–‡ä»¶</h5><p>æ–°å»ºæ–‡ä»¶ <code>~/kubernetes/node/systemd/kube-proxy.service</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Kubernetes Kube-Proxy Server<br>Documentation=https://github.com/GoogleCloudPlatform/kubernetes<br>After=network.target<br><br>[Service]<br>EnvironmentFile=/data/applications/kubernetes/cfg/kube-proxy.conf<br>ExecStart=/data/applications/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS<br>Restart=on-failure<br>RestartSec=5<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘é…ç½®æ–‡ä»¶-11"><a href="#åˆ†å‘é…ç½®æ–‡ä»¶-11" class="headerlink" title="åˆ†å‘é…ç½®æ–‡ä»¶:"></a>åˆ†å‘é…ç½®æ–‡ä»¶:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy -a &quot;src=~/kubernetes/node/systemd/kube-proxy.service dest=/usr/lib/systemd/system/kube-proxy.service owner=root group=root mode=0644&quot;<br></code></pre></td></tr></table></figure>



<h5 id="5-å¼€å¯-ipvs"><a href="#5-å¼€å¯-ipvs" class="headerlink" title="5. å¼€å¯ ipvs"></a>5. å¼€å¯ ipvs</h5><blockquote>
<p>ğŸŒˆ ä» <code>k8s</code> çš„1.8ç‰ˆæœ¬å¼€å§‹ï¼Œ<code>kube-proxy</code> å¼•å…¥äº† <code>IPVS</code> æ¨¡å¼ï¼Œ<code>IPVS</code>æ¨¡å¼ä¸ <code>iptables</code> åŒæ ·åŸºäº <code>Netfilter</code> ï¼Œä½†æ˜¯é‡‡ç”¨çš„ <code>hash</code> è¡¨ï¼Œå› æ­¤å½“<code>service</code>æ•°é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼ŒhashæŸ¥è¡¨çš„é€Ÿåº¦ä¼˜åŠ¿å°±ä¼šæ˜¾ç°å‡ºæ¥ï¼Œä»è€Œæé«˜ <code>service</code>çš„æœåŠ¡æ€§èƒ½ã€‚</p>
<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨æ‰€æœ‰ node èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚</strong></p>
</blockquote>
<h6 id="1âƒ£ï¸-å¼€å¯å†…æ ¸å‚æ•°"><a href="#1âƒ£ï¸-å¼€å¯å†…æ ¸å‚æ•°" class="headerlink" title="1âƒ£ï¸ å¼€å¯å†…æ ¸å‚æ•°"></a>1âƒ£ï¸ å¼€å¯å†…æ ¸å‚æ•°</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> è¿½åŠ å†…æ ¸å‚æ•°ï¼Œå¼€å¯äºŒå±‚ç½‘æ¡¥å¤„ç†</span><br>cat &gt;&gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF<br>net.bridge.bridge-nf-call-iptables = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br>EOF<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åŠ è½½å‚æ•°</span><br>sysctl -p /etc/sysctl.d/kubernetes.conf <br></code></pre></td></tr></table></figure>

<h6 id="2âƒ£ï¸-å®‰è£…-ipvsadm-ç­‰å·¥å…·"><a href="#2âƒ£ï¸-å®‰è£…-ipvsadm-ç­‰å·¥å…·" class="headerlink" title="2âƒ£ï¸ å®‰è£… ipvsadm ç­‰å·¥å…·"></a>2âƒ£ï¸ å®‰è£… ipvsadm ç­‰å·¥å…·</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m shell -a &quot;yum install -y ipvsadm ipset bridge-utils conntrack&quot;<br></code></pre></td></tr></table></figure>

<h6 id="3âƒ£ï¸-å¼€å¯-ipvs-æ”¯æŒ"><a href="#3âƒ£ï¸-å¼€å¯-ipvs-æ”¯æŒ" class="headerlink" title="3âƒ£ï¸ å¼€å¯ ipvs æ”¯æŒ"></a>3âƒ£ï¸ å¼€å¯ ipvs æ”¯æŒ</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ›å»º ipvs æ¨¡å—é…ç½®</span><br>cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF<br>modprobe -- ip_vs<br>modprobe -- ip_vs_rr<br>modprobe -- ip_vs_wrr<br>modprobe -- ip_vs_sh<br>modprobe -- nf_conntrack_ipv4<br>EOF<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> èµ‹äºˆæ‰§è¡Œæƒé™</span><br>chmod 755 /etc/sysconfig/modules/ipvs.modules<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åŠ è½½é…ç½®</span><br>bash /etc/sysconfig/modules/ipvs.modules<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> æŸ¥çœ‹åŠ è½½ä¿¡æ¯</span><br>lsmod | grep ip_vs<br></code></pre></td></tr></table></figure>

<p>æ­£ç¡®æƒ…å†µï¼Œè¿”å›å¦‚ä¸‹:</p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20211008141710750.png" srcset="/img/loading.gif" lazyload alt="image-20211008141710750"></p>
<h5 id="6-å¯åŠ¨-kube-proxy-æœåŠ¡"><a href="#6-å¯åŠ¨-kube-proxy-æœåŠ¡" class="headerlink" title="6. å¯åŠ¨ kube-proxy æœåŠ¡"></a>6. å¯åŠ¨ kube-proxy æœåŠ¡</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m shell -a &quot;systemctl daemon-reload&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;systemctl enable kube-proxy.service&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;systemctl start kube-proxy.service&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;systemctl status kube-proxy.service&quot;<br></code></pre></td></tr></table></figure>



<h5 id="7-éªŒè¯èŠ‚ç‚¹çŠ¶æ€"><a href="#7-éªŒè¯èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="7. éªŒè¯èŠ‚ç‚¹çŠ¶æ€"></a>7. éªŒè¯èŠ‚ç‚¹çŠ¶æ€</h5><h6 id="1âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£"><a href="#1âƒ£ï¸-æŸ¥çœ‹ç›‘å¬ç«¯å£" class="headerlink" title="1âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:"></a>1âƒ£ï¸ æŸ¥çœ‹ç›‘å¬ç«¯å£:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">netstat -lnpt|grep kube-proxy<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">tcp6       0      0 :::10256                :::*                    LISTEN      25828/kube-proxy    <br>tcp6       0      0 :::10249                :::*                    LISTEN      25828/kube-proxy       <br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸŒˆ kubelet ç›‘å¬ç«¯å£ä¸º 10249ã€10256</p>
<p><code>10249</code>ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œä¸éœ€è¦è®¤è¯æˆæƒï¼Œç”¨äºæä¾› <code>/metrics </code>ï¼›<br><code>10256</code>ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œä¸éœ€è¦è®¤è¯æˆæƒï¼Œç”¨äºæä¾›<code> /healthz</code>ã€‚</p>
</blockquote>
<h6 id="2âƒ£ï¸-æŸ¥çœ‹-ipvs-è·¯ç”±è§„åˆ™"><a href="#2âƒ£ï¸-æŸ¥çœ‹-ipvs-è·¯ç”±è§„åˆ™" class="headerlink" title="2âƒ£ï¸ æŸ¥çœ‹ ipvs è·¯ç”±è§„åˆ™"></a>2âƒ£ï¸ æŸ¥çœ‹ ipvs è·¯ç”±è§„åˆ™</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ipvsadm -ln<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br><span class="hljs-meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br>TCP  10.0.0.1:443 rr<br><span class="hljs-meta">  -&gt;</span><span class="bash"> 192.168.3.231:6443           Masq    1      0          0</span>         <br><span class="hljs-meta">  -&gt;</span><span class="bash"> 192.168.3.232:6443           Masq    1      0          0</span>         <br><span class="hljs-meta">  -&gt;</span><span class="bash"> 192.168.3.233:6443           Masq    1      0          0</span>        <br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸš© <strong>ç”±ä¸Šé¢å¯ä»¥çœ‹å‡º</strong>ï¼šæ‰€æœ‰é€šè¿‡ https è®¿é—® K8S SVC kubernetes çš„è¯·æ±‚éƒ½è½¬å‘åˆ° kube-apiserver èŠ‚ç‚¹çš„ 6443 ç«¯å£ï¼›</p>
</blockquote>
<h3 id="7ã€éƒ¨ç½²-calico-ç½‘ç»œæ–¹æ¡ˆ"><a href="#7ã€éƒ¨ç½²-calico-ç½‘ç»œæ–¹æ¡ˆ" class="headerlink" title="7ã€éƒ¨ç½² calico ç½‘ç»œæ–¹æ¡ˆ"></a>7ã€éƒ¨ç½² calico ç½‘ç»œæ–¹æ¡ˆ</h3><p><strong>åŸºç¡€ç»„ä»¶ä»‹ç» â€”â€” ç½‘ç»œç»„ä»¶:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6/">ä¼ é€é—¨</a></p>
<h4 id="1ï¼‰ä¸‹è½½å’Œåˆ†å‘-calico-å’Œ-cni-æ’ä»¶"><a href="#1ï¼‰ä¸‹è½½å’Œåˆ†å‘-calico-å’Œ-cni-æ’ä»¶" class="headerlink" title="1ï¼‰ä¸‹è½½å’Œåˆ†å‘ calico å’Œ cni æ’ä»¶"></a>1ï¼‰ä¸‹è½½å’Œåˆ†å‘ calico å’Œ cni æ’ä»¶</h4><h5 id="1-æ‰¹é‡åˆ›å»º-calico-å’Œ-cni-ç»„ä»¶ç›¸å…³ç›®å½•"><a href="#1-æ‰¹é‡åˆ›å»º-calico-å’Œ-cni-ç»„ä»¶ç›¸å…³ç›®å½•" class="headerlink" title="1. æ‰¹é‡åˆ›å»º calico å’Œ cni ç»„ä»¶ç›¸å…³ç›®å½•"></a>1. æ‰¹é‡åˆ›å»º calico å’Œ cni ç»„ä»¶ç›¸å…³ç›®å½•</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m shell -a &quot;mkdir -p /etc/calico/&#123;conf,yaml&#125; /opt/cni/bin/ /etc/cni/net.d&quot;<br></code></pre></td></tr></table></figure>

<h5 id="2-ä¸‹è½½-calico-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#2-ä¸‹è½½-calico-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="2. ä¸‹è½½ calico äºŒè¿›åˆ¶æ–‡ä»¶"></a>2. ä¸‹è½½ calico äºŒè¿›åˆ¶æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p ~/kubernetes/network/bin	&amp;&amp; \<br>wget -c https://github.com/projectcalico/calicoctl/releases/download/v3.19.2/calicoctl-linux-amd64 -O ~/kubernetes/network/bin/calicoctl &amp;&amp; \<br>chmod +x ~/kubernetes/network/bin/calicoctl <br></code></pre></td></tr></table></figure>

<h6 id="éªŒè¯ç‰ˆæœ¬"><a href="#éªŒè¯ç‰ˆæœ¬" class="headerlink" title="éªŒè¯ç‰ˆæœ¬:"></a>éªŒè¯ç‰ˆæœ¬:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">~/kubernetes/network/bin/calicoctl version<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">Client Version:    v3.19.2<br>Git commit:        6f3d4900<br>invalid configuration: no configuration has been provided, try setting KUBERNETES_MASTER environment variable<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ç”±äºå°šæœªè¿›è¡Œé…ç½®ï¼Œæ•…æ— æ³•è·å–å…·ä½“çš„é…ç½®ä¿¡æ¯ã€‚</p>
</blockquote>
<h6 id="åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„-master-èŠ‚ç‚¹"><a href="#åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„-master-èŠ‚ç‚¹" class="headerlink" title="åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„ master èŠ‚ç‚¹:"></a>åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„ master èŠ‚ç‚¹:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m copy -a &quot;src=~/kubernetes/network/bin/calicoctl dest=/usr/local/bin/calicoctl owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>



<h5 id="3-ä¸‹è½½-cni-ç»„ä»¶"><a href="#3-ä¸‹è½½-cni-ç»„ä»¶" class="headerlink" title="3. ä¸‹è½½ cni ç»„ä»¶"></a>3. ä¸‹è½½ cni ç»„ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> ä¸‹è½½è§£ cni ç½‘ç»œæ’ä»¶</span><br>wget -c https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v1.0.1.tgz -O ~/kubernetes/network/bin/cni-plugins-linux-amd64-v1.0.1.tgz <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> ä¸‹è½½ calico cni ç»„ä»¶</span><br>wget -c https://github.com/projectcalico/cni-plugin/releases/download/v3.19.2/calico-amd64 -O ~/kubernetes/network/bin/calico &amp;&amp; \<br>wget -c  https://github.com/projectcalico/cni-plugin/releases/download/v3.19.2/calico-ipam-amd64 -O ~/kubernetes/network/bin/calico-ipam<br></code></pre></td></tr></table></figure>

<h6 id="åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„-master-èŠ‚ç‚¹-1"><a href="#åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„-master-èŠ‚ç‚¹-1" class="headerlink" title="åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„ master èŠ‚ç‚¹:"></a>åˆ†å‘äºŒè¿›åˆ¶åŒ…è‡³å„ master èŠ‚ç‚¹:</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> è§£å‹ cni æ’ä»¶å‹ç¼©åŒ…åˆ°å„èŠ‚ç‚¹ cni é»˜è®¤ç›®å½•</span><br>ansible k8s-node -S -R root -m unarchive -a &quot;src=~/kubernetes/network/bin/cni-plugins-linux-amd64-v1.0.1.tgz dest=/opt/cni/bin/ mode=0755 copy=yes&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ†å‘ calico cni ç»„ä»¶</span><br>ansible k8s-node -S -R root -m copy -a &quot;src=~/kubernetes/network/bin/calico dest=/opt/cni/bin/calico owner=root group=root mode=0755&quot;<br>ansible k8s-node -S -R root -m copy -a &quot;src=~/kubernetes/network/bin/calico-ipam dest=/opt/cni/bin/calico-ipam owner=root group=root mode=0755&quot;<br></code></pre></td></tr></table></figure>



<h5 id="4-é•œåƒå‡†å¤‡"><a href="#4-é•œåƒå‡†å¤‡" class="headerlink" title="4. é•œåƒå‡†å¤‡"></a>4. é•œåƒå‡†å¤‡</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> æå‰ä¸‹è½½å¦‚ä¸‹é•œåƒ</span><br>ansible k8s-node -S -R root -m shell -a &quot;docker pull calico/node:v3.19.2&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;docker pull calico/cni:v3.19.2&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;docker pull calico/kube-controllers:v3.19.2&quot;<br>ansible k8s-node -S -R root -m shell -a &quot;docker pull calico/pod2daemon-flexvol:v3.19.2&quot;<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> ä¸Šä¼ è‡³ç§ä»“ï¼ˆå¯é€‰ï¼‰</span><br></code></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="2ï¼‰åˆ›å»º-calico-é…ç½®æ–‡ä»¶"><a href="#2ï¼‰åˆ›å»º-calico-é…ç½®æ–‡ä»¶" class="headerlink" title="2ï¼‰åˆ›å»º calico é…ç½®æ–‡ä»¶"></a>2ï¼‰åˆ›å»º calico é…ç½®æ–‡ä»¶</h4><h5 id="1-è·å–-calico-manifest"><a href="#1-è·å–-calico-manifest" class="headerlink" title="1. è·å– calico manifest"></a>1. è·å– calico manifest</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget -c --no-check-certificate https://docs.projectcalico.org/archive/v3.19/manifests/calico.yaml -O ~/kubernetes/network/cfg/calico.yaml<br></code></pre></td></tr></table></figure>



<h5 id="2-ä¿®æ”¹é•œåƒç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰"><a href="#2-ä¿®æ”¹é•œåƒç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="2. ä¿®æ”¹é•œåƒç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰"></a>2. ä¿®æ”¹é•œåƒç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰</h5><blockquote>
<p>ğŸš© <strong>å…³äºé•œåƒç‰ˆæœ¬</strong></p>
<p>ç”±äºå®˜æ–¹æä¾›çš„ yaml æ–‡ä»¶æ˜¯å®æ—¶æ›´æ–°çš„ï¼Œå…¶å®¹å™¨çš„ç‰ˆæœ¬ä¹Ÿä¼šéšä¹‹æ›´æ–°ã€‚æ•…ï¼Œå¦‚æœè¦ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„ calico çš„è¯ï¼Œå°±éœ€è¦è‡ªè¡Œæ›¿æ¢é•œåƒç‰ˆæœ¬ï¼Œå¦‚æœ¬æ–‡ä½¿ç”¨ v3.19.2ï¼Œè€Œå®˜æ–¹é»˜è®¤æä¾›çš„å¯èƒ½å·²ç»æ˜¯ v3.19.3 äº†ã€‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> è·å–å®˜æ–¹é»˜è®¤æä¾›çš„é•œåƒç‰ˆæœ¬</span><br>DEFAULT_VERSION=$(awk -F &quot;:&quot; &#x27;/image:/&#123;print $NF&#125;&#x27; ~/kubernetes/network/cfg/calico.yaml|head -1)<br><span class="hljs-meta">#</span><span class="bash"> æ›¿æ¢ä¸ºæŒ‡å®šç‰ˆæœ¬</span><br>sed -i &quot;s/$DEFAULT_VERSION/v3.19.2/g&quot; ~/kubernetes/network/cfg/calico.yaml<br></code></pre></td></tr></table></figure>



<h5 id="3-å…³é—­-IPIP-æ¨¡å¼ï¼ˆå¯é€‰ï¼‰"><a href="#3-å…³é—­-IPIP-æ¨¡å¼ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="3. å…³é—­ IPIP æ¨¡å¼ï¼ˆå¯é€‰ï¼‰"></a>3. å…³é—­ IPIP æ¨¡å¼ï¼ˆå¯é€‰ï¼‰</h5><blockquote>
<p>ğŸš© <strong>å…³äº CALICO_IPV4POOL_IPIP å‚æ•°</strong></p>
<p>calico ç½‘ç»œé»˜è®¤ä½¿ç”¨ IPIP æ¨¡å¼ï¼Œå®ƒä¼šåœ¨æ¯ä¸ª node èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª <code>tunl0</code> ç½‘å£ï¼Œé€šè¿‡éš§é“è·¯ç”±çš„æ–¹å¼å°†æ‰€æœ‰çš„nodeèŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿æ˜¯ä¸åŒç½‘æ®µçš„èŠ‚ç‚¹é€šè¿‡è¿™ç§æ–¹å¼ä¹Ÿå¯ä»¥çº³å…¥ç»Ÿä¸€ä¸ª k8s é›†ç¾¤ï¼Œæ‰€ä»¥å®˜æ–¹æ¨èè¿™ç§æƒ…å†µæ—¶ï¼Œä½¿ç”¨è¯¥æ¨¡å¼ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æœ¬æ–‡æ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨åŒä¸€ç½‘æ®µå†…ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å…³é—­ IPIP æ¨¡å¼ã€‚</p>
<p><code>CALICO_IPV4POOL_IPIP</code> æä¾›ä»¥ä¸‹ä¸‰ç§ value:</p>
<ul>
<li><code>Always</code>: å¼€å¯ IPIP æ¨¡å¼(é»˜è®¤)</li>
<li><code>CrossSubnet</code>: åªåœ¨è·¨ç½‘æ®µæ—¶æ‰å¼€å¯ IPIP æ¨¡å¼ï¼Œé€‚åˆæœ‰ Kubernetes èŠ‚ç‚¹åœ¨å…¶ä»–ç½‘æ®µçš„æƒ…å†µï¼Œå±äºä¸­è‚¯å‹å¥½æ–¹æ¡ˆ</li>
<li><code>Never</code>: å…³é—­ IPIP æ¨¡å¼ï¼Œé€‚åˆç¡®è®¤æ‰€æœ‰ Kubernetes èŠ‚ç‚¹éƒ½åœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹çš„æƒ…å†µ</li>
</ul>
</blockquote>
<p>åœ¨ DaemonSet éƒ¨åˆ† <code>calico-node</code>çš„ <code>pod</code> çš„å˜é‡ä¸­ï¼Œä¿®æ”¹ <code>CALICO_IPV4POOL_IPIP</code> å€¼ä¸º <code>Never</code>ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Enable IPIP</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">CALICO_IPV4POOL_IPIP</span><br>	<span class="hljs-attr">value:</span> <span class="hljs-string">&quot;Never&quot;</span><br></code></pre></td></tr></table></figure>



<h5 id="4-ä¿®æ”¹-pod-çš„ç½‘æ®µ"><a href="#4-ä¿®æ”¹-pod-çš„ç½‘æ®µ" class="headerlink" title="4. ä¿®æ”¹ pod çš„ç½‘æ®µ"></a>4. ä¿®æ”¹ pod çš„ç½‘æ®µ</h5><blockquote>
<p>ğŸš© <strong>å…³äº CALICO_IPV4POOL_CIDR å‚æ•°</strong></p>
<p>calico é»˜è®¤ä½¿ç”¨çš„ k8s é›†ç¾¤çš„ pod ç½‘æ®µä¸º <code>192.168.0.0/16</code> ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨çš„ CIDR ä¸åŒäºè¿™ä¸ªæ®µï¼Œæ‰€ä»¥è¦è‡ªè¡Œä¿®æ”¹ï¼Œæ³¨æ„ä¿æŒå’Œ kube-controller-manager ä¸­çš„ <code>--cluster-cidr</code> ä¿æŒä¸€è‡´ã€‚</p>
</blockquote>
<p>åœ¨ DaemonSet éƒ¨åˆ† <code>calico-node</code>çš„ <code>pod</code> çš„å˜é‡ä¸­ï¼Œå¼€å¯ <code>CALICO_IPV4POOL_CIDR</code> ï¼Œä¿®æ”¹æˆé›†ç¾¤ä½¿ç”¨çš„ CIDR ç½‘æ®µã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span><br><span class="hljs-comment"># chosen from this range. Changing this value after installation will have</span><br><span class="hljs-comment"># no effect. This should fall within `--cluster-cidr`.</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">CALICO_IPV4POOL_CIDR</span><br>  <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;10.244.0.0/16&quot;</span><br></code></pre></td></tr></table></figure>



<h5 id="5-ä¿®æ”¹-apiserver-çš„ä¿¡æ¯"><a href="#5-ä¿®æ”¹-apiserver-çš„ä¿¡æ¯" class="headerlink" title="5. ä¿®æ”¹ apiserver çš„ä¿¡æ¯"></a>5. ä¿®æ”¹ apiserver çš„ä¿¡æ¯</h5><blockquote>
<p>ğŸš© <strong>å…³äº calico è®¿é—® apiserver</strong></p>
<p>å¦‚æœæœªé…ç½® apiserver ä¿¡æ¯ã€‚calicoé»˜è®¤å°†è®¾ç½®é»˜è®¤çš„ calico ç½‘æ®µï¼ˆCIDRï¼‰ å’Œ 443ç«¯å£ï¼Œå¦‚ 10.0.0.1:443ã€‚ä¼šå¯¼è‡´ node èŠ‚ç‚¹æ— æ³•è¿æ¥ apiserverï¼ŒæŠ¥é”™ç±»ä¼¼ä»¥ä¸‹æƒ…å†µ:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[ERROR][9] startup/startup.go 159: failed to query kubeadm&#x27;s config map error=Get &quot;https://10.0.0.1:443/api/v1/namespaces/kube-system/configmaps/kubeadm-config?timeout=2s&quot;: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)<br></code></pre></td></tr></table></figure>

<p>ä»¥åŠï¼ˆcalico-kube-controllersï¼‰</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container &quot;2c9d1a481b2ab8328466ba5f7b236bdc822957371579812fa8e7ce3e464dce04&quot; network for pod &quot;calico-kube-controllers-86497987b6-j2fch&quot;: networkPlugin cni failed to set up pod &quot;calico-kube-controllers-86497987b6-j2fch_kube-system&quot; network: error getting ClusterInformation: Get &quot;https://[10.0.0.1]:443/apis/crd.projectcalico.org/v1/clusterinformations/default&quot;: dial tcp 10.0.0.1:443: i/o timeout<br></code></pre></td></tr></table></figure>

<p>apiserver é…ç½®å­—æ®µä¸ºï¼š<code>KUBERNETES_SERVICE_HOST</code>ã€<code>KUBERNETES_SERVICE_PORT</code>ã€<code>KUBERNETES_SERVICE_PORT_HTTPS</code>ã€‚</p>
<p>åˆ†åˆ«åœ¨ DaemonSet éƒ¨åˆ† <code>calico-node</code> çš„ <code>upgrade-ipam</code>, <code>install-cni</code>, <code>calico-node</code> å’Œ Deployment éƒ¨åˆ† <code>calico-kube-controllers</code> çš„ <code>env</code> å˜é‡ä¸­æ·»åŠ  apiserver ä¿¡æ¯ã€‚</p>
</blockquote>
<p>åœ¨ DaemonSet éƒ¨åˆ† <code>calico-node</code> çš„  <code>env</code> å˜é‡å’Œ Deployment éƒ¨åˆ† <code>calico-kube-controllers</code> çš„ <code>env</code> å˜é‡ä¸­å¢åŠ  apiserver çš„ä¿¡æ¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> The kubernetes apiserver info</span><br>- name: KUBERNETES_SERVICE_HOST<br>  value: &quot;192.168.3.231&quot;<br>- name: KUBERNETES_SERVICE_PORT<br>  value: &quot;6443&quot;<br>- name: KUBERNETES_SERVICE_PORT_HTTPS<br>  value: &quot;6443&quot;<br></code></pre></td></tr></table></figure>



<h5 id="6-ä¿®æ”¹-typha-service-nameï¼ˆé›†ç¾¤èŠ‚ç‚¹æ•°è¶…è¿‡50ä»¥ä¸Šå¯é€‰ï¼‰"><a href="#6-ä¿®æ”¹-typha-service-nameï¼ˆé›†ç¾¤èŠ‚ç‚¹æ•°è¶…è¿‡50ä»¥ä¸Šå¯é€‰ï¼‰" class="headerlink" title="6. ä¿®æ”¹ typha_service_nameï¼ˆé›†ç¾¤èŠ‚ç‚¹æ•°è¶…è¿‡50ä»¥ä¸Šå¯é€‰ï¼‰"></a>6. ä¿®æ”¹ typha_service_nameï¼ˆé›†ç¾¤èŠ‚ç‚¹æ•°è¶…è¿‡50ä»¥ä¸Šå¯é€‰ï¼‰</h5><blockquote>
<p>ğŸš© <strong>å…³äº calico-typha</strong></p>
<p>å®˜æ–¹æ¨èå½“k8sæ•°æ®å­˜å‚¨æ¨¡å¼è¶…è¿‡50å„èŠ‚ç‚¹æ—¶å¯ç”¨typhaæ¨¡å¼ï¼ŒTypha ç»„ä»¶å¯ä»¥å¸®åŠ© Calico æ‰©å±•åˆ°å¤§é‡çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸ä¼šå¯¹ Kubernetes API æœåŠ¡å™¨é€ æˆè¿‡åº¦å½±å“ã€‚</p>
<p>å®˜æ–¹æä¾›çš„ manifest åœ°å€: <a target="_blank" rel="noopener" href="https://docs.projectcalico.org/archive/v3.19/manifests/calico-typha.yaml">https://docs.projectcalico.org/archive/v3.19/manifests/calico-typha.yaml</a></p>
</blockquote>
<p>åœ¨ ConfigMap éƒ¨åˆ†çš„ <code>data</code>å˜é‡ä¸­ï¼Œä¿®æ”¹ <code>typha_service_name</code> ä¸º <code>calico-typha</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">calico-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-comment"># Typha is disabled.</span><br>  <span class="hljs-attr">typha_service_name:</span> <span class="hljs-string">&quot;calico-typha&quot;</span><br></code></pre></td></tr></table></figure>



<h4 id="3ï¼‰åˆ›å»º-calico-ç½‘ç»œ"><a href="#3ï¼‰åˆ›å»º-calico-ç½‘ç»œ" class="headerlink" title="3ï¼‰åˆ›å»º calico ç½‘ç»œ"></a>3ï¼‰åˆ›å»º calico ç½‘ç»œ</h4><blockquote>
<p>ğŸš© åˆ›å»ºå‰å…ˆæ¸…ç©º /etc/cni/net.d ç›®å½•ä¸‹çš„ cni ç½‘ç»œé…ç½®ï¼Œå¦‚ <code>10-flannel.conflist</code> ã€<code>10-calico.conflist</code>ã€<code>calico-kubeconfig</code> ã€<code>calico-tls</code> ç­‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible k8s-node -S -R root -m shell -a &quot;\rm -r /etc/cni/net.d/*&quot;<br></code></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f ~/kubernetes/network/cfg/calico.yaml<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell">configmap/calico-config created<br>customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created<br>clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created<br>clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created<br>clusterrole.rbac.authorization.k8s.io/calico-node created<br>clusterrolebinding.rbac.authorization.k8s.io/calico-node created<br>daemonset.apps/calico-node created<br>serviceaccount/calico-node created<br>deployment.apps/calico-kube-controllers created<br>serviceaccount/calico-kube-controllers created<br>poddisruptionbudget.policy/calico-kube-controllers created<br></code></pre></td></tr></table></figure>



<h4 id="4ï¼‰é›†ç¾¤çŠ¶æ€éªŒè¯"><a href="#4ï¼‰é›†ç¾¤çŠ¶æ€éªŒè¯" class="headerlink" title="4ï¼‰é›†ç¾¤çŠ¶æ€éªŒè¯"></a>4ï¼‰é›†ç¾¤çŠ¶æ€éªŒè¯</h4><h5 id="1-æŸ¥çœ‹-pod-çŠ¶æ€"><a href="#1-æŸ¥çœ‹-pod-çŠ¶æ€" class="headerlink" title="1. æŸ¥çœ‹ pod çŠ¶æ€"></a>1. æŸ¥çœ‹ pod çŠ¶æ€</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get pods -n kube-system<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME                                       READY   STATUS    RESTARTS   AGE<br>calico-kube-controllers-5cdd469496-sqqdh   1/1     Running   0          4h<br>calico-node-927gm                          1/1     Running   0          4h<br>calico-node-j5886                          1/1     Running   0          4h<br>calico-node-pbgcb                          1/1     Running   0          4h<br>calico-node-zn4g8                          1/1     Running   0          4h<br></code></pre></td></tr></table></figure>



<h5 id="2-æŸ¥çœ‹-node-çŠ¶æ€"><a href="#2-æŸ¥çœ‹-node-çŠ¶æ€" class="headerlink" title="2. æŸ¥çœ‹ node çŠ¶æ€"></a>2. æŸ¥çœ‹ node çŠ¶æ€</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get nodes -n kube-system<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME           STATUS   ROLES    AGE   VERSION<br>k8s-master01   Ready    &lt;none&gt;   5h   v1.18.18<br>k8s-master02   Ready    &lt;none&gt;   5h   v1.18.18<br>k8s-master03   Ready    &lt;none&gt;   5h   v1.18.18<br>k8s-node01     Ready    &lt;none&gt;   5h   v1.18.18<br></code></pre></td></tr></table></figure>



<h5 id="3-æŸ¥çœ‹è·¯ç”±ï¼ˆBGP-æ¨¡å¼ï¼‰"><a href="#3-æŸ¥çœ‹è·¯ç”±ï¼ˆBGP-æ¨¡å¼ï¼‰" class="headerlink" title="3. æŸ¥çœ‹è·¯ç”±ï¼ˆBGP æ¨¡å¼ï¼‰"></a>3. æŸ¥çœ‹è·¯ç”±ï¼ˆBGP æ¨¡å¼ï¼‰</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ip route<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">default via 192.168.3.1 dev eth0 proto static metric 100 <br>10.244.32.128 dev calie5ddea5eea8 scope link <br>blackhole 10.244.32.128/26 proto bird <br>10.244.122.128/26 via 192.168.3.232 dev eth0 proto bird <br>172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 <br>192.168.3.0/24 dev eth0 proto kernel scope link src 192.168.3.231 metric 100 <br></code></pre></td></tr></table></figure>

<p>ç›¸å…³è·¯ç”±è¯´æ˜:</p>
<blockquote>
<ul>
<li><p><code>10.244.32.128 dev calie5ddea5eea8 scope link</code> : è¯¥è·¯ç”±ä¼šå°†é€šå‘å®¹å™¨IPçš„è¯·æ±‚å¯¼å‘ veth <code>calie5ddea5eea8</code>ï¼Œè¿›è€Œè®©è¯·æ±‚ç›´è¾¾å®¹å™¨å†…çš„ç½‘å¡ã€‚</p>
</li>
<li><p><code>blackhole 10.244.32.128/26 proto bird </code>: è¯¥è·¯ç”±è¡¨ç¤ºå‘å¾€ <code>10.244.32.128/26</code> ç½‘æ®µçš„æŠ¥æ–‡éƒ½ä¼šè¢«ä¸¢å¼ƒä¸”ä¸ä¼šå›å¤æºåœ°å€ï¼Œæ‰€ä»¥æ˜¯ <code>blackhole</code>ã€‚é…ç½®è¿™æ¡è·¯ç”±ä»¥é¿å…æŠ¥æ–‡è¢«å‘é€åˆ°éè¯¥ç½‘æ®µçš„å¤–éƒ¨åœ°å€ã€‚</p>
</li>
<li><p><code>10.244.122.128/26 via 192.168.3.232 dev eth0 proto bird</code>: è¦è®¿é—® calico ç½‘ç»œä¸­çš„æŸä¸ªç½‘æ®µï¼Œéœ€è¦ä»¥ node IPä½œä¸ºç½‘å…³ï¼Œé€šè¿‡ eth0 å‘åŒ…ã€‚</p>
</li>
</ul>
</blockquote>
<h3 id="7ã€éƒ¨ç½²å¿…è¦-Kubernetesé›†ç¾¤æ’ä»¶"><a href="#7ã€éƒ¨ç½²å¿…è¦-Kubernetesé›†ç¾¤æ’ä»¶" class="headerlink" title="7ã€éƒ¨ç½²å¿…è¦ Kubernetesé›†ç¾¤æ’ä»¶"></a>7ã€éƒ¨ç½²å¿…è¦ Kubernetesé›†ç¾¤æ’ä»¶</h3><blockquote>
<p>ğŸŒˆ æ’ä»¶æ˜¯Kubernetesé›†ç¾¤çš„é™„ä»¶ç»„ä»¶ï¼Œä¸°å¯Œå’Œå®Œå–„äº†é›†ç¾¤çš„åŠŸèƒ½ï¼Œè¿™é‡Œåˆ†åˆ«ä»‹ç»çš„æ’ä»¶æœ‰corednsã€Dashboardã€Metrics Serverï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼škuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€æˆ–æå‰åœ¨FQæœåŠ¡å™¨ä¸Šä¸‹è½½ï¼Œç„¶åå†åŒæ­¥åˆ°å¯¹åº”çš„k8séƒ¨ç½²æœºå™¨ä¸Šã€‚</p>
</blockquote>
<h4 id="1ï¼‰éƒ¨ç½²-CoreDNS"><a href="#1ï¼‰éƒ¨ç½²-CoreDNS" class="headerlink" title="1ï¼‰éƒ¨ç½² CoreDNS"></a>1ï¼‰éƒ¨ç½² CoreDNS</h4><p><strong>æ’ä»¶ä»‹ç» â€”â€” CoreDNS:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E6%8F%92%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-CoreDNS/">ä¼ é€é—¨</a></p>
<h5 id="1-è·å–-CoreDNS-manifest"><a href="#1-è·å–-CoreDNS-manifest" class="headerlink" title="1. è·å– CoreDNS manifest"></a>1. è·å– CoreDNS manifest</h5><blockquote>
<p>ğŸš© æˆ‘ä»¬ä¹‹å‰åœ¨éƒ¨ç½² k8s server ç«¯çš„æ—¶å€™ï¼Œå·²ç»è§£å‹äº† <code>kubernetes-server-linux-amd64.tar.gz</code> ï¼Œå…¶ä¸­ä¼šæœ‰ <code>kubernetes-src.tar.gz</code>ï¼Œå…¶ä¸­åŒ…å«çš„æ˜¯ k8s çš„æºç ã€‚è§£å‹åï¼Œcoredns çš„ç›®å½•æ˜¯ <code>cluster/addons/dns</code></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/kubernetes &amp;&amp; \<br>mkdir -p src addons &amp;&amp; \<br>tar xf kubernetes-src.tar.gz -C src &amp;&amp; \<br>cp -a src/cluster/addons/dns/coredns/coredns.yaml.base addons/coredns.yaml<br></code></pre></td></tr></table></figure>



<h5 id="2-ä¿®æ”¹-CoreDNS-manifest"><a href="#2-ä¿®æ”¹-CoreDNS-manifest" class="headerlink" title="2. ä¿®æ”¹ CoreDNS manifest"></a>2. ä¿®æ”¹ CoreDNS manifest</h5><p>æ–‡ä»¶è·¯å¾„ <code>~/kubernetes/addons/coredns.yaml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sed -i -e &quot;s/__PILLAR__DNS__DOMAIN__/cluster.local/&quot; -e &quot;s/__PILLAR__DNS__SERVER__/10.0.0.2/&quot; -e &quot;s/__PILLAR__DNS__MEMORY__LIMIT__/170Mi/&quot; -e &quot;s/k8s.gcr.io/coredns/&quot; ~/kubernetes/addons/coredns.yaml<br></code></pre></td></tr></table></figure>

<h6 id="å‚æ•°è¯´æ˜-2"><a href="#å‚æ•°è¯´æ˜-2" class="headerlink" title="å‚æ•°è¯´æ˜:"></a>å‚æ•°è¯´æ˜:</h6><blockquote>
<ul>
<li><code>__PILLAR__DNS__DOMAIN__</code>: é›†ç¾¤ DNS åŸŸåï¼Œè¿™é‡Œæ›¿æ¢æˆ cluster.localï¼Œå³æ²¿ç”¨æœ¬åœ°è§£æ</li>
<li><code>__PILLAR__DNS__SERVER__</code>ï¼šé›†ç¾¤ DNS æœåŠ¡ IPï¼Œä» SERVICE_CIDR ä¸­é¢„åˆ†é…ä¸€ä¸ª IP å³å¯ï¼ˆæ³¨æ„ä¸è¦ç”¨ CIDR ç¬¬ä¸€ä¸ª IPï¼‰</li>
<li><code>__PILLAR__DNS__MEMORY__LIMIT__</code>: CoreDNS æœåŠ¡å†…å­˜æœ€å¤§é™åˆ¶ï¼Œ<code>requests</code> ä¸º 70Miï¼Œlimit å¤šç»™ 100Mi å³å¯</li>
<li><code>k8s.gcr.io</code>: k8s é»˜è®¤çš„é•œåƒåœ°å€å›½å†…è¢«å¢™çš„ï¼Œä½†æ˜¯åœ¨ docker hub ä¸Šæœ‰å®˜æ–¹æä¾›çš„é•œåƒåœ°å€ï¼Œæ•…å¯ä»¥ä½¿ç”¨ docke hub åœ°å€</li>
</ul>
</blockquote>
<h5 id="3-åˆ›å»º-CoreDNS"><a href="#3-åˆ›å»º-CoreDNS" class="headerlink" title="3. åˆ›å»º CoreDNS"></a>3. åˆ›å»º CoreDNS</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f ~/kubernetes/addons/coredns.yaml <br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">serviceaccount/coredns created<br>clusterrole.rbac.authorization.k8s.io/system:coredns created<br>clusterrolebinding.rbac.authorization.k8s.io/system:coredns created<br>configmap/coredns created<br>deployment.apps/coredns created<br>service/kube-dns created<br></code></pre></td></tr></table></figure>



<h5 id="4-éªŒè¯-CoreDNS-çŠ¶æ€"><a href="#4-éªŒè¯-CoreDNS-çŠ¶æ€" class="headerlink" title="4. éªŒè¯ CoreDNS çŠ¶æ€"></a>4. éªŒè¯ CoreDNS çŠ¶æ€</h5><p>æ£€æŸ¥ coredns åŠŸèƒ½ (æ‰§è¡Œä¸‹é¢å‘½ä»¤åï¼Œç¨å¾®ç­‰ä¸€ä¼šå„¿ï¼Œç¡®ä¿ READY çŠ¶æ€éƒ½æ˜¯å¯ç”¨çš„)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get pod -n kube-system -o wide|grep coredns<br></code></pre></td></tr></table></figure>

<p>è¿”å›ç»“æœå¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">coredns-55f9545c85-dbf67                   1/1     Running   0          44s   10.244.32.128    k8s-master01   &lt;none&gt;           &lt;none&gt;<br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹åˆ›å»ºçš„corednsçš„podçŠ¶æ€,ç¡®ä¿æ²¡æœ‰æŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl describe pod -n kube-system coredns-55f9545c85-dbf67<br></code></pre></td></tr></table></figure>

<p>æ­£ç¡®è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">......<br>......<br>Events:<br>  Type    Reason     Age   From               Message<br>  ----    ------     ----  ----               -------<br>  Normal  Scheduled  2m    default-scheduler  Successfully assigned kube-system/coredns-55f9545c85-dbf67 to k8s-master01<br>  Normal  Pulling    119s  kubelet            Pulling image &quot;coredns/coredns:1.6.5&quot;<br>  Normal  Pulled     92s   kubelet            Successfully pulled image &quot;coredns/coredns:1.6.5&quot;<br>  Normal  Created    92s   kubelet            Created container coredns<br>  Normal  Started    92s   kubelet            Started container coredns<br></code></pre></td></tr></table></figure>



<h5 id="5-éªŒè¯-CoreDNS-åŠŸèƒ½"><a href="#5-éªŒè¯-CoreDNS-åŠŸèƒ½" class="headerlink" title="5. éªŒè¯ CoreDNS åŠŸèƒ½"></a>5. éªŒè¯ CoreDNS åŠŸèƒ½</h5><h6 id="1âƒ£ï¸-åˆ›å»º-nginx-demo-çš„-Deployment-manifest"><a href="#1âƒ£ï¸-åˆ›å»º-nginx-demo-çš„-Deployment-manifest" class="headerlink" title="1âƒ£ï¸ åˆ›å»º nginx-demo çš„ Deployment  manifest"></a>1âƒ£ï¸ åˆ›å»º nginx-demo çš„ Deployment  manifest</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/kubernetes/yaml/nginx-demo.yaml &lt;&lt;EOF<br>apiVersion: v1<br>kind: Deployment<br>metadata:<br>  name: nginx-demo<br>spec:<br>  replicas: 2<br>  selector:<br>    matchLabels:<br>      app: nginx-demo<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx-demo<br>    spec:<br>      containers:<br>      - name: nginx-demo<br>        image: nginx:stable<br>        ports:<br>        - containerPort: 80<br>EOF<br></code></pre></td></tr></table></figure>

<h6 id="2âƒ£ï¸-åˆ›å»ºèµ„æº"><a href="#2âƒ£ï¸-åˆ›å»ºèµ„æº" class="headerlink" title="2âƒ£ï¸ åˆ›å»ºèµ„æº"></a>2âƒ£ï¸ åˆ›å»ºèµ„æº</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f ~/kubernetes/yaml/nginx-demo.yaml<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">deployment.apps/nginx-demo created<br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ pod çŠ¶æ€:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get pod <br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME                          READY   STATUS    RESTARTS   AGE<br>nginx-demo-7fc57f6f87-8sgxm   1/1     Running   0          78s<br>nginx-demo-7fc57f6f87-tzfzh   1/1     Running   0          78s<br></code></pre></td></tr></table></figure>

<h6 id="3âƒ£ï¸-æš´éœ²-nginx-demo"><a href="#3âƒ£ï¸-æš´éœ²-nginx-demo" class="headerlink" title="3âƒ£ï¸ æš´éœ² nginx-demo"></a>3âƒ£ï¸ æš´éœ² nginx-demo</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl expose deployment nginx-demo<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">service/nginx-demo exposed<br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ service çŠ¶æ€:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get svc<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE<br>kubernetes   ClusterIP   10.0.0.1      &lt;none&gt;        443/TCP   2d18h<br>nginx-demo   ClusterIP   10.0.53.182   &lt;none&gt;        80/TCP    3s				#<br></code></pre></td></tr></table></figure>

<h6 id="4âƒ£ï¸-éªŒè¯å†…éƒ¨è§£æåŠŸèƒ½"><a href="#4âƒ£ï¸-éªŒè¯å†…éƒ¨è§£æåŠŸèƒ½" class="headerlink" title="4âƒ£ï¸ éªŒè¯å†…éƒ¨è§£æåŠŸèƒ½"></a>4âƒ£ï¸ éªŒè¯å†…éƒ¨è§£æåŠŸèƒ½</h6><blockquote>
<p>ğŸš© æˆ‘ä»¬çŸ¥é“ k8s å†…éƒ¨é€šè®¯æ˜¯é€šè¿‡ service å‘ä¸‹æ‰¾å¯¹åº” pod çš„ï¼Œæ¯ä¸ª service çš„è§£æåŸç†å®é™…ä¸Šä¹Ÿæ˜¯éµå¾ª dns è§£æåŸç†çš„ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬èƒ½ä»å¦ä¸€ä¸ª pod ä¸­æ­£ç¡®è§£æ nginx-demo çš„ serviceï¼Œåˆ™èƒ½è¯æ˜ coredns å†…éƒ¨è§£æåŠŸèƒ½æ˜¯æ­£å¸¸çš„ã€‚</p>
</blockquote>
<p>å†åˆ›å»ºå¦ä¸€ä¸ª daemonset  <code>dnsutils-demo</code> ç”¨äºè§£ææµ‹è¯•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; ~/kubernetes/yaml/dnsutils-demo.yml &lt;&lt;EOF<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: dnsutils-demo<br>  labels:<br>    app: dnsutils-demo<br>spec:<br>  type: NodePort<br>  selector:<br>    app: dnsutils-demo<br>  ports:<br>  - name: http<br>    port: 80<br>    targetPort: 80<br>---<br>apiVersion: apps/v1<br>kind: DaemonSet<br>metadata:<br>  name: dnsutils-demo<br>  labels:<br>    addonmanager.kubernetes.io/mode: Reconcile<br>spec:<br>	selector:<br>		matchLabels:<br>      app: dnsutils-demo<br>  template:<br>    metadata:<br>      labels:<br>        app: dnsutils-demo<br>    spec:<br>      containers:<br>      - name: dnsutils-demo<br>        image: tutum/dnsutils:latest<br>        command:<br>          - sleep<br>          - &quot;3600&quot;<br>        ports:<br>        - containerPort: 80<br>EOF<br></code></pre></td></tr></table></figure>

<p>åˆ›å»ºèµ„æº:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f ~/kubernetes/yaml/dnsutils-demo.yml<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">service/dnsutils-demo unchanged<br>daemonset.apps/dnsutils-demo created<br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ pod ä¿¡æ¯:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get pod -o wide<br></code></pre></td></tr></table></figure>

<p>è¿”å›å¦‚ä¸‹, åœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ½ç”Ÿæˆäº† dnsutils-demo çš„ pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME                          READY   STATUS    RESTARTS   AGE    IP               NODE           NOMINATED NODE   READINESS GATES<br>dnsutils-demo-9nbzt           1/1     Running   0          3m8s   10.244.32.129    k8s-master01   &lt;none&gt;           &lt;none&gt;<br>dnsutils-demo-fqcnf           1/1     Running   0          3m8s   10.244.195.1     k8s-master03   &lt;none&gt;           &lt;none&gt;<br>dnsutils-demo-jgkll           1/1     Running   0          3m8s   10.244.85.193    k8s-node01     &lt;none&gt;           &lt;none&gt;<br>dnsutils-demo-n7j9r           1/1     Running   0          3m8s   10.244.122.130   k8s-master02   &lt;none&gt;           &lt;none&gt;<br>nginx-demo-7fc57f6f87-8sgxm   1/1     Running   0          145m   10.244.85.192    k8s-node01     &lt;none&gt;           &lt;none&gt;<br>nginx-demo-7fc57f6f87-tzfzh   1/1     Running   0          145m   10.244.195.0     k8s-master03   &lt;none&gt;           &lt;none&gt;<br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ service ä¿¡æ¯:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get sv<br></code></pre></td></tr></table></figure>

<p>è¿”å›å¦‚ä¸‹ï¼Œå¤šäº† dnsutils-demo çš„ svc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE<br>dnsutils-demo   NodePort    10.0.243.227   &lt;none&gt;        80:36461/TCP   4m21s<br>kubernetes      ClusterIP   10.0.0.1       &lt;none&gt;        443/TCP        2d20h<br>nginx-demo      ClusterIP   10.0.53.182    &lt;none&gt;        80/TCP         139m<br></code></pre></td></tr></table></figure>

<p>ä¾æ¬¡é€šè¿‡ dnsutils-demo çš„ pod ä¸­è§£æ nginx-demo çš„ svcï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥è§£æå¾—åˆ°å¯¹åº”çš„ clusterIP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for i in $(kubectl get pod|awk &#x27;/dnsutils/&#123;print $1&#125;&#x27;|xargs);do kubectl exec $i nslookup nginx-demo;done<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›ç»“æœå¦‚ä¸‹ï¼Œè¯æ˜å¯ä»¥é€šè¿‡ CoreDNS è§£æ service è·å–åˆ°æ­£ç¡®çš„ ClusterIPã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell">Server:		10.0.0.2<br>Address:	10.0.0.2#53<br><br>Name:	nginx-demo.default.svc.cluster.local<br>Address: 10.0.53.182<br><br>Server:		10.0.0.2<br>Address:	10.0.0.2#53<br><br>Name:	nginx-demo.default.svc.cluster.local<br>Address: 10.0.53.182<br><br>Server:		10.0.0.2<br>Address:	10.0.0.2#53<br><br>Name:	nginx-demo.default.svc.cluster.local<br>Address: 10.0.53.182<br><br>Server:		10.0.0.2<br>Address:	10.0.0.2#53<br><br>Name:	nginx-demo.default.svc.cluster.local<br>Address: 10.0.53.182<br><br></code></pre></td></tr></table></figure>

<h6 id="5âƒ£ï¸-éªŒè¯å¤–éƒ¨è§£æåŠŸèƒ½"><a href="#5âƒ£ï¸-éªŒè¯å¤–éƒ¨è§£æåŠŸèƒ½" class="headerlink" title="5âƒ£ï¸ éªŒè¯å¤–éƒ¨è§£æåŠŸèƒ½"></a>5âƒ£ï¸ éªŒè¯å¤–éƒ¨è§£æåŠŸèƒ½</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl exec -it  nginx-demo-7fc57f6f87-8sgxm /bin/bash<br></code></pre></td></tr></table></figure>

<p>è¿›å…¥podåæŸ¥çœ‹ <code>/etc/resolv.conf</code>ã€‚ç¡®ä¿ pod å®¹å™¨ä¸­<code>/etc/resolv.conf</code> é‡Œçš„ nameserver åœ°å€ä¸º kubelet é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„ clusterDNS ä»¥åŠ clusterDomainã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@nginx-demo-7fc57f6f87-8sgxm:/# cat /etc/resolv.conf <br>nameserver 10.0.0.2<br>search default.svc.cluster.local svc.cluster.local cluster.local<br>options ndots:5<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ğŸš© å®˜æ–¹æä¾›çš„ CoreDNS manifest ä¸­ DNS ç›¸å…³ configmap ä¸­ <code>forward . /etc/resolv.conf</code> çš„é…ç½®è¡¨ç¤º CoreDNS ä¼šç»§æ‰¿å®¿ä¸»æœºæœ¬åœ° <code>/etc/resolv.conf</code> ä¸­çš„ nameserverï¼Œå› æ­¤å¦‚æœ CoreDNS å¦‚æœåŠŸèƒ½æ­£å¸¸çš„è¯ï¼Œæˆ‘ä»¬åœ¨ pod å†…å³å¯è¿›è¡Œæ­£å¸¸çš„ dns è§£æå…¬ç½‘åŸŸåï¼Œå¦‚ <code>www.baidu.com</code> ç­‰ã€‚</p>
</blockquote>
<p>åœ¨ pod å†…å®‰è£… pingï¼Œnginx é»˜è®¤æä¾›çš„é•œåƒ OS ä¸º Debianï¼Œä½¿ç”¨ apt è¿›è¡ŒåŒ…ç®¡ç†ï¼Œè‡ªè¡Œå®‰è£… ping å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt-get update<br>apt-get install inetutils-ping<br></code></pre></td></tr></table></figure>

<p>å®‰è£…å®Œæˆåï¼Œping baiduï¼ŒéªŒè¯è§£æ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ping -c4 www.baidu.com<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹ï¼Œè¯´æ˜å¤–éƒ¨ dns è§£æåŠŸèƒ½æ­£å¸¸:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">PING www.a.shifen.com (180.101.49.12): 56 data bytes<br>64 bytes from 180.101.49.12: icmp_seq=0 ttl=47 time=8.186 ms<br>64 bytes from 180.101.49.12: icmp_seq=1 ttl=47 time=8.048 ms<br>64 bytes from 180.101.49.12: icmp_seq=2 ttl=47 time=7.854 ms<br>64 bytes from 180.101.49.12: icmp_seq=3 ttl=47 time=7.688 ms<br>--- www.a.shifen.com ping statistics ---<br>4 packets transmitted, 4 packets received, 0% packet loss<br>round-trip min/avg/max/stddev = 7.688/7.944/8.186/0.189 ms<br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥é€šè¿‡ dnsutils è¿›è¡Œè§£ææŸ¥è¯¢</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl exec dnsutils-demo-9nbzt nslookup www.baidu.com<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹ï¼Œå¯ä»¥é€šè¿‡ CoreDNS è§£æåˆ°å¤–éƒ¨åŸŸå:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">Server:		10.0.0.2<br>Address:	10.0.0.2#53<br><br>Non-authoritative answer:<br>www.baidu.com	canonical name = www.a.shifen.com.<br>Name:	www.a.shifen.com<br>Address: 180.101.49.12<br>Name:	www.a.shifen.com<br>Address: 180.101.49.11<br></code></pre></td></tr></table></figure>





<h4 id="2ï¼‰éƒ¨ç½²-dashboard"><a href="#2ï¼‰éƒ¨ç½²-dashboard" class="headerlink" title="2ï¼‰éƒ¨ç½² dashboard"></a>2ï¼‰éƒ¨ç½² dashboard</h4><p><strong>æ’ä»¶ä»‹ç» â€”â€” Dashboard:</strong> <a href="https://tareya.github.io/2021/10/21/Kubernetes-%E6%8F%92%E4%BB%B6%E4%BB%8B%E7%BB%8D-%E2%80%94%E2%80%94-Dashboard/">ä¼ é€ä»¬</a></p>
<h5 id="1-è·å–-Dashboard-manifest"><a href="#1-è·å–-Dashboard-manifest" class="headerlink" title="1. è·å– Dashboard manifest"></a>1. è·å– Dashboard manifest</h5><blockquote>
<p>ğŸš© æˆ‘ä»¬ä¹‹å‰åœ¨éƒ¨ç½² coredns çš„æ—¶å€™ï¼Œå·²ç»è§£å‹äº† <code>kubernetes-src.tar.gz</code>ï¼Œdashboard çš„ç›®å½•æ˜¯ <code>cluster/addons/dashboard</code></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p ~/kubernetes/addons/dashboard &amp;&amp; \<br>wget -c https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml -O  ~/kubernetes/addons/dashboard/recommended.yaml<br></code></pre></td></tr></table></figure>



<h5 id="2-ä¿®æ”¹-Dashboard-manifest"><a href="#2-ä¿®æ”¹-Dashboard-manifest" class="headerlink" title="2. ä¿®æ”¹ Dashboard manifest"></a>2. ä¿®æ”¹ Dashboard manifest</h5><p>æ–‡ä»¶è·¯å¾„ <code>~/kubernetes/addons/dashboard/recommended.yaml </code>ï¼Œä¿®æ”¹æ–‡ä»¶ï¼Œå°† service ç±»å‹æ”¹ä¸º NodePortï¼Œè¿™æ ·å°±å¤–éƒ¨å¯ä»¥ç›´æ¥é€šè¿‡è®¿é—® NodeIP:NodePort è®¿é—® Dashboardã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span>					<span class="hljs-comment"># æ–°å¢</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8443</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30443</span>			<span class="hljs-comment"># æ–°å¢</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure>



<h5 id="3-åˆ›å»º-Dashboard"><a href="#3-åˆ›å»º-Dashboard" class="headerlink" title="3. åˆ›å»º Dashboard"></a>3. åˆ›å»º Dashboard</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/kubernetes/addons/dashboard/ &amp;&amp; \<br>kubectl apply -f .<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">namespace/kubernetes-dashboard created<br>serviceaccount/kubernetes-dashboard created<br>service/kubernetes-dashboard created<br>secret/kubernetes-dashboard-certs created<br>secret/kubernetes-dashboard-csrf created<br>secret/kubernetes-dashboard-key-holder created<br>configmap/kubernetes-dashboard-settings created<br>role.rbac.authorization.k8s.io/kubernetes-dashboard created<br>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created<br>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created<br>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created<br>deployment.apps/kubernetes-dashboard created<br>service/dashboard-metrics-scraper created<br>deployment.apps/dashboard-metrics-scraper created<br></code></pre></td></tr></table></figure>



<h5 id="4-éªŒè¯-Dashboard-çŠ¶æ€"><a href="#4-éªŒè¯-Dashboard-çŠ¶æ€" class="headerlink" title="4. éªŒè¯ Dashboard çŠ¶æ€"></a>4. éªŒè¯ Dashboard çŠ¶æ€</h5><p>è·å– dashboard pod ä¿¡æ¯ (æ‰§è¡Œä¸‹é¢å‘½ä»¤åï¼Œç¨å¾®ç­‰ä¸€ä¼šå„¿ï¼Œç¡®ä¿ READY çŠ¶æ€éƒ½æ˜¯å¯ç”¨çš„)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get pod -A -o wide|grep dashboard<br></code></pre></td></tr></table></figure>

<p>è¿”å›ç»“æœå¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubernetes-dashboard   dashboard-metrics-scraper-6b4884c9d5-kzrdw   1/1     Running   0          81s     10.244.195.4     k8s-master03   &lt;none&gt;           &lt;none&gt;<br>kubernetes-dashboard   kubernetes-dashboard-7b544877d5-ngbts        1/1     Running   0          81s     10.244.85.197    k8s-node01     &lt;none&gt;           &lt;none&gt;<br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹åˆ›å»ºçš„ dashboard çš„ pod çŠ¶æ€ï¼Œç¡®ä¿æ²¡æœ‰æŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl describe pod -n kubernetes-dashboard kubernetes-dashboard-7b544877d5-ngbts<br></code></pre></td></tr></table></figure>

<p>æ­£ç¡®è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">......<br>......<br>Events:<br>  Type    Reason     Age   From               Message<br>  ----    ------     ----  ----               -------<br>  Normal  Scheduled  118s  default-scheduler  Successfully assigned kubernetes-dashboard/kubernetes-dashboard-7b544877d5-ngbts to k8s-node01<br>  Normal  Pulling    118s  kubelet            Pulling image &quot;kubernetesui/dashboard:v2.0.0&quot;<br>  Normal  Pulled     102s  kubelet            Successfully pulled image &quot;kubernetesui/dashboard:v2.0.0&quot;<br>  Normal  Created    102s  kubelet            Created container kubernetes-dashboard<br>  Normal  Started    102s  kubelet            Started container kubernetes-dashboard<br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹åˆ†é…çš„ NodePort </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get svc -n kubernetes-dashboard<br></code></pre></td></tr></table></figure>

<p>æ­£å¸¸è¿”å›å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">NAME                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE<br>dashboard-metrics-scraper   ClusterIP   10.0.251.223   &lt;none&gt;        8000/TCP        2m38s<br>kubernetes-dashboard        NodePort    10.0.73.122    &lt;none&gt;        443:30443/TCP   2m38s<br></code></pre></td></tr></table></figure>



<h5 id="5-é€šè¿‡-kube-apiserver-å¤–éƒ¨è®¿é—®-dashboard"><a href="#5-é€šè¿‡-kube-apiserver-å¤–éƒ¨è®¿é—®-dashboard" class="headerlink" title="5. é€šè¿‡ kube-apiserver å¤–éƒ¨è®¿é—® dashboard"></a>5. é€šè¿‡ kube-apiserver å¤–éƒ¨è®¿é—® dashboard</h5><h6 id="1âƒ£ï¸-å¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦"><a href="#1âƒ£ï¸-å¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦" class="headerlink" title="1âƒ£ï¸ å¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦"></a>1âƒ£ï¸ å¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦</h6><blockquote>
<p>âš ï¸  <strong>æ³¨æ„</strong></p>
<p>éœ€è¦æ³¨æ„ï¼Œå¤–éƒ¨è®¿é—®å¿…é¡»é€šè¿‡ kube-apiserver çš„å®‰å…¨ç«¯å£(https)è®¿é—® dashbaordï¼Œè®¿é—®æ—¶æµè§ˆå™¨éœ€è¦è¿›è¡Œè®¤è¯ï¼Œå¦åˆ™ä¼šè¢« kube-apiserver æ‹’ç»è®¿é—®ã€‚æŠ¥é”™å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">services &quot;https:kubernetes-dashboard:&quot; is forbidden: User &quot;system:anonymous&quot; cannot get resource &quot;services/proxy&quot; in API group &quot;&quot; in the namespace &quot;kube-system&quot;<br></code></pre></td></tr></table></figure>

<p><strong>Mac OSç³»ç»Ÿå®¢æˆ·æœºä¸Šå¯¼å…¥è¯ä¹¦çš„æ–¹æ³•:</strong></p>
<p>1ï¼‰åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦</p>
<p>éœ€è¦ä½¿ç”¨æˆ‘ä»¬ä¸€å¼€å§‹ç”Ÿæˆçš„ç”Ÿæˆçš„ admin è¯ä¹¦å¯¹ï¼Œåˆ›å»ºçš„å®¢æˆ·ç«¯è¯ä¹¦ä¸º Chrome æˆ– Firefox è¯†åˆ«çš„ p12 æ ¼å¼</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl pkcs12 -export  -out kube-admin.pfx -name &quot;kubernetes-client&quot; -inkey /data/applications/kubernetes/ssl/admin-key.pem -in /data/applications/kubernetes/ssl/admin.pem -certfile /data/applications/kubernetes/ssl/ca.pem<br></code></pre></td></tr></table></figure>

<p>è¿”å›äº¤äº’å‘½ä»¤:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">Enter Export Password:                      # è¿™é‡Œè¾“å…¥è‡ªå·±è®¾å®šçš„ä»»æ„å¯†ç ï¼Œæ¯”å¦‚&quot;123456&quot;<br>Verifying - Enter Export Password:          # ç¡®è®¤å¯†ç : 123456<br></code></pre></td></tr></table></figure>

<p>2ï¼‰æœ¬åœ°å¯¼å…¥è¯ä¹¦</p>
<p>å°†ç”Ÿæˆçš„å®¢æˆ·ç«¯è¯ä¹¦æ‹·è´åˆ°æœ¬åœ°ï¼Œåœ¨ â€œé’¥åŒ™ä¸²è®¿é—®â€ =&gt; â€œç³»ç»Ÿâ€ =&gt; â€œæ·»åŠ é’¥åŒ™ä¸²â€ï¼Œå¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆå¯¼å…¥æ—¶ä¼šæç¤ºè¾“å…¥è¯ä¹¦å¯†ç ï¼Œå³ â€œ123456â€ï¼‰ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20211012171934292.png" srcset="/img/loading.gif" lazyload alt="image-20211012171934292"></p>
<p>3ï¼‰è®¾ç½® kubernetes ï¼ˆå³ apiserverçš„ï¼‰tls è¯ä¹¦æ°¸ä¹…ä¿¡ä»»</p>
<p>ç‚¹å‡»Macæœ¬ä¸Šçš„â€<strong>é’¥åŒ™ä¸²è®¿é—®</strong>â€œ -&gt; â€œ<strong>ç³»ç»Ÿ</strong>â€œ -&gt; â€œ<strong>è¯ä¹¦</strong>â€œ -&gt; â€œ<strong>kebernetes</strong>â€œ(åŒå‡»é‡Œé¢çš„â€<strong>ä¿¡ä»»</strong>â€œï¼Œæ”¹æˆâ€<strong>å§‹ç»ˆä¿¡ä»»</strong>â€œ),å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20211012171426530.png" srcset="/img/loading.gif" lazyload alt="image-20211012171426530"></p>
<p>æ¸…é™¤æµè§ˆå™¨å†å²è®°å½•ï¼Œä¸€å®šè¦é‡å¯æµè§ˆå™¨ï¼Œæ¥ç€è®¿é—® apiserveråœ°å€ï¼Œæ¥ç€ä¼šæç¤ºé€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨è¯ä¹¦ï¼Œä¼šæç¤ºè¯ä¹¦è®¤è¯, ç„¶åå†æ¬¡è®¿é—® apiserverï¼Œå‘ç°ç›¸åº”çš„ metrics æ•°æ®å°±æˆåŠŸæ˜¾ç¤ºå‡ºæ¥äº†ï¼ï¼(æ³¨æ„ï¼Œå¦‚æœå¤±è´¥äº†ã€‚åˆ™å¯ä»¥åˆ é™¤è¯ä¹¦ï¼Œç„¶åé‡æ–°ç”Ÿæˆï¼Œé‡æ–°å¯¼å…¥å†è·Ÿç€æ“ä½œæ­¥éª¤æ¥ä¸€éï¼Œæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œé‡å¯æµè§ˆå™¨ï¼Œé€‰æ‹©å¯¼å…¥çš„è¯ä¹¦ï¼Œå†æ¬¡è®¿é—®å³å¯ï¼ï¼‰</p>
<p>è®¿é—® <a target="_blank" rel="noopener" href="https://192.168.3.231:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login%EF%BC%8C%E4%BC%9A%E6%9C%89%E5%A6%82%E4%B8%8B%E8%AE%A4%E8%AF%81%E6%8F%90%E7%A4%BA">https://192.168.3.231:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/loginï¼Œä¼šæœ‰å¦‚ä¸‹è®¤è¯æç¤º</a></p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20211012172918878.png" srcset="/img/loading.gif" lazyload alt="image-20211012172918878"></p>
<p>é€‰æ‹©è¯ä¹¦åï¼Œå³è·³è½¬åˆ° dashboard çš„è®¤è¯é¡µé¢</p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20211012182139093.png" srcset="/img/loading.gif" lazyload alt="image-20211012182139093"></p>
</blockquote>
<h6 id="2âƒ£ï¸-åˆ›å»ºç™»å½•-Dashboard-çš„-token"><a href="#2âƒ£ï¸-åˆ›å»ºç™»å½•-Dashboard-çš„-token" class="headerlink" title="2âƒ£ï¸ åˆ›å»ºç™»å½• Dashboard çš„ token"></a>2âƒ£ï¸ åˆ›å»ºç™»å½• Dashboard çš„ token</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åˆ›å»º service account</span><br>kubectl create sa dashboard-admin -n kube-system<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> åˆ›å»º clusterrolebinding</span> <br>kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> è·å– token</span><br>ADMIN_SECRET=$(kubectl get secrets -n kube-system | grep dashboard-admin | awk &#x27;&#123;print $1&#125;&#x27;)<br>DASHBOARD_LOGIN_TOKEN=$(kubectl describe secret -n kube-system $ADMIN_SECRET| grep -E &#x27;^token&#x27; | awk &#x27;&#123;print $2&#125;&#x27;)<br>echo $DASHBOARD_LOGIN_TOKEN<br></code></pre></td></tr></table></figure>



<h6 id="3âƒ£ï¸-åˆ›å»ºç™»å½•-Dashboard-çš„-kubeconfig-é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰"><a href="#3âƒ£ï¸-åˆ›å»ºç™»å½•-Dashboard-çš„-kubeconfig-é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰" class="headerlink" title="3âƒ£ï¸ åˆ›å»ºç™»å½• Dashboard çš„ kubeconfig é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰"></a>3âƒ£ï¸ åˆ›å»ºç™»å½• Dashboard çš„ kubeconfig é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰</h6><p>dashboard é»˜è®¤åªæ”¯æŒ token è®¤è¯ï¼ˆä¸æ”¯æŒ client è¯ä¹¦è®¤è¯ï¼‰ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ Kubeconfig æ–‡ä»¶ï¼Œéœ€è¦å°† token å†™å…¥åˆ°è¯¥æ–‡ä»¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®é›†ç¾¤å‚æ•°</span><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/data/applications/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=https://192.168.3.231:6443 \<br>  --kubeconfig=dashboard.kubeconfig<br><span class="hljs-meta">  </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ Token</span><br>kubectl config set-credentials dashboard_user \<br>  --token=$&#123;DASHBOARD_LOGIN_TOKEN&#125; \<br>  --kubeconfig=dashboard.kubeconfig<br><span class="hljs-meta">  </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span><br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=dashboard_user \<br>  --kubeconfig=dashboard.kubeconfig<br><span class="hljs-meta">  </span><br><span class="hljs-meta">#</span><span class="bash"> è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span><br>kubectl config use-context default --kubeconfig=dashboard.kubeconfig<br></code></pre></td></tr></table></figure>

<p>å°†ä¸Šé¢ç”Ÿæˆçš„ dashboard.kubeconfig æ–‡ä»¶æ‹·è´åˆ°æœ¬åœ°ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ç™»å½• Dashboard å³å¯ï¼Œè®¿é—®ç»“æœå¦‚ä¸‹å›¾:</p>
<p><img src="https://blog-images.tareya.cn/blog_images/image-20211012182619869.png" srcset="/img/loading.gif" lazyload alt="image-20211012182619869"></p>
<blockquote>
<p>ğŸš© <strong>è¿™é‡Œç”±äºç¼ºå°‘Heapsteræˆ–metrics-serveræ’ä»¶ï¼Œå½“å‰dashboardè¿˜ä¸èƒ½å±•ç¤º Podã€Nodes çš„ CPUã€å†…å­˜ç­‰ç»Ÿè®¡æ•°æ®å’Œå›¾è¡¨ã€‚</strong></p>
</blockquote>
<h4 id="3ï¼‰éƒ¨ç½²-metrics-server"><a href="#3ï¼‰éƒ¨ç½²-metrics-server" class="headerlink" title="3ï¼‰éƒ¨ç½² metrics-server"></a>3ï¼‰éƒ¨ç½² metrics-server</h4><h4 id="4ï¼‰éƒ¨ç½²-kube-state-metrics"><a href="#4ï¼‰éƒ¨ç½²-kube-state-metrics" class="headerlink" title="4ï¼‰éƒ¨ç½² kube-state-metrics"></a>4ï¼‰éƒ¨ç½² kube-state-metrics</h4><h4 id="5ï¼‰éƒ¨ç½²-prometheus"><a href="#5ï¼‰éƒ¨ç½²-prometheus" class="headerlink" title="5ï¼‰éƒ¨ç½² prometheus"></a>5ï¼‰éƒ¨ç½² prometheus</h4>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Kubernetes/">Kubernetes</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Kubernetes-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%89%8B%E5%86%8C/">Kubernetes å¿«é€Ÿå…¥é—¨æ‰‹å†Œ</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/09/27/Kubernetes-kmem-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Kubernetes kmem å†…å­˜æ³„æ¼é—®é¢˜è§£å†³æ–¹æ¡ˆ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/09/21/%E7%AC%AC12%E7%AB%A0%E3%80%81%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86/">
                        <span class="hidden-mobile">ç¬¬12ç« ã€é¡¹ç›®ç®¡ç†é«˜çº§çŸ¥è¯†</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
